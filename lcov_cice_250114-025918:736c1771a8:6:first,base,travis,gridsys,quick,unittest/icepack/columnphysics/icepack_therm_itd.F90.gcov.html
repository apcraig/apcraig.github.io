<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - 250114-025918:736c1771a8:6:first,base,travis,gridsys,quick,unittest - icepack/columnphysics/icepack_therm_itd.F90</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="title">LCOV - code coverage report</td></tr>
            <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

            <tr>
              <td width="100%">
                <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="10%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">icepack/columnphysics</a> - icepack_therm_itd.F90<span style="font-size: 80%;"> (source / <a href="icepack_therm_itd.F90.func-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="5%"></td>
            <td width="5%" class="headerCovTableHead">Coverage</td>
            <td width="5%" class="headerCovTableHead" title="Covered + Uncovered code">Total</td>
            <td width="5%" class="headerCovTableHead" title="Exercised code only">Hit</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">250114-025918:736c1771a8:6:first,base,travis,gridsys,quick,unittest</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntryMed">89.11&nbsp;%</td>
            <td class="headerCovTableEntry">836</td>
            <td class="headerCovTableEntry">745</td>
          </tr>
          <tr>
            <td class="headerItem">Test Date:</td>
            <td class="headerValue">2025-01-14 04:35:23</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntryHi">100.00&nbsp;%</td>
            <td class="headerCovTableEntry">6</td>
            <td class="headerCovTableEntry">6</td>
          </tr>
                  <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
                </table>
              </td>
            </tr>

            <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
          </table>

          <table cellpadding=0 cellspacing=0 border=0>
            <tr>
              <td><br></td>
            </tr>
            <tr>
              <td>
<pre class="sourceHeading">            Line data    Source code</pre>
<pre class="source">
<span id="L1"><span class="lineNum">       1</span>              : !=======================================================================</span>
<span id="L2"><span class="lineNum">       2</span>              : !</span>
<span id="L3"><span class="lineNum">       3</span>              : ! Thermo calculations after call to coupler, related to ITD:</span>
<span id="L4"><span class="lineNum">       4</span>              : ! ice thickness redistribution, lateral growth and melting.</span>
<span id="L5"><span class="lineNum">       5</span>              : !</span>
<span id="L6"><span class="lineNum">       6</span>              : ! NOTE: The thermodynamic calculation is split in two for load balancing.</span>
<span id="L7"><span class="lineNum">       7</span>              : !       First icepack_therm_vertical computes vertical growth rates and coupler</span>
<span id="L8"><span class="lineNum">       8</span>              : !       fluxes.  Then icepack_therm_itd does thermodynamic calculations not</span>
<span id="L9"><span class="lineNum">       9</span>              : !       needed for coupling.</span>
<span id="L10"><span class="lineNum">      10</span>              : !</span>
<span id="L11"><span class="lineNum">      11</span>              : ! authors William H. Lipscomb, LANL</span>
<span id="L12"><span class="lineNum">      12</span>              : !         C. M. Bitz, UW</span>
<span id="L13"><span class="lineNum">      13</span>              : !         Elizabeth C. Hunke, LANL</span>
<span id="L14"><span class="lineNum">      14</span>              : !</span>
<span id="L15"><span class="lineNum">      15</span>              : ! 2003: Vectorized by Clifford Chen (Fujitsu) and William Lipscomb</span>
<span id="L16"><span class="lineNum">      16</span>              : ! 2004: Block structure added by William Lipscomb</span>
<span id="L17"><span class="lineNum">      17</span>              : ! 2006: Streamlined for efficiency by Elizabeth Hunke</span>
<span id="L18"><span class="lineNum">      18</span>              : ! 2014: Column package created by Elizabeth Hunke</span>
<span id="L19"><span class="lineNum">      19</span>              : !</span>
<span id="L20"><span class="lineNum">      20</span>              :       module icepack_therm_itd</span>
<span id="L21"><span class="lineNum">      21</span>              : </span>
<span id="L22"><span class="lineNum">      22</span>              :       use icepack_kinds</span>
<span id="L23"><span class="lineNum">      23</span>              : </span>
<span id="L24"><span class="lineNum">      24</span>              :       use icepack_fsd, only: floe_rad_c, floe_binwidth</span>
<span id="L25"><span class="lineNum">      25</span>              : </span>
<span id="L26"><span class="lineNum">      26</span>              :       use icepack_parameters, only: c0, c1, c2, c3, c4, c6, c10</span>
<span id="L27"><span class="lineNum">      27</span>              :       use icepack_parameters, only: p001, p1, p333, p5, p666, puny, bignum</span>
<span id="L28"><span class="lineNum">      28</span>              :       use icepack_parameters, only: rhos, rhoi, Lfresh, ice_ref_salinity</span>
<span id="L29"><span class="lineNum">      29</span>              :       use icepack_parameters, only: phi_init, dsin0_frazil, salt_loss</span>
<span id="L30"><span class="lineNum">      30</span>              :       use icepack_parameters, only: Tliquidus_max</span>
<span id="L31"><span class="lineNum">      31</span>              :       use icepack_parameters, only: rhosi, conserv_check, rhosmin, snwredist</span>
<span id="L32"><span class="lineNum">      32</span>              :       use icepack_parameters, only: kitd, ktherm</span>
<span id="L33"><span class="lineNum">      33</span>              :       use icepack_parameters, only: z_tracers, hfrazilmin, hi_min</span>
<span id="L34"><span class="lineNum">      34</span>              :       use icepack_parameters, only: cpl_frazil, update_ocn_f, saltflux_option</span>
<span id="L35"><span class="lineNum">      35</span>              :       use icepack_parameters, only: icepack_chkoptargflag</span>
<span id="L36"><span class="lineNum">      36</span>              : </span>
<span id="L37"><span class="lineNum">      37</span>              :       use icepack_tracers, only: ncat, nilyr, nslyr, nblyr, ntrcr, nbtrcr, nfsd</span>
<span id="L38"><span class="lineNum">      38</span>              :       use icepack_tracers, only: nt_qice, nt_qsno, nt_fbri, nt_sice</span>
<span id="L39"><span class="lineNum">      39</span>              :       use icepack_tracers, only: nt_apnd, nt_hpnd, nt_aero, nt_isosno, nt_isoice</span>
<span id="L40"><span class="lineNum">      40</span>              :       use icepack_tracers, only: nt_Tsfc, nt_iage, nt_FY, nt_fsd, nt_rhos, nt_sice</span>
<span id="L41"><span class="lineNum">      41</span>              :       use icepack_tracers, only: nt_alvl, nt_vlvl</span>
<span id="L42"><span class="lineNum">      42</span>              :       use icepack_tracers, only: tr_pond_lvl, tr_pond_topo</span>
<span id="L43"><span class="lineNum">      43</span>              :       use icepack_tracers, only: tr_iage, tr_FY, tr_lvl, tr_aero, tr_iso, tr_brine, tr_fsd</span>
<span id="L44"><span class="lineNum">      44</span>              :       use icepack_tracers, only: n_aero, n_iso</span>
<span id="L45"><span class="lineNum">      45</span>              :       use icepack_tracers, only: bio_index</span>
<span id="L46"><span class="lineNum">      46</span>              : </span>
<span id="L47"><span class="lineNum">      47</span>              :       use icepack_warnings, only: warnstr, icepack_warnings_add</span>
<span id="L48"><span class="lineNum">      48</span>              :       use icepack_warnings, only: icepack_warnings_setabort, icepack_warnings_aborted</span>
<span id="L49"><span class="lineNum">      49</span>              : </span>
<span id="L50"><span class="lineNum">      50</span>              :       use icepack_fsd, only: fsd_weld_thermo, icepack_cleanup_fsd,  get_subdt_fsd</span>
<span id="L51"><span class="lineNum">      51</span>              :       use icepack_itd, only: reduce_area, cleanup_itd</span>
<span id="L52"><span class="lineNum">      52</span>              :       use icepack_itd, only: aggregate_area, shift_ice</span>
<span id="L53"><span class="lineNum">      53</span>              :       use icepack_itd, only: column_sum, column_conservation_check</span>
<span id="L54"><span class="lineNum">      54</span>              :       use icepack_isotope, only: isoice_alpha, isotope_frac_method</span>
<span id="L55"><span class="lineNum">      55</span>              :       use icepack_mushy_physics, only: liquidus_temperature_mush, icepack_enthalpy_mush</span>
<span id="L56"><span class="lineNum">      56</span>              :       use icepack_zbgc, only: add_new_ice_bgc</span>
<span id="L57"><span class="lineNum">      57</span>              :       use icepack_zbgc, only: lateral_melt_bgc</span>
<span id="L58"><span class="lineNum">      58</span>              :       use icepack_zbgc_shared, only: bgrid, cgrid, igrid</span>
<span id="L59"><span class="lineNum">      59</span>              : </span>
<span id="L60"><span class="lineNum">      60</span>              :       implicit none</span>
<span id="L61"><span class="lineNum">      61</span>              : </span>
<span id="L62"><span class="lineNum">      62</span>              :       private</span>
<span id="L63"><span class="lineNum">      63</span>              :       public :: icepack_step_therm2</span>
<span id="L64"><span class="lineNum">      64</span>              : </span>
<span id="L65"><span class="lineNum">      65</span>              : !=======================================================================</span>
<span id="L66"><span class="lineNum">      66</span>              : </span>
<span id="L67"><span class="lineNum">      67</span>              :       contains</span>
<span id="L68"><span class="lineNum">      68</span>              : </span>
<span id="L69"><span class="lineNum">      69</span>              : !=======================================================================</span>
<span id="L70"><span class="lineNum">      70</span>              : !</span>
<span id="L71"><span class="lineNum">      71</span>              : ! ITD scheme that shifts ice among categories</span>
<span id="L72"><span class="lineNum">      72</span>              : !</span>
<span id="L73"><span class="lineNum">      73</span>              : ! See Lipscomb, W. H.  Remapping the thickness distribution in sea</span>
<span id="L74"><span class="lineNum">      74</span>              : !     ice models. 2001, J. Geophys. Res., Vol 106, 13989--14000.</span>
<span id="L75"><span class="lineNum">      75</span>              : !</span>
<span id="L76"><span class="lineNum">      76</span>              : ! Using the thermodynamic &quot;velocities&quot;, interpolate to find the</span>
<span id="L77"><span class="lineNum">      77</span>              : ! velocities in thickness space at the category boundaries, and</span>
<span id="L78"><span class="lineNum">      78</span>              : ! compute the new locations of the boundaries.  Then for each</span>
<span id="L79"><span class="lineNum">      79</span>              : ! category, compute the thickness distribution function,  g(h),</span>
<span id="L80"><span class="lineNum">      80</span>              : ! between hL and hR, the left and right boundaries of the category.</span>
<span id="L81"><span class="lineNum">      81</span>              : ! Assume g(h) is a linear polynomial that satisfies two conditions:</span>
<span id="L82"><span class="lineNum">      82</span>              : !</span>
<span id="L83"><span class="lineNum">      83</span>              : ! (1) The ice area implied by g(h) equals aicen(n).</span>
<span id="L84"><span class="lineNum">      84</span>              : ! (2) The ice volume implied by g(h) equals aicen(n)*hicen(n).</span>
<span id="L85"><span class="lineNum">      85</span>              : !</span>
<span id="L86"><span class="lineNum">      86</span>              : ! Given g(h), at each boundary compute the ice area and volume lying</span>
<span id="L87"><span class="lineNum">      87</span>              : ! between the original and new boundary locations.  Transfer area</span>
<span id="L88"><span class="lineNum">      88</span>              : ! and volume across each boundary in the appropriate direction, thus</span>
<span id="L89"><span class="lineNum">      89</span>              : ! restoring the original boundaries.</span>
<span id="L90"><span class="lineNum">      90</span>              : !</span>
<span id="L91"><span class="lineNum">      91</span>              : ! authors: William H. Lipscomb, LANL</span>
<span id="L92"><span class="lineNum">      92</span>              : !          Elizabeth C. Hunke, LANL</span>
<span id="L93"><span class="lineNum">      93</span>              : </span>
<span id="L94"><span class="lineNum">      94</span> <span class="tlaUNC tlaBgUNC">           0 :       subroutine linear_itd (hin_max,     trcr_depend, &amp;</span></span>
<span id="L95"><span class="lineNum">      95</span> <span class="tlaGNC tlaBgGNC">   254098382 :                              trcr_base,   n_trcr_strata,&amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L96"><span class="lineNum">      96</span> <span class="tlaGNC">   254098382 :                              nt_strata,                &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L97"><span class="lineNum">      97</span> <span class="tlaGNC">   254098382 :                              aicen_init,  vicen_init,  &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L98"><span class="lineNum">      98</span> <span class="tlaGNC">   508196764 :                              aicen,       trcrn,       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L99"><span class="lineNum">      99</span> <span class="tlaGNC">   254098382 :                              vicen,       vsnon,       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L100"><span class="lineNum">     100</span>              :                              aice,        aice0,       &amp;   ! LCOV_EXCL_LINE</span>
<span id="L101"><span class="lineNum">     101</span>              :                              fpond,       Tf           )</span>
<span id="L102"><span class="lineNum">     102</span>              : </span>
<span id="L103"><span class="lineNum">     103</span>              :       real (kind=dbl_kind), dimension(0:ncat), intent(in) :: &amp;</span>
<span id="L104"><span class="lineNum">     104</span>              :          hin_max      ! category boundaries (m)</span>
<span id="L105"><span class="lineNum">     105</span>              : </span>
<span id="L106"><span class="lineNum">     106</span>              :       integer (kind=int_kind), dimension (:), intent(in) :: &amp;</span>
<span id="L107"><span class="lineNum">     107</span>              :          trcr_depend, &amp; ! = 0 for aicen tracers, 1 for vicen, 2 for vsnon   ! LCOV_EXCL_LINE</span>
<span id="L108"><span class="lineNum">     108</span>              :          n_trcr_strata  ! number of underlying tracer layers</span>
<span id="L109"><span class="lineNum">     109</span>              : </span>
<span id="L110"><span class="lineNum">     110</span>              :       real (kind=dbl_kind), dimension (:,:), intent(in) :: &amp;</span>
<span id="L111"><span class="lineNum">     111</span>              :          trcr_base      ! = 0 or 1 depending on tracer dependency</span>
<span id="L112"><span class="lineNum">     112</span>              :                         ! argument 2:  (1) aice, (2) vice, (3) vsno</span>
<span id="L113"><span class="lineNum">     113</span>              : </span>
<span id="L114"><span class="lineNum">     114</span>              :       integer (kind=int_kind), dimension (:,:), intent(in) :: &amp;</span>
<span id="L115"><span class="lineNum">     115</span>              :          nt_strata      ! indices of underlying tracer layers</span>
<span id="L116"><span class="lineNum">     116</span>              : </span>
<span id="L117"><span class="lineNum">     117</span>              :       real (kind=dbl_kind), intent(in) :: &amp;</span>
<span id="L118"><span class="lineNum">     118</span>              :          Tf             ! freezing temperature</span>
<span id="L119"><span class="lineNum">     119</span>              : </span>
<span id="L120"><span class="lineNum">     120</span>              :       real (kind=dbl_kind), dimension(:), intent(in) :: &amp;</span>
<span id="L121"><span class="lineNum">     121</span>              :          aicen_init, &amp; ! initial ice concentration (before vertical thermo)   ! LCOV_EXCL_LINE</span>
<span id="L122"><span class="lineNum">     122</span>              :          vicen_init    ! initial ice volume               (m)</span>
<span id="L123"><span class="lineNum">     123</span>              : </span>
<span id="L124"><span class="lineNum">     124</span>              :       real (kind=dbl_kind), dimension (:), intent(inout) :: &amp;</span>
<span id="L125"><span class="lineNum">     125</span>              :          aicen  , &amp; ! ice concentration   ! LCOV_EXCL_LINE</span>
<span id="L126"><span class="lineNum">     126</span>              :          vicen  , &amp; ! volume per unit area of ice      (m)   ! LCOV_EXCL_LINE</span>
<span id="L127"><span class="lineNum">     127</span>              :          vsnon      ! volume per unit area of snow     (m)</span>
<span id="L128"><span class="lineNum">     128</span>              : </span>
<span id="L129"><span class="lineNum">     129</span>              :       real (kind=dbl_kind), dimension (:,:), intent(inout) :: &amp;</span>
<span id="L130"><span class="lineNum">     130</span>              :          trcrn     ! ice tracers</span>
<span id="L131"><span class="lineNum">     131</span>              : </span>
<span id="L132"><span class="lineNum">     132</span>              :       real (kind=dbl_kind), intent(inout) :: &amp;</span>
<span id="L133"><span class="lineNum">     133</span>              :          aice  , &amp; ! concentration of ice   ! LCOV_EXCL_LINE</span>
<span id="L134"><span class="lineNum">     134</span>              :          aice0 , &amp; ! concentration of open water   ! LCOV_EXCL_LINE</span>
<span id="L135"><span class="lineNum">     135</span>              :          fpond     ! fresh water flux to ponds (kg/m^2/s)</span>
<span id="L136"><span class="lineNum">     136</span>              : </span>
<span id="L137"><span class="lineNum">     137</span>              :       ! local variables</span>
<span id="L138"><span class="lineNum">     138</span>              : </span>
<span id="L139"><span class="lineNum">     139</span>              :       integer (kind=int_kind) :: &amp;</span>
<span id="L140"><span class="lineNum">     140</span>              :          n, nd        , &amp; ! category indices   ! LCOV_EXCL_LINE</span>
<span id="L141"><span class="lineNum">     141</span>              :          k                ! ice layer index</span>
<span id="L142"><span class="lineNum">     142</span>              : </span>
<span id="L143"><span class="lineNum">     143</span>              :       real (kind=dbl_kind) :: &amp;</span>
<span id="L144"><span class="lineNum">     144</span> <span class="tlaGNC">    18513431 :          slope        , &amp; ! rate of change of dhice with hice   ! LCOV_EXCL_LINE</span></span>
<span id="L145"><span class="lineNum">     145</span> <span class="tlaGNC">    18513431 :          dh0          , &amp; ! change in ice thickness at h = 0   ! LCOV_EXCL_LINE</span></span>
<span id="L146"><span class="lineNum">     146</span> <span class="tlaGNC">    18513431 :          da0          , &amp; ! area melting from category 1   ! LCOV_EXCL_LINE</span></span>
<span id="L147"><span class="lineNum">     147</span> <span class="tlaGNC">    18513431 :          damax        , &amp; ! max allowed reduction in category 1 area   ! LCOV_EXCL_LINE</span></span>
<span id="L148"><span class="lineNum">     148</span> <span class="tlaGNC">    18513431 :          etamin, etamax,&amp; ! left and right limits of integration   ! LCOV_EXCL_LINE</span></span>
<span id="L149"><span class="lineNum">     149</span> <span class="tlaGNC">    18513431 :          x1           , &amp; ! etamax - etamin   ! LCOV_EXCL_LINE</span></span>
<span id="L150"><span class="lineNum">     150</span> <span class="tlaGNC">    18513431 :          x2           , &amp; ! (etamax^2 - etamin^2) / 2   ! LCOV_EXCL_LINE</span></span>
<span id="L151"><span class="lineNum">     151</span> <span class="tlaGNC">    18513431 :          x3           , &amp; ! (etamax^3 - etamin^3) / 3   ! LCOV_EXCL_LINE</span></span>
<span id="L152"><span class="lineNum">     152</span> <span class="tlaGNC">    18513431 :          wk1, wk2         ! temporary variables</span></span>
<span id="L153"><span class="lineNum">     153</span>              : </span>
<span id="L154"><span class="lineNum">     154</span>              :       real (kind=dbl_kind), dimension(0:ncat) :: &amp;</span>
<span id="L155"><span class="lineNum">     155</span> <span class="tlaGNC">   601611775 :          hbnew            ! new boundary locations</span></span>
<span id="L156"><span class="lineNum">     156</span>              : </span>
<span id="L157"><span class="lineNum">     157</span>              :       real (kind=dbl_kind), dimension(ncat) :: &amp;</span>
<span id="L158"><span class="lineNum">     158</span> <span class="tlaGNC">   583098344 :          g0           , &amp; ! constant coefficient in g(h)   ! LCOV_EXCL_LINE</span></span>
<span id="L159"><span class="lineNum">     159</span> <span class="tlaGNC">   583098344 :          g1           , &amp; ! linear coefficient in g(h)   ! LCOV_EXCL_LINE</span></span>
<span id="L160"><span class="lineNum">     160</span> <span class="tlaGNC">   583098344 :          hL           , &amp; ! left end of range over which g(h) &gt; 0   ! LCOV_EXCL_LINE</span></span>
<span id="L161"><span class="lineNum">     161</span> <span class="tlaGNC">   583098344 :          hR               ! right end of range over which g(h) &gt; 0</span></span>
<span id="L162"><span class="lineNum">     162</span>              : </span>
<span id="L163"><span class="lineNum">     163</span>              :       real (kind=dbl_kind), dimension(ncat) :: &amp;</span>
<span id="L164"><span class="lineNum">     164</span> <span class="tlaGNC">   583098344 :          hicen        , &amp; ! ice thickness for each cat     (m)   ! LCOV_EXCL_LINE</span></span>
<span id="L165"><span class="lineNum">     165</span> <span class="tlaGNC">   583098344 :          hicen_init   , &amp; ! initial ice thickness for each cat (pre-thermo)   ! LCOV_EXCL_LINE</span></span>
<span id="L166"><span class="lineNum">     166</span> <span class="tlaGNC">   583098344 :          dhicen       , &amp; ! thickness change for remapping (m)   ! LCOV_EXCL_LINE</span></span>
<span id="L167"><span class="lineNum">     167</span> <span class="tlaGNC">   366026824 :          daice        , &amp; ! ice area transferred across boundary   ! LCOV_EXCL_LINE</span></span>
<span id="L168"><span class="lineNum">     168</span> <span class="tlaGNC">   583098344 :          dvice            ! ice volume transferred across boundary</span></span>
<span id="L169"><span class="lineNum">     169</span>              : </span>
<span id="L170"><span class="lineNum">     170</span>              :       real (kind=dbl_kind), dimension (ncat) :: &amp;</span>
<span id="L171"><span class="lineNum">     171</span> <span class="tlaGNC">   583098344 :          eicen, &amp;     ! energy of melting for each ice layer (J/m^2)   ! LCOV_EXCL_LINE</span></span>
<span id="L172"><span class="lineNum">     172</span> <span class="tlaGNC">   583098344 :          esnon, &amp;     ! energy of melting for each snow layer (J/m^2)   ! LCOV_EXCL_LINE</span></span>
<span id="L173"><span class="lineNum">     173</span> <span class="tlaGNC">   583098344 :          vbrin, &amp;     ! ice volume defined by brine height (m)   ! LCOV_EXCL_LINE</span></span>
<span id="L174"><span class="lineNum">     174</span> <span class="tlaGNC">   583098344 :          sicen        ! Bulk salt in h ice (ppt*m)</span></span>
<span id="L175"><span class="lineNum">     175</span>              : </span>
<span id="L176"><span class="lineNum">     176</span>              :       real (kind=dbl_kind) :: &amp;</span>
<span id="L177"><span class="lineNum">     177</span> <span class="tlaGNC">    18513431 :          vice_init, vice_final, &amp; ! ice volume summed over categories   ! LCOV_EXCL_LINE</span></span>
<span id="L178"><span class="lineNum">     178</span> <span class="tlaGNC">    18513431 :          vsno_init, vsno_final, &amp; ! snow volume summed over categories   ! LCOV_EXCL_LINE</span></span>
<span id="L179"><span class="lineNum">     179</span> <span class="tlaGNC">    18513431 :          eice_init, eice_final, &amp; ! ice energy summed over categories   ! LCOV_EXCL_LINE</span></span>
<span id="L180"><span class="lineNum">     180</span> <span class="tlaGNC">    18513431 :          esno_init, esno_final, &amp; ! snow energy summed over categories   ! LCOV_EXCL_LINE</span></span>
<span id="L181"><span class="lineNum">     181</span> <span class="tlaGNC">    18513431 :          sice_init, sice_final, &amp; ! ice bulk salinity summed over categories   ! LCOV_EXCL_LINE</span></span>
<span id="L182"><span class="lineNum">     182</span> <span class="tlaGNC">    18513431 :          vbri_init, vbri_final    ! briny ice volume summed over categories</span></span>
<span id="L183"><span class="lineNum">     183</span>              : </span>
<span id="L184"><span class="lineNum">     184</span>              :       ! NOTE: Third index of donor, daice, dvice should be ncat-1,</span>
<span id="L185"><span class="lineNum">     185</span>              :       !       except that compilers would have trouble when ncat = 1</span>
<span id="L186"><span class="lineNum">     186</span>              :       integer (kind=int_kind), dimension(ncat) :: &amp;</span>
<span id="L187"><span class="lineNum">     187</span> <span class="tlaGNC">   272611813 :          donor            ! donor category index</span></span>
<span id="L188"><span class="lineNum">     188</span>              : </span>
<span id="L189"><span class="lineNum">     189</span>              :       logical (kind=log_kind) :: &amp;</span>
<span id="L190"><span class="lineNum">     190</span>              :          remap_flag       ! remap ITD if remap_flag is true</span>
<span id="L191"><span class="lineNum">     191</span>              : </span>
<span id="L192"><span class="lineNum">     192</span>              :       character (len=char_len) :: &amp;</span>
<span id="L193"><span class="lineNum">     193</span>              :          fieldid           ! field identifier</span>
<span id="L194"><span class="lineNum">     194</span>              : </span>
<span id="L195"><span class="lineNum">     195</span>              :       logical (kind=log_kind), parameter :: &amp;</span>
<span id="L196"><span class="lineNum">     196</span>              :          print_diags = .false.    ! if true, prints when remap_flag=F</span>
<span id="L197"><span class="lineNum">     197</span>              : </span>
<span id="L198"><span class="lineNum">     198</span>              :       character(len=*),parameter :: subname='(linear_itd)'</span>
<span id="L199"><span class="lineNum">     199</span>              : </span>
<span id="L200"><span class="lineNum">     200</span>              :       !-----------------------------------------------------------------</span>
<span id="L201"><span class="lineNum">     201</span>              :       ! Initialize</span>
<span id="L202"><span class="lineNum">     202</span>              :       !-----------------------------------------------------------------</span>
<span id="L203"><span class="lineNum">     203</span>              : </span>
<span id="L204"><span class="lineNum">     204</span> <span class="tlaGNC">  1528237362 :       do n = 1, ncat</span></span>
<span id="L205"><span class="lineNum">     205</span> <span class="tlaGNC">  1274138980 :          donor(n) = 0</span></span>
<span id="L206"><span class="lineNum">     206</span> <span class="tlaGNC">  1274138980 :          daice(n) = c0</span></span>
<span id="L207"><span class="lineNum">     207</span> <span class="tlaGNC">  1528237362 :          dvice(n) = c0</span></span>
<span id="L208"><span class="lineNum">     208</span>              :       enddo</span>
<span id="L209"><span class="lineNum">     209</span>              : </span>
<span id="L210"><span class="lineNum">     210</span>              :       !-----------------------------------------------------------------</span>
<span id="L211"><span class="lineNum">     211</span>              :       ! Compute volume and energy sums that linear remapping should</span>
<span id="L212"><span class="lineNum">     212</span>              :       !  conserve.</span>
<span id="L213"><span class="lineNum">     213</span>              :       !-----------------------------------------------------------------</span>
<span id="L214"><span class="lineNum">     214</span>              : </span>
<span id="L215"><span class="lineNum">     215</span> <span class="tlaGNC">   254098382 :       if (conserv_check) then</span></span>
<span id="L216"><span class="lineNum">     216</span>              : </span>
<span id="L217"><span class="lineNum">     217</span> <span class="tlaGNC">    15378160 :       do n = 1, ncat</span></span>
<span id="L218"><span class="lineNum">     218</span>              : </span>
<span id="L219"><span class="lineNum">     219</span> <span class="tlaGNC">    13181280 :          eicen(n) = c0</span></span>
<span id="L220"><span class="lineNum">     220</span> <span class="tlaGNC">    13181280 :          esnon(n) = c0</span></span>
<span id="L221"><span class="lineNum">     221</span> <span class="tlaGNC">    13181280 :          vbrin(n) = c0</span></span>
<span id="L222"><span class="lineNum">     222</span> <span class="tlaGNC">    13181280 :          sicen(n) = c0</span></span>
<span id="L223"><span class="lineNum">     223</span>              : </span>
<span id="L224"><span class="lineNum">     224</span> <span class="tlaGNC">   105450240 :          do k = 1, nilyr</span></span>
<span id="L225"><span class="lineNum">     225</span> <span class="tlaGNC">   127860768 :             eicen(n) = eicen(n) + trcrn(nt_qice+k-1,n) &amp;</span></span>
<span id="L226"><span class="lineNum">     226</span> <span class="tlaGNC">   233311008 :                      * vicen(n)/real(nilyr,kind=dbl_kind)</span></span>
<span id="L227"><span class="lineNum">     227</span>              :          enddo</span>
<span id="L228"><span class="lineNum">     228</span> <span class="tlaGNC">    26362560 :          do k = 1, nslyr</span></span>
<span id="L229"><span class="lineNum">     229</span> <span class="tlaGNC">    18265824 :             esnon(n) = esnon(n) + trcrn(nt_qsno+k-1,n) &amp;</span></span>
<span id="L230"><span class="lineNum">     230</span> <span class="tlaGNC">    44628384 :                      * vsnon(n)/real(nslyr,kind=dbl_kind)</span></span>
<span id="L231"><span class="lineNum">     231</span>              :          enddo</span>
<span id="L232"><span class="lineNum">     232</span>              : </span>
<span id="L233"><span class="lineNum">     233</span> <span class="tlaGNC">    13181280 :          if (tr_brine) then</span></span>
<span id="L234"><span class="lineNum">     234</span> <span class="tlaUNC tlaBgUNC">           0 :             vbrin(n) = vbrin(n) + trcrn(nt_fbri,n) &amp;</span></span>
<span id="L235"><span class="lineNum">     235</span> <span class="tlaUNC">           0 :                      * vicen(n)</span></span>
<span id="L236"><span class="lineNum">     236</span>              :          endif</span>
<span id="L237"><span class="lineNum">     237</span>              : </span>
<span id="L238"><span class="lineNum">     238</span> <span class="tlaGNC tlaBgGNC">   107647120 :          do k = 1, nilyr</span></span>
<span id="L239"><span class="lineNum">     239</span> <span class="tlaGNC">   127860768 :             sicen(n) = sicen(n) + trcrn(nt_sice+k-1,n) &amp;</span></span>
<span id="L240"><span class="lineNum">     240</span> <span class="tlaGNC">   233311008 :                      * vicen(n)/real(nilyr,kind=dbl_kind)</span></span>
<span id="L241"><span class="lineNum">     241</span>              :          enddo</span>
<span id="L242"><span class="lineNum">     242</span>              : </span>
<span id="L243"><span class="lineNum">     243</span>              :       enddo ! n</span>
<span id="L244"><span class="lineNum">     244</span>              : </span>
<span id="L245"><span class="lineNum">     245</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, vicen, vice_init)</span></span>
<span id="L246"><span class="lineNum">     246</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L247"><span class="lineNum">     247</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, vsnon, vsno_init)</span></span>
<span id="L248"><span class="lineNum">     248</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L249"><span class="lineNum">     249</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, eicen, eice_init)</span></span>
<span id="L250"><span class="lineNum">     250</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L251"><span class="lineNum">     251</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, esnon, esno_init)</span></span>
<span id="L252"><span class="lineNum">     252</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L253"><span class="lineNum">     253</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, sicen, sice_init)</span></span>
<span id="L254"><span class="lineNum">     254</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L255"><span class="lineNum">     255</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, vbrin, vbri_init)</span></span>
<span id="L256"><span class="lineNum">     256</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L257"><span class="lineNum">     257</span>              : </span>
<span id="L258"><span class="lineNum">     258</span>              :       endif ! conserv_check</span>
<span id="L259"><span class="lineNum">     259</span>              : </span>
<span id="L260"><span class="lineNum">     260</span>              :       !-----------------------------------------------------------------</span>
<span id="L261"><span class="lineNum">     261</span>              :       ! Initialize remapping flag.</span>
<span id="L262"><span class="lineNum">     262</span>              :       ! Remapping is done wherever remap_flag = .true.</span>
<span id="L263"><span class="lineNum">     263</span>              :       ! In rare cases the category boundaries may shift too far for the</span>
<span id="L264"><span class="lineNum">     264</span>              :       !  remapping algorithm to work, and remap_flag is set to .false.</span>
<span id="L265"><span class="lineNum">     265</span>              :       ! In these cases the simpler 'rebin' subroutine will shift ice</span>
<span id="L266"><span class="lineNum">     266</span>              :       !  between categories if needed.</span>
<span id="L267"><span class="lineNum">     267</span>              :       !-----------------------------------------------------------------</span>
<span id="L268"><span class="lineNum">     268</span>              : </span>
<span id="L269"><span class="lineNum">     269</span> <span class="tlaGNC">   254098382 :       remap_flag = .true.</span></span>
<span id="L270"><span class="lineNum">     270</span>              : </span>
<span id="L271"><span class="lineNum">     271</span>              :       !-----------------------------------------------------------------</span>
<span id="L272"><span class="lineNum">     272</span>              :       ! Compute thickness change in each category.</span>
<span id="L273"><span class="lineNum">     273</span>              :       !-----------------------------------------------------------------</span>
<span id="L274"><span class="lineNum">     274</span>              : </span>
<span id="L275"><span class="lineNum">     275</span> <span class="tlaGNC">  1528237362 :       do n = 1, ncat</span></span>
<span id="L276"><span class="lineNum">     276</span>              : </span>
<span id="L277"><span class="lineNum">     277</span> <span class="tlaGNC">  1274138980 :          if (aicen_init(n) &gt; puny) then</span></span>
<span id="L278"><span class="lineNum">     278</span> <span class="tlaGNC">  1218483647 :              hicen_init(n) = vicen_init(n) / aicen_init(n)</span></span>
<span id="L279"><span class="lineNum">     279</span>              :          else</span>
<span id="L280"><span class="lineNum">     280</span> <span class="tlaGNC">    55655333 :              hicen_init(n) = c0</span></span>
<span id="L281"><span class="lineNum">     281</span>              :          endif               ! aicen_init &gt; puny</span>
<span id="L282"><span class="lineNum">     282</span>              : </span>
<span id="L283"><span class="lineNum">     283</span> <span class="tlaGNC">  1528237362 :          if (aicen (n) &gt; puny) then</span></span>
<span id="L284"><span class="lineNum">     284</span> <span class="tlaGNC">  1218440759 :              hicen (n) = vicen(n) / aicen(n)</span></span>
<span id="L285"><span class="lineNum">     285</span> <span class="tlaGNC">  1218440759 :              dhicen(n) = hicen(n) - hicen_init(n)</span></span>
<span id="L286"><span class="lineNum">     286</span>              :          else</span>
<span id="L287"><span class="lineNum">     287</span> <span class="tlaGNC">    55698221 :              hicen (n) = c0</span></span>
<span id="L288"><span class="lineNum">     288</span> <span class="tlaGNC">    55698221 :              dhicen(n) = c0</span></span>
<span id="L289"><span class="lineNum">     289</span>              :          endif               ! aicen &gt; puny</span>
<span id="L290"><span class="lineNum">     290</span>              : </span>
<span id="L291"><span class="lineNum">     291</span>              :       enddo                     ! n</span>
<span id="L292"><span class="lineNum">     292</span>              : </span>
<span id="L293"><span class="lineNum">     293</span>              :       !-----------------------------------------------------------------</span>
<span id="L294"><span class="lineNum">     294</span>              :       ! Compute new category boundaries, hbnew, based on changes in</span>
<span id="L295"><span class="lineNum">     295</span>              :       ! ice thickness from vertical thermodynamics.</span>
<span id="L296"><span class="lineNum">     296</span>              :       !-----------------------------------------------------------------</span>
<span id="L297"><span class="lineNum">     297</span>              : </span>
<span id="L298"><span class="lineNum">     298</span> <span class="tlaGNC">   254098382 :       hbnew(0) = hin_max(0)</span></span>
<span id="L299"><span class="lineNum">     299</span>              : </span>
<span id="L300"><span class="lineNum">     300</span> <span class="tlaGNC">  1274138980 :       do n = 1, ncat-1</span></span>
<span id="L301"><span class="lineNum">     301</span>              : </span>
<span id="L302"><span class="lineNum">     302</span> <span class="tlaGNC">  1020040598 :          if (hicen_init(n)   &gt; puny .and. &amp;</span></span>
<span id="L303"><span class="lineNum">     303</span>              :              hicen_init(n+1) &gt; puny) then</span>
<span id="L304"><span class="lineNum">     304</span>              : </span>
<span id="L305"><span class="lineNum">     305</span> <span class="tlaGNC">   962706680 :             if ((hicen_init(n+1) - hicen_init(n))&gt;0) then</span></span>
<span id="L306"><span class="lineNum">     306</span>              : </span>
<span id="L307"><span class="lineNum">     307</span>              :               ! interpolate between adjacent category growth rates</span>
<span id="L308"><span class="lineNum">     308</span> <span class="tlaGNC">   137677252 :               slope = (dhicen(n+1) - dhicen(n)) / &amp;</span></span>
<span id="L309"><span class="lineNum">     309</span> <span class="tlaGNC">  1100383932 :                  (hicen_init(n+1) - hicen_init(n))</span></span>
<span id="L310"><span class="lineNum">     310</span> <span class="tlaGNC">   206515878 :               hbnew(n) = hin_max(n) + dhicen(n) &amp;</span></span>
<span id="L311"><span class="lineNum">     311</span> <span class="tlaGNC">  1169222558 :                       + slope * (hin_max(n) - hicen_init(n))</span></span>
<span id="L312"><span class="lineNum">     312</span>              : </span>
<span id="L313"><span class="lineNum">     313</span>              :             else</span>
<span id="L314"><span class="lineNum">     314</span>              : </span>
<span id="L315"><span class="lineNum">     315</span> <span class="tlaUNC tlaBgUNC">           0 :               write(warnstr,*) subname, &amp;</span></span>
<span id="L316"><span class="lineNum">     316</span> <span class="tlaUNC">           0 :                  'ITD Thermodynamics: hicen_init(n+1) &lt;= hicen_init(n)'</span></span>
<span id="L317"><span class="lineNum">     317</span> <span class="tlaUNC">           0 :               call icepack_warnings_setabort(.true.,__FILE__,__LINE__)</span></span>
<span id="L318"><span class="lineNum">     318</span> <span class="tlaUNC">           0 :               call icepack_warnings_add(warnstr)</span></span>
<span id="L319"><span class="lineNum">     319</span>              : </span>
<span id="L320"><span class="lineNum">     320</span>              :             endif</span>
<span id="L321"><span class="lineNum">     321</span>              : </span>
<span id="L322"><span class="lineNum">     322</span> <span class="tlaGNC tlaBgGNC">    57333918 :          elseif (hicen_init(n) &gt; puny) then ! hicen_init(n+1)=0</span></span>
<span id="L323"><span class="lineNum">     323</span> <span class="tlaGNC">    27784768 :              hbnew(n) = hin_max(n) + dhicen(n)</span></span>
<span id="L324"><span class="lineNum">     324</span> <span class="tlaGNC">    29549150 :          elseif (hicen_init(n+1) &gt; puny) then ! hicen_init(n)=0</span></span>
<span id="L325"><span class="lineNum">     325</span> <span class="tlaGNC">     2615860 :              hbnew(n) = hin_max(n) + dhicen(n+1)</span></span>
<span id="L326"><span class="lineNum">     326</span>              :          else</span>
<span id="L327"><span class="lineNum">     327</span> <span class="tlaGNC">    26933290 :              hbnew(n) = hin_max(n)</span></span>
<span id="L328"><span class="lineNum">     328</span>              :          endif</span>
<span id="L329"><span class="lineNum">     329</span>              : </span>
<span id="L330"><span class="lineNum">     330</span>              :       !-----------------------------------------------------------------</span>
<span id="L331"><span class="lineNum">     331</span>              :       ! Check that each boundary lies between adjacent values of hicen.</span>
<span id="L332"><span class="lineNum">     332</span>              :       ! If not, set remap_flag = .false.</span>
<span id="L333"><span class="lineNum">     333</span>              :       ! Write diagnosis outputs if remap_flag was changed to false</span>
<span id="L334"><span class="lineNum">     334</span>              :       !-----------------------------------------------------------------</span>
<span id="L335"><span class="lineNum">     335</span>              : </span>
<span id="L336"><span class="lineNum">     336</span> <span class="tlaGNC">  1020040598 :          if (aicen(n) &gt; puny .and. hicen(n) &gt;= hbnew(n)) then</span></span>
<span id="L337"><span class="lineNum">     337</span> <span class="tlaGNC">       31800 :             remap_flag = .false.</span></span>
<span id="L338"><span class="lineNum">     338</span>              : </span>
<span id="L339"><span class="lineNum">     339</span>              :             if (print_diags) then</span>
<span id="L340"><span class="lineNum">     340</span>              :                write(warnstr,*) subname, 'ITD: hicen(n) &gt; hbnew(n)'</span>
<span id="L341"><span class="lineNum">     341</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L342"><span class="lineNum">     342</span>              :                write(warnstr,*) subname, 'cat ',n</span>
<span id="L343"><span class="lineNum">     343</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L344"><span class="lineNum">     344</span>              :                write(warnstr,*) subname, 'hicen(n) =', hicen(n)</span>
<span id="L345"><span class="lineNum">     345</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L346"><span class="lineNum">     346</span>              :                write(warnstr,*) subname, 'hbnew(n) =', hbnew(n)</span>
<span id="L347"><span class="lineNum">     347</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L348"><span class="lineNum">     348</span>              :             endif</span>
<span id="L349"><span class="lineNum">     349</span>              : </span>
<span id="L350"><span class="lineNum">     350</span> <span class="tlaGNC">  1020008798 :          elseif (aicen(n+1) &gt; puny .and. hicen(n+1) &lt;= hbnew(n)) then</span></span>
<span id="L351"><span class="lineNum">     351</span> <span class="tlaUNC tlaBgUNC">           0 :             remap_flag = .false.</span></span>
<span id="L352"><span class="lineNum">     352</span>              : </span>
<span id="L353"><span class="lineNum">     353</span>              :             if (print_diags) then</span>
<span id="L354"><span class="lineNum">     354</span>              :                write(warnstr,*) subname, 'ITD: hicen(n+1) &lt; hbnew(n)'</span>
<span id="L355"><span class="lineNum">     355</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L356"><span class="lineNum">     356</span>              :                write(warnstr,*) subname, 'cat ',n</span>
<span id="L357"><span class="lineNum">     357</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L358"><span class="lineNum">     358</span>              :                write(warnstr,*) subname, 'hicen(n+1) =', hicen(n+1)</span>
<span id="L359"><span class="lineNum">     359</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L360"><span class="lineNum">     360</span>              :                write(warnstr,*) subname, 'hbnew(n) =', hbnew(n)</span>
<span id="L361"><span class="lineNum">     361</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L362"><span class="lineNum">     362</span>              :             endif</span>
<span id="L363"><span class="lineNum">     363</span>              :          endif</span>
<span id="L364"><span class="lineNum">     364</span>              : </span>
<span id="L365"><span class="lineNum">     365</span>              :       !-----------------------------------------------------------------</span>
<span id="L366"><span class="lineNum">     366</span>              :       ! Check that hbnew(n) lies between hin_max(n-1) and hin_max(n+1).</span>
<span id="L367"><span class="lineNum">     367</span>              :       ! If not, set remap_flag = .false.</span>
<span id="L368"><span class="lineNum">     368</span>              :       ! (In principle we could allow this, but it would make the code</span>
<span id="L369"><span class="lineNum">     369</span>              :       ! more complicated.)</span>
<span id="L370"><span class="lineNum">     370</span>              :       ! Write diagnosis outputs if remap_flag was changed to false</span>
<span id="L371"><span class="lineNum">     371</span>              :       !-----------------------------------------------------------------</span>
<span id="L372"><span class="lineNum">     372</span>              : </span>
<span id="L373"><span class="lineNum">     373</span> <span class="tlaGNC tlaBgGNC">  1020040598 :          if (hbnew(n) &gt; hin_max(n+1)) then</span></span>
<span id="L374"><span class="lineNum">     374</span> <span class="tlaUNC tlaBgUNC">           0 :             remap_flag = .false.</span></span>
<span id="L375"><span class="lineNum">     375</span>              : </span>
<span id="L376"><span class="lineNum">     376</span>              :             if (print_diags) then</span>
<span id="L377"><span class="lineNum">     377</span>              :                write(warnstr,*) subname, 'ITD hbnew(n) &gt; hin_max(n+1)'</span>
<span id="L378"><span class="lineNum">     378</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L379"><span class="lineNum">     379</span>              :                write(warnstr,*) subname, 'cat ',n</span>
<span id="L380"><span class="lineNum">     380</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L381"><span class="lineNum">     381</span>              :                write(warnstr,*) subname, 'hbnew(n) =', hbnew(n)</span>
<span id="L382"><span class="lineNum">     382</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L383"><span class="lineNum">     383</span>              :                write(warnstr,*) subname, 'hin_max(n+1) =', hin_max(n+1)</span>
<span id="L384"><span class="lineNum">     384</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L385"><span class="lineNum">     385</span>              :             endif</span>
<span id="L386"><span class="lineNum">     386</span>              :          endif</span>
<span id="L387"><span class="lineNum">     387</span>              : </span>
<span id="L388"><span class="lineNum">     388</span> <span class="tlaGNC tlaBgGNC">  1274138980 :          if (hbnew(n) &lt; hin_max(n-1)) then</span></span>
<span id="L389"><span class="lineNum">     389</span> <span class="tlaUNC tlaBgUNC">           0 :             remap_flag = .false.</span></span>
<span id="L390"><span class="lineNum">     390</span>              : </span>
<span id="L391"><span class="lineNum">     391</span>              :             if (print_diags) then</span>
<span id="L392"><span class="lineNum">     392</span>              :                write(warnstr,*) subname, 'ITD: hbnew(n) &lt; hin_max(n-1)'</span>
<span id="L393"><span class="lineNum">     393</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L394"><span class="lineNum">     394</span>              :                write(warnstr,*) subname, 'cat ',n</span>
<span id="L395"><span class="lineNum">     395</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L396"><span class="lineNum">     396</span>              :                write(warnstr,*) subname, 'hbnew(n) =', hbnew(n)</span>
<span id="L397"><span class="lineNum">     397</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L398"><span class="lineNum">     398</span>              :                write(warnstr,*) subname, 'hin_max(n-1) =', hin_max(n-1)</span>
<span id="L399"><span class="lineNum">     399</span>              :                call icepack_warnings_add(warnstr)</span>
<span id="L400"><span class="lineNum">     400</span>              :             endif</span>
<span id="L401"><span class="lineNum">     401</span>              :          endif</span>
<span id="L402"><span class="lineNum">     402</span>              : </span>
<span id="L403"><span class="lineNum">     403</span>              :       enddo                     ! boundaries, 1 to ncat-1</span>
<span id="L404"><span class="lineNum">     404</span>              : </span>
<span id="L405"><span class="lineNum">     405</span>              :       !-----------------------------------------------------------------</span>
<span id="L406"><span class="lineNum">     406</span>              :       ! Compute hbnew(ncat)</span>
<span id="L407"><span class="lineNum">     407</span>              :       !-----------------------------------------------------------------</span>
<span id="L408"><span class="lineNum">     408</span>              : </span>
<span id="L409"><span class="lineNum">     409</span> <span class="tlaGNC tlaBgGNC">   254098382 :       if (aicen(ncat) &gt; puny) then</span></span>
<span id="L410"><span class="lineNum">     410</span> <span class="tlaGNC">   227992199 :          hbnew(ncat) = c3*hicen(ncat) - c2*hbnew(ncat-1)</span></span>
<span id="L411"><span class="lineNum">     411</span>              :       else</span>
<span id="L412"><span class="lineNum">     412</span> <span class="tlaGNC">    26106183 :          hbnew(ncat) = hin_max(ncat)</span></span>
<span id="L413"><span class="lineNum">     413</span>              :       endif</span>
<span id="L414"><span class="lineNum">     414</span> <span class="tlaGNC">   254098382 :       hbnew(ncat) = max(hbnew(ncat),hin_max(ncat-1))</span></span>
<span id="L415"><span class="lineNum">     415</span>              : </span>
<span id="L416"><span class="lineNum">     416</span>              :       !-----------------------------------------------------------------</span>
<span id="L417"><span class="lineNum">     417</span>              :       ! Identify cells where the ITD is to be remapped</span>
<span id="L418"><span class="lineNum">     418</span>              :       !-----------------------------------------------------------------</span>
<span id="L419"><span class="lineNum">     419</span>              : </span>
<span id="L420"><span class="lineNum">     420</span> <span class="tlaGNC">   254098382 :       if (remap_flag) then</span></span>
<span id="L421"><span class="lineNum">     421</span>              : </span>
<span id="L422"><span class="lineNum">     422</span>              :       !-----------------------------------------------------------------</span>
<span id="L423"><span class="lineNum">     423</span>              :       ! Compute g(h) for category 1 at start of time step</span>
<span id="L424"><span class="lineNum">     424</span>              :       ! (hicen = hicen_init)</span>
<span id="L425"><span class="lineNum">     425</span>              :       !-----------------------------------------------------------------</span>
<span id="L426"><span class="lineNum">     426</span>              : </span>
<span id="L427"><span class="lineNum">     427</span> <span class="tlaGNC">    18497531 :          call fit_line(aicen(1),   hicen_init(1), &amp;</span></span>
<span id="L428"><span class="lineNum">     428</span> <span class="tlaGNC">    18497531 :                        hbnew(0),   hin_max   (1), &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L429"><span class="lineNum">     429</span> <span class="tlaGNC">    18497531 :                        g0   (1),   g1        (1), &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L430"><span class="lineNum">     430</span> <span class="tlaGNC">   254066582 :                        hL   (1),   hR        (1))</span></span>
<span id="L431"><span class="lineNum">     431</span> <span class="tlaGNC">   254066582 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L432"><span class="lineNum">     432</span>              : </span>
<span id="L433"><span class="lineNum">     433</span>              :       !-----------------------------------------------------------------</span>
<span id="L434"><span class="lineNum">     434</span>              :       ! Find area lost due to melting of thin (category 1) ice</span>
<span id="L435"><span class="lineNum">     435</span>              :       !-----------------------------------------------------------------</span>
<span id="L436"><span class="lineNum">     436</span>              : </span>
<span id="L437"><span class="lineNum">     437</span> <span class="tlaGNC">   254066582 :          if (aicen(1) &gt; puny) then</span></span>
<span id="L438"><span class="lineNum">     438</span>              : </span>
<span id="L439"><span class="lineNum">     439</span> <span class="tlaGNC">   253118219 :             dh0 = dhicen(1)</span></span>
<span id="L440"><span class="lineNum">     440</span> <span class="tlaGNC">   253118219 :             if (dh0 &lt; c0) then   ! remove area from category 1</span></span>
<span id="L441"><span class="lineNum">     441</span> <span class="tlaGNC">   125896439 :                dh0 = min(-dh0,hin_max(1))   ! dh0 --&gt; |dh0|</span></span>
<span id="L442"><span class="lineNum">     442</span>              : </span>
<span id="L443"><span class="lineNum">     443</span>              :       !-----------------------------------------------------------------</span>
<span id="L444"><span class="lineNum">     444</span>              :       ! Integrate g(1) from 0 to dh0 to estimate area melted</span>
<span id="L445"><span class="lineNum">     445</span>              :       !-----------------------------------------------------------------</span>
<span id="L446"><span class="lineNum">     446</span>              : </span>
<span id="L447"><span class="lineNum">     447</span>              :                ! right integration limit (left limit = 0)</span>
<span id="L448"><span class="lineNum">     448</span> <span class="tlaGNC">   125896439 :                etamax = min(dh0,hR(1)) - hL(1)</span></span>
<span id="L449"><span class="lineNum">     449</span>              : </span>
<span id="L450"><span class="lineNum">     450</span> <span class="tlaGNC">   125896439 :                if (etamax &gt; c0) then</span></span>
<span id="L451"><span class="lineNum">     451</span> <span class="tlaGNC">   116540487 :                   x1 = etamax</span></span>
<span id="L452"><span class="lineNum">     452</span> <span class="tlaGNC">   116540487 :                   x2 = p5 * etamax*etamax</span></span>
<span id="L453"><span class="lineNum">     453</span> <span class="tlaGNC">   116540487 :                   da0 = g1(1)*x2 + g0(1)*x1 ! ice area removed</span></span>
<span id="L454"><span class="lineNum">     454</span>              : </span>
<span id="L455"><span class="lineNum">     455</span>              :                ! constrain new thickness &lt;= hicen_init</span>
<span id="L456"><span class="lineNum">     456</span> <span class="tlaGNC">   116540487 :                   damax = aicen(1) * (c1-hicen(1)/hicen_init(1)) ! damax &gt; 0</span></span>
<span id="L457"><span class="lineNum">     457</span> <span class="tlaGNC">   116540487 :                   da0 = min (da0, damax)</span></span>
<span id="L458"><span class="lineNum">     458</span>              : </span>
<span id="L459"><span class="lineNum">     459</span>              :                ! remove area, conserving volume</span>
<span id="L460"><span class="lineNum">     460</span> <span class="tlaGNC">   116540487 :                   hicen(1) = hicen(1) * aicen(1) / (aicen(1)-da0)</span></span>
<span id="L461"><span class="lineNum">     461</span> <span class="tlaGNC">   116540487 :                   aicen(1) = aicen(1) - da0</span></span>
<span id="L462"><span class="lineNum">     462</span>              : </span>
<span id="L463"><span class="lineNum">     463</span> <span class="tlaGNC">   116540487 :                   if (tr_pond_topo) &amp;</span></span>
<span id="L464"><span class="lineNum">     464</span> <span class="tlaGNC">      239384 :                      fpond = fpond - (da0 * trcrn(nt_apnd,1) &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L465"><span class="lineNum">     465</span> <span class="tlaGNC">      477046 :                                           * trcrn(nt_hpnd,1))</span></span>
<span id="L466"><span class="lineNum">     466</span>              : </span>
<span id="L467"><span class="lineNum">     467</span>              :                endif            ! etamax &gt; 0</span>
<span id="L468"><span class="lineNum">     468</span>              : </span>
<span id="L469"><span class="lineNum">     469</span>              :             else                ! dh0 &gt;= 0</span>
<span id="L470"><span class="lineNum">     470</span> <span class="tlaGNC">   127221780 :                hbnew(0) = min(dh0,hin_max(1))  ! shift hbnew(0) to right</span></span>
<span id="L471"><span class="lineNum">     471</span>              :             endif</span>
<span id="L472"><span class="lineNum">     472</span>              : </span>
<span id="L473"><span class="lineNum">     473</span>              :          endif                  ! aicen(1) &gt; puny</span>
<span id="L474"><span class="lineNum">     474</span>              : </span>
<span id="L475"><span class="lineNum">     475</span>              :       !-----------------------------------------------------------------</span>
<span id="L476"><span class="lineNum">     476</span>              :       ! Compute g(h) for each ice thickness category.</span>
<span id="L477"><span class="lineNum">     477</span>              :       !-----------------------------------------------------------------</span>
<span id="L478"><span class="lineNum">     478</span>              : </span>
<span id="L479"><span class="lineNum">     479</span> <span class="tlaGNC">  1528046562 :          do n = 1, ncat</span></span>
<span id="L480"><span class="lineNum">     480</span>              : </span>
<span id="L481"><span class="lineNum">     481</span> <span class="tlaGNC">   186671022 :             call fit_line(aicen(n),   hicen(n), &amp;</span></span>
<span id="L482"><span class="lineNum">     482</span> <span class="tlaGNC">   186671022 :                           hbnew(n-1), hbnew(n), &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L483"><span class="lineNum">     483</span> <span class="tlaGNC">   186671022 :                           g0   (n),   g1   (n), &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L484"><span class="lineNum">     484</span> <span class="tlaGNC">  1833993046 :                           hL   (n),   hR   (n))</span></span>
<span id="L485"><span class="lineNum">     485</span> <span class="tlaGNC">  1273979980 :             if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L486"><span class="lineNum">     486</span>              : </span>
<span id="L487"><span class="lineNum">     487</span>              :       !-----------------------------------------------------------------</span>
<span id="L488"><span class="lineNum">     488</span>              :       ! Compute area and volume to be shifted across each boundary.</span>
<span id="L489"><span class="lineNum">     489</span>              :       !-----------------------------------------------------------------</span>
<span id="L490"><span class="lineNum">     490</span>              : </span>
<span id="L491"><span class="lineNum">     491</span> <span class="tlaGNC">  1273979980 :             donor(n) = 0</span></span>
<span id="L492"><span class="lineNum">     492</span> <span class="tlaGNC">  1273979980 :             daice(n) = c0</span></span>
<span id="L493"><span class="lineNum">     493</span> <span class="tlaGNC">  1621382073 :             dvice(n) = c0</span></span>
<span id="L494"><span class="lineNum">     494</span>              :          enddo</span>
<span id="L495"><span class="lineNum">     495</span>              : </span>
<span id="L496"><span class="lineNum">     496</span> <span class="tlaGNC">  1273979980 :          do n = 1, ncat-1</span></span>
<span id="L497"><span class="lineNum">     497</span>              : </span>
<span id="L498"><span class="lineNum">     498</span> <span class="tlaGNC">  1019913398 :             if (hbnew(n) &gt; hin_max(n)) then ! transfer from n to n+1</span></span>
<span id="L499"><span class="lineNum">     499</span>              : </span>
<span id="L500"><span class="lineNum">     500</span>              :                ! left and right integration limits in eta space</span>
<span id="L501"><span class="lineNum">     501</span> <span class="tlaGNC">   421378020 :                etamin = max(hin_max(n), hL(n)) - hL(n)</span></span>
<span id="L502"><span class="lineNum">     502</span> <span class="tlaGNC">   421378020 :                etamax = min(hbnew(n),   hR(n)) - hL(n)</span></span>
<span id="L503"><span class="lineNum">     503</span> <span class="tlaGNC">   421378020 :                donor(n) = n</span></span>
<span id="L504"><span class="lineNum">     504</span>              : </span>
<span id="L505"><span class="lineNum">     505</span>              :             else             ! hbnew(n) &lt;= hin_max(n); transfer from n+1 to n</span>
<span id="L506"><span class="lineNum">     506</span>              : </span>
<span id="L507"><span class="lineNum">     507</span>              :                ! left and right integration limits in eta space</span>
<span id="L508"><span class="lineNum">     508</span> <span class="tlaGNC">   598535378 :                etamin = c0</span></span>
<span id="L509"><span class="lineNum">     509</span> <span class="tlaGNC">   598535378 :                etamax = min(hin_max(n), hR(n+1)) - hL(n+1)</span></span>
<span id="L510"><span class="lineNum">     510</span> <span class="tlaGNC">   598535378 :                donor(n) = n+1</span></span>
<span id="L511"><span class="lineNum">     511</span>              : </span>
<span id="L512"><span class="lineNum">     512</span>              :             endif            ! hbnew(n) &gt; hin_max(n)</span>
<span id="L513"><span class="lineNum">     513</span>              : </span>
<span id="L514"><span class="lineNum">     514</span> <span class="tlaGNC">  1019913398 :             if (etamax &gt; etamin) then</span></span>
<span id="L515"><span class="lineNum">     515</span> <span class="tlaGNC">   862251547 :                x1  = etamax - etamin</span></span>
<span id="L516"><span class="lineNum">     516</span> <span class="tlaGNC">   862251547 :                wk1 = etamin*etamin</span></span>
<span id="L517"><span class="lineNum">     517</span> <span class="tlaGNC">   862251547 :                wk2 = etamax*etamax</span></span>
<span id="L518"><span class="lineNum">     518</span> <span class="tlaGNC">   862251547 :                x2  = p5 * (wk2 - wk1)</span></span>
<span id="L519"><span class="lineNum">     519</span> <span class="tlaGNC">   862251547 :                wk1 = wk1*etamin</span></span>
<span id="L520"><span class="lineNum">     520</span> <span class="tlaGNC">   862251547 :                wk2 = wk2*etamax</span></span>
<span id="L521"><span class="lineNum">     521</span> <span class="tlaGNC">   862251547 :                x3  = p333 * (wk2 - wk1)</span></span>
<span id="L522"><span class="lineNum">     522</span> <span class="tlaGNC">   862251547 :                nd  = donor(n)</span></span>
<span id="L523"><span class="lineNum">     523</span> <span class="tlaGNC">   862251547 :                daice(n) = g1(nd)*x2 + g0(nd)*x1</span></span>
<span id="L524"><span class="lineNum">     524</span> <span class="tlaGNC">   862251547 :                dvice(n) = g1(nd)*x3 + g0(nd)*x2 + daice(n)*hL(nd)</span></span>
<span id="L525"><span class="lineNum">     525</span>              :             endif               ! etamax &gt; etamin</span>
<span id="L526"><span class="lineNum">     526</span>              : </span>
<span id="L527"><span class="lineNum">     527</span>              :             ! If daice or dvice is very small, shift no ice.</span>
<span id="L528"><span class="lineNum">     528</span>              : </span>
<span id="L529"><span class="lineNum">     529</span> <span class="tlaGNC">  1019913398 :             nd = donor(n)</span></span>
<span id="L530"><span class="lineNum">     530</span>              : </span>
<span id="L531"><span class="lineNum">     531</span> <span class="tlaGNC">  1019913398 :             if (daice(n) &lt; aicen(nd)*puny) then</span></span>
<span id="L532"><span class="lineNum">     532</span> <span class="tlaGNC">   106468928 :                daice(n) = c0</span></span>
<span id="L533"><span class="lineNum">     533</span> <span class="tlaGNC">   106468928 :                dvice(n) = c0</span></span>
<span id="L534"><span class="lineNum">     534</span> <span class="tlaGNC">   106468928 :                donor(n) = 0</span></span>
<span id="L535"><span class="lineNum">     535</span>              :             endif</span>
<span id="L536"><span class="lineNum">     536</span>              : </span>
<span id="L537"><span class="lineNum">     537</span> <span class="tlaGNC">  1019913398 :             if (dvice(n) &lt; vicen(nd)*puny) then</span></span>
<span id="L538"><span class="lineNum">     538</span> <span class="tlaGNC">   106469053 :                daice(n) = c0</span></span>
<span id="L539"><span class="lineNum">     539</span> <span class="tlaGNC">   106469053 :                dvice(n) = c0</span></span>
<span id="L540"><span class="lineNum">     540</span> <span class="tlaGNC">   106469053 :                donor(n) = 0</span></span>
<span id="L541"><span class="lineNum">     541</span>              :             endif</span>
<span id="L542"><span class="lineNum">     542</span>              : </span>
<span id="L543"><span class="lineNum">     543</span>              :             ! If daice is close to aicen or dvice is close to vicen,</span>
<span id="L544"><span class="lineNum">     544</span>              :             ! shift entire category</span>
<span id="L545"><span class="lineNum">     545</span>              : </span>
<span id="L546"><span class="lineNum">     546</span> <span class="tlaGNC">  1019913398 :             if (daice(n) &gt; aicen(nd)*(c1-puny)) then</span></span>
<span id="L547"><span class="lineNum">     547</span> <span class="tlaGNC">      124513 :                daice(n) = aicen(nd)</span></span>
<span id="L548"><span class="lineNum">     548</span> <span class="tlaGNC">      124513 :                dvice(n) = vicen(nd)</span></span>
<span id="L549"><span class="lineNum">     549</span>              :             endif</span>
<span id="L550"><span class="lineNum">     550</span>              : </span>
<span id="L551"><span class="lineNum">     551</span> <span class="tlaGNC">  1273979980 :             if (dvice(n) &gt; vicen(nd)*(c1-puny)) then</span></span>
<span id="L552"><span class="lineNum">     552</span> <span class="tlaGNC">      124513 :                daice(n) = aicen(nd)</span></span>
<span id="L553"><span class="lineNum">     553</span> <span class="tlaGNC">      124513 :                dvice(n) = vicen(nd)</span></span>
<span id="L554"><span class="lineNum">     554</span>              :             endif</span>
<span id="L555"><span class="lineNum">     555</span>              : </span>
<span id="L556"><span class="lineNum">     556</span>              :          enddo                     ! boundaries, 1 to ncat-1</span>
<span id="L557"><span class="lineNum">     557</span>              : </span>
<span id="L558"><span class="lineNum">     558</span>              :       !-----------------------------------------------------------------</span>
<span id="L559"><span class="lineNum">     559</span>              :       ! Shift ice between categories as necessary</span>
<span id="L560"><span class="lineNum">     560</span>              :       !-----------------------------------------------------------------</span>
<span id="L561"><span class="lineNum">     561</span>              : </span>
<span id="L562"><span class="lineNum">     562</span>              :          ! maintain qsno negative definiteness</span>
<span id="L563"><span class="lineNum">     563</span> <span class="tlaGNC">  1528046562 :          do n = 1, ncat</span></span>
<span id="L564"><span class="lineNum">     564</span> <span class="tlaGNC">  2923394472 :             do k = nt_qsno, nt_qsno+nslyr-1</span></span>
<span id="L565"><span class="lineNum">     565</span> <span class="tlaGNC">  2669327890 :                trcrn(k,n) = trcrn(k,n) + rhos*Lfresh</span></span>
<span id="L566"><span class="lineNum">     566</span>              :             enddo</span>
<span id="L567"><span class="lineNum">     567</span>              :          enddo</span>
<span id="L568"><span class="lineNum">     568</span>              :          ! maintain rhos_cmp positive definiteness</span>
<span id="L569"><span class="lineNum">     569</span> <span class="tlaGNC">   254066582 :          if (snwredist(1:3) == 'ITD') then</span></span>
<span id="L570"><span class="lineNum">     570</span> <span class="tlaGNC">     8429160 :             do n = 1, ncat</span></span>
<span id="L571"><span class="lineNum">     571</span> <span class="tlaGNC">    43550660 :                do k = nt_rhos, nt_rhos+nslyr-1</span></span>
<span id="L572"><span class="lineNum">     572</span> <span class="tlaGNC">    42145800 :                   trcrn(k,n) = max(trcrn(k,n)-rhosmin, c0)</span></span>
<span id="L573"><span class="lineNum">     573</span>              : !                  trcrn(k,n) = trcrn(k,n) - rhosmin</span>
<span id="L574"><span class="lineNum">     574</span>              :                enddo</span>
<span id="L575"><span class="lineNum">     575</span>              :             enddo</span>
<span id="L576"><span class="lineNum">     576</span>              :          endif</span>
<span id="L577"><span class="lineNum">     577</span>              : </span>
<span id="L578"><span class="lineNum">     578</span> <span class="tlaUNC tlaBgUNC">           0 :          call shift_ice (trcr_depend,           &amp;</span></span>
<span id="L579"><span class="lineNum">     579</span> <span class="tlaUNC">           0 :                          trcr_base,             &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L580"><span class="lineNum">     580</span> <span class="tlaUNC">           0 :                          n_trcr_strata,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L581"><span class="lineNum">     581</span> <span class="tlaUNC">           0 :                          nt_strata,             &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L582"><span class="lineNum">     582</span> <span class="tlaUNC">           0 :                          aicen,    trcrn,       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L583"><span class="lineNum">     583</span> <span class="tlaUNC">           0 :                          vicen,    vsnon,       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L584"><span class="lineNum">     584</span> <span class="tlaUNC">           0 :                          hicen,    donor,       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L585"><span class="lineNum">     585</span> <span class="tlaGNC tlaBgGNC">   254066582 :                          daice,    dvice, Tf    )</span></span>
<span id="L586"><span class="lineNum">     586</span> <span class="tlaGNC">   254066582 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L587"><span class="lineNum">     587</span>              : </span>
<span id="L588"><span class="lineNum">     588</span>              :          ! maintain qsno negative definiteness</span>
<span id="L589"><span class="lineNum">     589</span> <span class="tlaGNC">  1528046562 :          do n = 1, ncat</span></span>
<span id="L590"><span class="lineNum">     590</span> <span class="tlaGNC">  2923394472 :             do k = nt_qsno, nt_qsno+nslyr-1</span></span>
<span id="L591"><span class="lineNum">     591</span> <span class="tlaGNC">  2669327890 :                trcrn(k,n) = trcrn(k,n) - rhos*Lfresh</span></span>
<span id="L592"><span class="lineNum">     592</span>              :             enddo</span>
<span id="L593"><span class="lineNum">     593</span>              :          enddo</span>
<span id="L594"><span class="lineNum">     594</span>              :          ! maintain rhos_cmp positive definiteness</span>
<span id="L595"><span class="lineNum">     595</span> <span class="tlaGNC">   254066582 :          if (snwredist(1:3) == 'ITD') then</span></span>
<span id="L596"><span class="lineNum">     596</span> <span class="tlaGNC">     8429160 :             do n = 1, ncat</span></span>
<span id="L597"><span class="lineNum">     597</span> <span class="tlaGNC">    43550660 :                do k = nt_rhos, nt_rhos+nslyr-1</span></span>
<span id="L598"><span class="lineNum">     598</span> <span class="tlaGNC">    42145800 :                   trcrn(k,n) = trcrn(k,n) + rhosmin</span></span>
<span id="L599"><span class="lineNum">     599</span>              :                enddo</span>
<span id="L600"><span class="lineNum">     600</span>              :             enddo</span>
<span id="L601"><span class="lineNum">     601</span>              :          endif</span>
<span id="L602"><span class="lineNum">     602</span>              : </span>
<span id="L603"><span class="lineNum">     603</span>              :       !-----------------------------------------------------------------</span>
<span id="L604"><span class="lineNum">     604</span>              :       ! Make sure hice(1) &gt;= minimum ice thickness hi_min.</span>
<span id="L605"><span class="lineNum">     605</span>              :       !-----------------------------------------------------------------</span>
<span id="L606"><span class="lineNum">     606</span>              : </span>
<span id="L607"><span class="lineNum">     607</span> <span class="tlaGNC">   254066582 :          if (hi_min &gt; c0 .and. aicen(1) &gt; puny .and. hicen(1) &lt; hi_min) then</span></span>
<span id="L608"><span class="lineNum">     608</span>              : </span>
<span id="L609"><span class="lineNum">     609</span> <span class="tlaGNC">      586240 :             da0 = aicen(1) * (c1 - hicen(1)/hi_min)</span></span>
<span id="L610"><span class="lineNum">     610</span> <span class="tlaGNC">      586240 :             aicen(1) = aicen(1) - da0</span></span>
<span id="L611"><span class="lineNum">     611</span> <span class="tlaGNC">      586240 :             hicen(1) = hi_min</span></span>
<span id="L612"><span class="lineNum">     612</span>              : </span>
<span id="L613"><span class="lineNum">     613</span> <span class="tlaGNC">      586240 :             if (tr_pond_topo) &amp;</span></span>
<span id="L614"><span class="lineNum">     614</span> <span class="tlaGNC">        7362 :                fpond = fpond - (da0 * trcrn(nt_apnd,1) &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L615"><span class="lineNum">     615</span> <span class="tlaGNC">       14724 :                                     * trcrn(nt_hpnd,1))</span></span>
<span id="L616"><span class="lineNum">     616</span>              :          endif</span>
<span id="L617"><span class="lineNum">     617</span>              : </span>
<span id="L618"><span class="lineNum">     618</span>              :       endif ! remap_flag</span>
<span id="L619"><span class="lineNum">     619</span>              : </span>
<span id="L620"><span class="lineNum">     620</span>              :       !-----------------------------------------------------------------</span>
<span id="L621"><span class="lineNum">     621</span>              :       ! Update fractional ice area in each grid cell.</span>
<span id="L622"><span class="lineNum">     622</span>              :       !-----------------------------------------------------------------</span>
<span id="L623"><span class="lineNum">     623</span>              : </span>
<span id="L624"><span class="lineNum">     624</span> <span class="tlaGNC">   254098382 :       call aggregate_area (aicen, aice, aice0)</span></span>
<span id="L625"><span class="lineNum">     625</span> <span class="tlaGNC">   254098382 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L626"><span class="lineNum">     626</span>              : </span>
<span id="L627"><span class="lineNum">     627</span>              :       !-----------------------------------------------------------------</span>
<span id="L628"><span class="lineNum">     628</span>              :       ! Check volume and energy conservation.</span>
<span id="L629"><span class="lineNum">     629</span>              :       !-----------------------------------------------------------------</span>
<span id="L630"><span class="lineNum">     630</span>              : </span>
<span id="L631"><span class="lineNum">     631</span> <span class="tlaGNC">   254098382 :       if (conserv_check) then</span></span>
<span id="L632"><span class="lineNum">     632</span>              : </span>
<span id="L633"><span class="lineNum">     633</span> <span class="tlaGNC">    15378160 :       do n = 1, ncat</span></span>
<span id="L634"><span class="lineNum">     634</span>              : </span>
<span id="L635"><span class="lineNum">     635</span> <span class="tlaGNC">    13181280 :          eicen(n) = c0</span></span>
<span id="L636"><span class="lineNum">     636</span> <span class="tlaGNC">    13181280 :          esnon(n) = c0</span></span>
<span id="L637"><span class="lineNum">     637</span> <span class="tlaGNC">    13181280 :          vbrin(n) = c0</span></span>
<span id="L638"><span class="lineNum">     638</span> <span class="tlaGNC">    13181280 :          sicen(n) = c0</span></span>
<span id="L639"><span class="lineNum">     639</span>              : </span>
<span id="L640"><span class="lineNum">     640</span> <span class="tlaGNC">   105450240 :          do k = 1, nilyr</span></span>
<span id="L641"><span class="lineNum">     641</span> <span class="tlaGNC">   127860768 :             eicen(n) = eicen(n) + trcrn(nt_qice+k-1,n) &amp;</span></span>
<span id="L642"><span class="lineNum">     642</span> <span class="tlaGNC">   233311008 :                      * vicen(n)/real(nilyr,kind=dbl_kind)</span></span>
<span id="L643"><span class="lineNum">     643</span>              :          enddo</span>
<span id="L644"><span class="lineNum">     644</span> <span class="tlaGNC">    26362560 :          do k = 1, nslyr</span></span>
<span id="L645"><span class="lineNum">     645</span> <span class="tlaGNC">    18265824 :             esnon(n) = esnon(n) + trcrn(nt_qsno+k-1,n) &amp;</span></span>
<span id="L646"><span class="lineNum">     646</span> <span class="tlaGNC">    44628384 :                      * vsnon(n)/real(nslyr,kind=dbl_kind)</span></span>
<span id="L647"><span class="lineNum">     647</span>              :          enddo</span>
<span id="L648"><span class="lineNum">     648</span>              : </span>
<span id="L649"><span class="lineNum">     649</span> <span class="tlaGNC">    13181280 :          if (tr_brine) then</span></span>
<span id="L650"><span class="lineNum">     650</span> <span class="tlaUNC tlaBgUNC">           0 :             vbrin(n) = vbrin(n) + trcrn(nt_fbri,n) &amp;</span></span>
<span id="L651"><span class="lineNum">     651</span> <span class="tlaUNC">           0 :                      * vicen(n)</span></span>
<span id="L652"><span class="lineNum">     652</span>              :          endif</span>
<span id="L653"><span class="lineNum">     653</span>              : </span>
<span id="L654"><span class="lineNum">     654</span> <span class="tlaGNC tlaBgGNC">   107647120 :          do k = 1, nilyr</span></span>
<span id="L655"><span class="lineNum">     655</span> <span class="tlaGNC">   127860768 :             sicen(n) = sicen(n) + trcrn(nt_sice+k-1,n) &amp;</span></span>
<span id="L656"><span class="lineNum">     656</span> <span class="tlaGNC">   233311008 :                      * vicen(n)/real(nilyr,kind=dbl_kind)</span></span>
<span id="L657"><span class="lineNum">     657</span>              :          enddo</span>
<span id="L658"><span class="lineNum">     658</span>              : </span>
<span id="L659"><span class="lineNum">     659</span>              :       enddo ! n</span>
<span id="L660"><span class="lineNum">     660</span>              : </span>
<span id="L661"><span class="lineNum">     661</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, vicen, vice_final)</span></span>
<span id="L662"><span class="lineNum">     662</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L663"><span class="lineNum">     663</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, vsnon, vsno_final)</span></span>
<span id="L664"><span class="lineNum">     664</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L665"><span class="lineNum">     665</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, eicen, eice_final)</span></span>
<span id="L666"><span class="lineNum">     666</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L667"><span class="lineNum">     667</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, esnon, esno_final)</span></span>
<span id="L668"><span class="lineNum">     668</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L669"><span class="lineNum">     669</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, sicen, sice_final)</span></span>
<span id="L670"><span class="lineNum">     670</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L671"><span class="lineNum">     671</span> <span class="tlaGNC">     2196880 :       call column_sum (ncat, vbrin, vbri_final)</span></span>
<span id="L672"><span class="lineNum">     672</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L673"><span class="lineNum">     673</span>              : </span>
<span id="L674"><span class="lineNum">     674</span> <span class="tlaGNC">     2196880 :       fieldid = subname//':vice'</span></span>
<span id="L675"><span class="lineNum">     675</span>              :       call column_conservation_check (fieldid,               &amp;</span>
<span id="L676"><span class="lineNum">     676</span>              :                                       vice_init, vice_final, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L677"><span class="lineNum">     677</span> <span class="tlaGNC">     2196880 :                                       puny)</span></span>
<span id="L678"><span class="lineNum">     678</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L679"><span class="lineNum">     679</span> <span class="tlaGNC">     2196880 :       fieldid = subname//':vsno'</span></span>
<span id="L680"><span class="lineNum">     680</span>              :       call column_conservation_check (fieldid,               &amp;</span>
<span id="L681"><span class="lineNum">     681</span>              :                                       vsno_init, vsno_final, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L682"><span class="lineNum">     682</span> <span class="tlaGNC">     2196880 :                                       puny)</span></span>
<span id="L683"><span class="lineNum">     683</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L684"><span class="lineNum">     684</span> <span class="tlaGNC">     2196880 :       fieldid = subname//':eice'</span></span>
<span id="L685"><span class="lineNum">     685</span>              :       call column_conservation_check (fieldid,               &amp;</span>
<span id="L686"><span class="lineNum">     686</span>              :                                       eice_init, eice_final, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L687"><span class="lineNum">     687</span> <span class="tlaGNC">     2196880 :                                       puny*Lfresh*rhoi)</span></span>
<span id="L688"><span class="lineNum">     688</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L689"><span class="lineNum">     689</span> <span class="tlaGNC">     2196880 :       fieldid = subname//':esno'</span></span>
<span id="L690"><span class="lineNum">     690</span>              :       call column_conservation_check (fieldid,               &amp;</span>
<span id="L691"><span class="lineNum">     691</span>              :                                       esno_init, esno_final, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L692"><span class="lineNum">     692</span> <span class="tlaGNC">     2196880 :                                       puny*Lfresh*rhos)</span></span>
<span id="L693"><span class="lineNum">     693</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L694"><span class="lineNum">     694</span> <span class="tlaGNC">     2196880 :       fieldid = subname//':sicen'</span></span>
<span id="L695"><span class="lineNum">     695</span>              :       call column_conservation_check (fieldid,               &amp;</span>
<span id="L696"><span class="lineNum">     696</span>              :                                       sice_init, sice_final, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L697"><span class="lineNum">     697</span> <span class="tlaGNC">     2196880 :                                       puny)</span></span>
<span id="L698"><span class="lineNum">     698</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L699"><span class="lineNum">     699</span> <span class="tlaGNC">     2196880 :       fieldid = subname//':vbrin'</span></span>
<span id="L700"><span class="lineNum">     700</span>              :       call column_conservation_check (fieldid,               &amp;</span>
<span id="L701"><span class="lineNum">     701</span>              :                                       vbri_init, vbri_final, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L702"><span class="lineNum">     702</span> <span class="tlaGNC">     2196880 :                                       puny*c10)</span></span>
<span id="L703"><span class="lineNum">     703</span> <span class="tlaGNC">     2196880 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L704"><span class="lineNum">     704</span>              : </span>
<span id="L705"><span class="lineNum">     705</span>              :       endif                     ! conservation check</span>
<span id="L706"><span class="lineNum">     706</span>              : </span>
<span id="L707"><span class="lineNum">     707</span>              :       end subroutine linear_itd</span>
<span id="L708"><span class="lineNum">     708</span>              : </span>
<span id="L709"><span class="lineNum">     709</span>              : !=======================================================================</span>
<span id="L710"><span class="lineNum">     710</span>              : !</span>
<span id="L711"><span class="lineNum">     711</span>              : ! Fit g(h) with a line, satisfying area and volume constraints.</span>
<span id="L712"><span class="lineNum">     712</span>              : ! To reduce roundoff errors caused by large values of g0 and g1,</span>
<span id="L713"><span class="lineNum">     713</span>              : ! we actually compute g(eta), where eta = h - hL, and hL is the</span>
<span id="L714"><span class="lineNum">     714</span>              : ! left boundary.</span>
<span id="L715"><span class="lineNum">     715</span>              : !</span>
<span id="L716"><span class="lineNum">     716</span>              : ! authors: William H. Lipscomb, LANL</span>
<span id="L717"><span class="lineNum">     717</span>              : !          Elizabeth C. Hunke, LANL</span>
<span id="L718"><span class="lineNum">     718</span>              : </span>
<span id="L719"><span class="lineNum">     719</span> <span class="tlaGNC">  1528046562 :       subroutine fit_line (aicen,    hice,            &amp;</span></span>
<span id="L720"><span class="lineNum">     720</span>              :                            hbL,      hbR,             &amp;   ! LCOV_EXCL_LINE</span>
<span id="L721"><span class="lineNum">     721</span>              :                            g0,       g1,              &amp;   ! LCOV_EXCL_LINE</span>
<span id="L722"><span class="lineNum">     722</span>              :                            hL,       hR)</span>
<span id="L723"><span class="lineNum">     723</span>              : </span>
<span id="L724"><span class="lineNum">     724</span>              :       real (kind=dbl_kind), intent(in) :: &amp;</span>
<span id="L725"><span class="lineNum">     725</span>              :          aicen           ! concentration of ice</span>
<span id="L726"><span class="lineNum">     726</span>              : </span>
<span id="L727"><span class="lineNum">     727</span>              :       real (kind=dbl_kind), intent(in) :: &amp;</span>
<span id="L728"><span class="lineNum">     728</span>              :          hbL, hbR    , &amp; ! left and right category boundaries   ! LCOV_EXCL_LINE</span>
<span id="L729"><span class="lineNum">     729</span>              :          hice            ! ice thickness</span>
<span id="L730"><span class="lineNum">     730</span>              : </span>
<span id="L731"><span class="lineNum">     731</span>              :       real (kind=dbl_kind), intent(out):: &amp;</span>
<span id="L732"><span class="lineNum">     732</span>              :          g0, g1      , &amp; ! coefficients in linear equation for g(eta)   ! LCOV_EXCL_LINE</span>
<span id="L733"><span class="lineNum">     733</span>              :          hL          , &amp; ! min value of range over which g(h) &gt; 0   ! LCOV_EXCL_LINE</span>
<span id="L734"><span class="lineNum">     734</span>              :          hR              ! max value of range over which g(h) &gt; 0</span>
<span id="L735"><span class="lineNum">     735</span>              : </span>
<span id="L736"><span class="lineNum">     736</span>              :       ! local variables</span>
<span id="L737"><span class="lineNum">     737</span>              : </span>
<span id="L738"><span class="lineNum">     738</span>              :       real  (kind=dbl_kind) :: &amp;</span>
<span id="L739"><span class="lineNum">     739</span> <span class="tlaGNC">   111833042 :          h13         , &amp; ! hbL + 1/3 * (hbR - hbL)   ! LCOV_EXCL_LINE</span></span>
<span id="L740"><span class="lineNum">     740</span> <span class="tlaGNC">   111833042 :          h23         , &amp; ! hbL + 2/3 * (hbR - hbL)   ! LCOV_EXCL_LINE</span></span>
<span id="L741"><span class="lineNum">     741</span> <span class="tlaGNC">   111833042 :          dhr         , &amp; ! 1 / (hR - hL)   ! LCOV_EXCL_LINE</span></span>
<span id="L742"><span class="lineNum">     742</span> <span class="tlaGNC">   111833042 :          wk1, wk2        ! temporary variables</span></span>
<span id="L743"><span class="lineNum">     743</span>              : </span>
<span id="L744"><span class="lineNum">     744</span>              :       character(len=*),parameter :: subname='(fit_line)'</span>
<span id="L745"><span class="lineNum">     745</span>              : </span>
<span id="L746"><span class="lineNum">     746</span>              :       !-----------------------------------------------------------------</span>
<span id="L747"><span class="lineNum">     747</span>              :       ! Compute g0, g1, hL, and hR for each category to be remapped.</span>
<span id="L748"><span class="lineNum">     748</span>              :       !-----------------------------------------------------------------</span>
<span id="L749"><span class="lineNum">     749</span>              : </span>
<span id="L750"><span class="lineNum">     750</span> <span class="tlaGNC">  1528046562 :          if (aicen &gt; puny .and. hbR - hbL &gt; puny) then</span></span>
<span id="L751"><span class="lineNum">     751</span>              : </span>
<span id="L752"><span class="lineNum">     752</span>              :          ! Initialize hL and hR</span>
<span id="L753"><span class="lineNum">     753</span>              : </span>
<span id="L754"><span class="lineNum">     754</span> <span class="tlaGNC">  1471517682 :             hL = hbL</span></span>
<span id="L755"><span class="lineNum">     755</span> <span class="tlaGNC">  1471517682 :             hR = hbR</span></span>
<span id="L756"><span class="lineNum">     756</span>              : </span>
<span id="L757"><span class="lineNum">     757</span>              :          ! Change hL or hR if hicen(n) falls outside central third of range</span>
<span id="L758"><span class="lineNum">     758</span>              : </span>
<span id="L759"><span class="lineNum">     759</span> <span class="tlaGNC">  1471517682 :             h13 = p333 * (c2*hL + hR)</span></span>
<span id="L760"><span class="lineNum">     760</span> <span class="tlaGNC">  1471517682 :             h23 = p333 * (hL + c2*hR)</span></span>
<span id="L761"><span class="lineNum">     761</span> <span class="tlaGNC">  1471517682 :             if (hice &lt; h13) then</span></span>
<span id="L762"><span class="lineNum">     762</span> <span class="tlaGNC">   249085000 :                hR = c3*hice - c2*hL</span></span>
<span id="L763"><span class="lineNum">     763</span> <span class="tlaGNC">  1222432682 :             elseif (hice &gt; h23) then</span></span>
<span id="L764"><span class="lineNum">     764</span> <span class="tlaGNC">   131272332 :                hL = c3*hice - c2*hR</span></span>
<span id="L765"><span class="lineNum">     765</span>              :             endif</span>
<span id="L766"><span class="lineNum">     766</span>              : </span>
<span id="L767"><span class="lineNum">     767</span>              :          ! Compute coefficients of g(eta) = g0 + g1*eta</span>
<span id="L768"><span class="lineNum">     768</span>              : </span>
<span id="L769"><span class="lineNum">     769</span> <span class="tlaGNC">  1471517682 :             dhr = c1 / (hR - hL)</span></span>
<span id="L770"><span class="lineNum">     770</span> <span class="tlaGNC">  1471517682 :             wk1 = c6 * aicen * dhr</span></span>
<span id="L771"><span class="lineNum">     771</span> <span class="tlaGNC">  1471517682 :             wk2 = (hice - hL) * dhr</span></span>
<span id="L772"><span class="lineNum">     772</span> <span class="tlaGNC">  1471517682 :             g0 = wk1 * (p666 - wk2)</span></span>
<span id="L773"><span class="lineNum">     773</span> <span class="tlaGNC">  1471517682 :             g1 = c2*dhr * wk1 * (wk2 - p5)</span></span>
<span id="L774"><span class="lineNum">     774</span>              : </span>
<span id="L775"><span class="lineNum">     775</span>              :          else</span>
<span id="L776"><span class="lineNum">     776</span>              : </span>
<span id="L777"><span class="lineNum">     777</span> <span class="tlaGNC">    56528880 :             g0 = c0</span></span>
<span id="L778"><span class="lineNum">     778</span> <span class="tlaGNC">    56528880 :             g1 = c0</span></span>
<span id="L779"><span class="lineNum">     779</span> <span class="tlaGNC">    56528880 :             hL = c0</span></span>
<span id="L780"><span class="lineNum">     780</span> <span class="tlaGNC">    56528880 :             hR = c0</span></span>
<span id="L781"><span class="lineNum">     781</span>              : </span>
<span id="L782"><span class="lineNum">     782</span>              :          endif                  ! aicen &gt; puny</span>
<span id="L783"><span class="lineNum">     783</span>              : </span>
<span id="L784"><span class="lineNum">     784</span> <span class="tlaGNC">  1528046562 :       end subroutine fit_line</span></span>
<span id="L785"><span class="lineNum">     785</span>              : </span>
<span id="L786"><span class="lineNum">     786</span>              : !=======================================================================</span>
<span id="L787"><span class="lineNum">     787</span>              : !</span>
<span id="L788"><span class="lineNum">     788</span>              : ! Given some added new ice to the base of the existing ice, recalculate</span>
<span id="L789"><span class="lineNum">     789</span>              : ! vertical tracer so that new grid cells are all the same size.</span>
<span id="L790"><span class="lineNum">     790</span>              : !</span>
<span id="L791"><span class="lineNum">     791</span>              : ! author: A. K. Turner, LANL</span>
<span id="L792"><span class="lineNum">     792</span>              : !</span>
<span id="L793"><span class="lineNum">     793</span> <span class="tlaGNC">   698327800 :       subroutine update_vertical_tracers(trc, h1, h2, trc0)</span></span>
<span id="L794"><span class="lineNum">     794</span>              : </span>
<span id="L795"><span class="lineNum">     795</span>              :       real (kind=dbl_kind), dimension(:), intent(inout) :: &amp;</span>
<span id="L796"><span class="lineNum">     796</span>              :            trc ! vertical tracer</span>
<span id="L797"><span class="lineNum">     797</span>              : </span>
<span id="L798"><span class="lineNum">     798</span>              :       real (kind=dbl_kind), intent(in) :: &amp;</span>
<span id="L799"><span class="lineNum">     799</span>              :          h1, &amp; ! old thickness   ! LCOV_EXCL_LINE</span>
<span id="L800"><span class="lineNum">     800</span>              :          h2, &amp; ! new thickness   ! LCOV_EXCL_LINE</span>
<span id="L801"><span class="lineNum">     801</span>              :          trc0  ! tracer value of added ice on ice bottom</span>
<span id="L802"><span class="lineNum">     802</span>              : </span>
<span id="L803"><span class="lineNum">     803</span>              :       ! local variables</span>
<span id="L804"><span class="lineNum">     804</span>              : </span>
<span id="L805"><span class="lineNum">     805</span> <span class="tlaGNC">  1565350532 :       real(kind=dbl_kind), dimension(nilyr) :: trc2 ! updated tracer temporary</span></span>
<span id="L806"><span class="lineNum">     806</span>              : </span>
<span id="L807"><span class="lineNum">     807</span>              :       ! vertical indices for old and new grid</span>
<span id="L808"><span class="lineNum">     808</span>              :       integer :: k1, k2</span>
<span id="L809"><span class="lineNum">     809</span>              : </span>
<span id="L810"><span class="lineNum">     810</span>              :       real (kind=dbl_kind) :: &amp;</span>
<span id="L811"><span class="lineNum">     811</span> <span class="tlaGNC">    28115822 :          z1a, z1b, &amp; ! upper, lower boundary of old cell/added new ice at bottom   ! LCOV_EXCL_LINE</span></span>
<span id="L812"><span class="lineNum">     812</span> <span class="tlaGNC">    28115822 :          z2a, z2b, &amp; ! upper, lower boundary of new cell   ! LCOV_EXCL_LINE</span></span>
<span id="L813"><span class="lineNum">     813</span> <span class="tlaGNC">    28115822 :          overlap , &amp; ! overlap between old and new cell   ! LCOV_EXCL_LINE</span></span>
<span id="L814"><span class="lineNum">     814</span> <span class="tlaGNC">    28115822 :          rnilyr</span></span>
<span id="L815"><span class="lineNum">     815</span>              : </span>
<span id="L816"><span class="lineNum">     816</span>              :       character(len=*),parameter :: subname='(update_vertical_tracers)'</span>
<span id="L817"><span class="lineNum">     817</span>              : </span>
<span id="L818"><span class="lineNum">     818</span> <span class="tlaGNC">   698327800 :         rnilyr = real(nilyr,dbl_kind)</span></span>
<span id="L819"><span class="lineNum">     819</span>              : </span>
<span id="L820"><span class="lineNum">     820</span>              :         ! loop over new grid cells</span>
<span id="L821"><span class="lineNum">     821</span> <span class="tlaGNC">  5586622400 :         do k2 = 1, nilyr</span></span>
<span id="L822"><span class="lineNum">     822</span>              : </span>
<span id="L823"><span class="lineNum">     823</span>              :            ! initialize new tracer</span>
<span id="L824"><span class="lineNum">     824</span> <span class="tlaGNC">  4888294600 :            trc2(k2) = c0</span></span>
<span id="L825"><span class="lineNum">     825</span>              : </span>
<span id="L826"><span class="lineNum">     826</span>              :            ! calculate upper and lower boundary of new cell</span>
<span id="L827"><span class="lineNum">     827</span> <span class="tlaGNC">  4888294600 :            z2a = ((k2 - 1) * h2) / rnilyr</span></span>
<span id="L828"><span class="lineNum">     828</span> <span class="tlaGNC">  4888294600 :            z2b = (k2       * h2) / rnilyr</span></span>
<span id="L829"><span class="lineNum">     829</span>              : </span>
<span id="L830"><span class="lineNum">     830</span>              :            ! loop over old grid cells</span>
<span id="L831"><span class="lineNum">     831</span> <span class="tlaGNC"> 39106356800 :            do k1 = 1, nilyr</span></span>
<span id="L832"><span class="lineNum">     832</span>              : </span>
<span id="L833"><span class="lineNum">     833</span>              :               ! calculate upper and lower boundary of old cell</span>
<span id="L834"><span class="lineNum">     834</span> <span class="tlaGNC"> 34218062200 :               z1a = ((k1 - 1) * h1) / rnilyr</span></span>
<span id="L835"><span class="lineNum">     835</span> <span class="tlaGNC"> 34218062200 :               z1b = (k1       * h1) / rnilyr</span></span>
<span id="L836"><span class="lineNum">     836</span>              : </span>
<span id="L837"><span class="lineNum">     837</span>              :               ! calculate overlap between old and new cell</span>
<span id="L838"><span class="lineNum">     838</span> <span class="tlaGNC"> 34218062200 :               overlap = max(min(z1b, z2b) - max(z1a, z2a), c0)</span></span>
<span id="L839"><span class="lineNum">     839</span>              : </span>
<span id="L840"><span class="lineNum">     840</span>              :               ! aggregate old grid cell contribution to new cell</span>
<span id="L841"><span class="lineNum">     841</span> <span class="tlaGNC"> 39106356800 :               trc2(k2) = trc2(k2) + overlap * trc(k1)</span></span>
<span id="L842"><span class="lineNum">     842</span>              : </span>
<span id="L843"><span class="lineNum">     843</span>              :            enddo ! k1</span>
<span id="L844"><span class="lineNum">     844</span>              : </span>
<span id="L845"><span class="lineNum">     845</span>              :            ! calculate upper and lower boundary of added new ice at bottom</span>
<span id="L846"><span class="lineNum">     846</span> <span class="tlaGNC">  4888294600 :            z1a = h1</span></span>
<span id="L847"><span class="lineNum">     847</span> <span class="tlaGNC">  4888294600 :            z1b = h2</span></span>
<span id="L848"><span class="lineNum">     848</span>              : </span>
<span id="L849"><span class="lineNum">     849</span>              :            ! calculate overlap between added ice and new cell</span>
<span id="L850"><span class="lineNum">     850</span> <span class="tlaGNC">  4888294600 :            overlap = max(min(z1b, z2b) - max(z1a, z2a), c0)</span></span>
<span id="L851"><span class="lineNum">     851</span>              :            ! aggregate added ice contribution to new cell</span>
<span id="L852"><span class="lineNum">     852</span> <span class="tlaGNC">  4888294600 :            trc2(k2) = trc2(k2) + overlap * trc0</span></span>
<span id="L853"><span class="lineNum">     853</span>              :            ! renormalize new grid cell</span>
<span id="L854"><span class="lineNum">     854</span> <span class="tlaGNC">  5586622400 :            trc2(k2) = (rnilyr * trc2(k2)) / h2</span></span>
<span id="L855"><span class="lineNum">     855</span>              : </span>
<span id="L856"><span class="lineNum">     856</span>              :         enddo ! k2</span>
<span id="L857"><span class="lineNum">     857</span>              : </span>
<span id="L858"><span class="lineNum">     858</span>              :         ! update vertical tracer array with the adjusted tracer</span>
<span id="L859"><span class="lineNum">     859</span> <span class="tlaGNC">  5586622400 :         trc = trc2</span></span>
<span id="L860"><span class="lineNum">     860</span>              : </span>
<span id="L861"><span class="lineNum">     861</span> <span class="tlaGNC">   698327800 :       end subroutine update_vertical_tracers</span></span>
<span id="L862"><span class="lineNum">     862</span>              : </span>
<span id="L863"><span class="lineNum">     863</span>              : !=======================================================================</span>
<span id="L864"><span class="lineNum">     864</span>              : !</span>
<span id="L865"><span class="lineNum">     865</span>              : ! Given the fraction of ice melting laterally in each grid cell</span>
<span id="L866"><span class="lineNum">     866</span>              : !  (computed in subroutine frzmlt_bottom_lateral), melt ice.</span>
<span id="L867"><span class="lineNum">     867</span>              : !</span>
<span id="L868"><span class="lineNum">     868</span>              : ! author: C. M. Bitz, UW</span>
<span id="L869"><span class="lineNum">     869</span>              : ! 2003:   Modified by William H. Lipscomb and Elizabeth C. Hunke, LANL</span>
<span id="L870"><span class="lineNum">     870</span>              : ! 2016    Lettie Roach, NIWA/VUW, added floe size dependence</span>
<span id="L871"><span class="lineNum">     871</span>              : !</span>
<span id="L872"><span class="lineNum">     872</span> <span class="tlaGNC">  1207816920 :       subroutine lateral_melt (dt,         fpond,      &amp;</span></span>
<span id="L873"><span class="lineNum">     873</span>              :                                fresh,      fsalt,      &amp;   ! LCOV_EXCL_LINE</span>
<span id="L874"><span class="lineNum">     874</span> <span class="tlaUNC tlaBgUNC">           0 :                                fhocn,      faero_ocn,  &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L875"><span class="lineNum">     875</span> <span class="tlaGNC tlaBgGNC">  1207816920 :                                fiso_ocn,               &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L876"><span class="lineNum">     876</span> <span class="tlaGNC">  1207816920 :                                rsiden,     meltl,      &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L877"><span class="lineNum">     877</span>              :                                wlat,                   &amp;   ! LCOV_EXCL_LINE</span>
<span id="L878"><span class="lineNum">     878</span> <span class="tlaGNC">  2415633840 :                                aicen,      vicen,      &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L879"><span class="lineNum">     879</span> <span class="tlaGNC">  1207816920 :                                vsnon,      trcrn,      &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L880"><span class="lineNum">     880</span> <span class="tlaGNC">  1207816920 :                                flux_bio,   d_afsd_latm)</span></span>
<span id="L881"><span class="lineNum">     881</span>              : </span>
<span id="L882"><span class="lineNum">     882</span>              :       real (kind=dbl_kind), intent(in) :: &amp;</span>
<span id="L883"><span class="lineNum">     883</span>              :          dt        ! time step (s)</span>
<span id="L884"><span class="lineNum">     884</span>              : </span>
<span id="L885"><span class="lineNum">     885</span>              :       real (kind=dbl_kind), dimension (:), intent(inout) :: &amp;</span>
<span id="L886"><span class="lineNum">     886</span>              :          aicen   , &amp; ! concentration of ice   ! LCOV_EXCL_LINE</span>
<span id="L887"><span class="lineNum">     887</span>              :          vicen   , &amp; ! volume per unit area of ice          (m)   ! LCOV_EXCL_LINE</span>
<span id="L888"><span class="lineNum">     888</span>              :          vsnon       ! volume per unit area of snow         (m)</span>
<span id="L889"><span class="lineNum">     889</span>              : </span>
<span id="L890"><span class="lineNum">     890</span>              :       real (kind=dbl_kind), dimension (:,:), intent(inout) :: &amp;</span>
<span id="L891"><span class="lineNum">     891</span>              :          trcrn       ! tracer array</span>
<span id="L892"><span class="lineNum">     892</span>              : </span>
<span id="L893"><span class="lineNum">     893</span>              :       real (kind=dbl_kind), dimension (:), intent(in) :: &amp;</span>
<span id="L894"><span class="lineNum">     894</span>              :          rsiden       ! fraction of ice that melts laterally</span>
<span id="L895"><span class="lineNum">     895</span>              : </span>
<span id="L896"><span class="lineNum">     896</span>              :       real (kind=dbl_kind), intent(in), optional :: &amp;</span>
<span id="L897"><span class="lineNum">     897</span>              :          wlat        ! lateral melt rate (m/s)</span>
<span id="L898"><span class="lineNum">     898</span>              : </span>
<span id="L899"><span class="lineNum">     899</span>              :       real (kind=dbl_kind), intent(inout) :: &amp;</span>
<span id="L900"><span class="lineNum">     900</span>              :          fpond     , &amp; ! fresh water flux to ponds (kg/m^2/s)   ! LCOV_EXCL_LINE</span>
<span id="L901"><span class="lineNum">     901</span>              :          fresh     , &amp; ! fresh water flux to ocean (kg/m^2/s)   ! LCOV_EXCL_LINE</span>
<span id="L902"><span class="lineNum">     902</span>              :          fsalt     , &amp; ! salt flux to ocean (kg/m^2/s)   ! LCOV_EXCL_LINE</span>
<span id="L903"><span class="lineNum">     903</span>              :          fhocn     , &amp; ! net heat flux to ocean (W/m^2)   ! LCOV_EXCL_LINE</span>
<span id="L904"><span class="lineNum">     904</span>              :          meltl         ! lateral ice melt         (m/step--&gt;cm/day)</span>
<span id="L905"><span class="lineNum">     905</span>              : </span>
<span id="L906"><span class="lineNum">     906</span>              :       real (kind=dbl_kind), dimension(nbtrcr), intent(inout) :: &amp;</span>
<span id="L907"><span class="lineNum">     907</span>              :          flux_bio  ! biology tracer flux from layer bgc (mmol/m^2/s)</span>
<span id="L908"><span class="lineNum">     908</span>              : </span>
<span id="L909"><span class="lineNum">     909</span>              :       real (kind=dbl_kind), dimension(:), intent(inout) :: &amp;</span>
<span id="L910"><span class="lineNum">     910</span>              :          faero_ocn     ! aerosol flux to ocean (kg/m^2/s)</span>
<span id="L911"><span class="lineNum">     911</span>              : </span>
<span id="L912"><span class="lineNum">     912</span>              :       real (kind=dbl_kind), dimension(:), intent(inout), optional :: &amp;</span>
<span id="L913"><span class="lineNum">     913</span>              :          fiso_ocn     ! isotope flux to ocean (kg/m^2/s)</span>
<span id="L914"><span class="lineNum">     914</span>              : </span>
<span id="L915"><span class="lineNum">     915</span>              :       real (kind=dbl_kind), dimension (:), intent(out), optional :: &amp;</span>
<span id="L916"><span class="lineNum">     916</span>              :          d_afsd_latm        ! change in fsd due to lateral melt (m)</span>
<span id="L917"><span class="lineNum">     917</span>              : </span>
<span id="L918"><span class="lineNum">     918</span>              :       ! local variables</span>
<span id="L919"><span class="lineNum">     919</span>              : </span>
<span id="L920"><span class="lineNum">     920</span>              :       integer (kind=int_kind) :: &amp;</span>
<span id="L921"><span class="lineNum">     921</span>              :          n           , &amp; ! thickness category index   ! LCOV_EXCL_LINE</span>
<span id="L922"><span class="lineNum">     922</span>              :          k           , &amp; ! layer index   ! LCOV_EXCL_LINE</span>
<span id="L923"><span class="lineNum">     923</span>              :          nsubt           ! sub timesteps for FSD tendency</span>
<span id="L924"><span class="lineNum">     924</span>              : </span>
<span id="L925"><span class="lineNum">     925</span>              :       real (kind=dbl_kind) :: &amp;</span>
<span id="L926"><span class="lineNum">     926</span> <span class="tlaGNC">   105292704 :          dfhocn  , &amp; ! change in fhocn   ! LCOV_EXCL_LINE</span></span>
<span id="L927"><span class="lineNum">     927</span> <span class="tlaGNC">   105292704 :          dfpond  , &amp; ! change in fpond   ! LCOV_EXCL_LINE</span></span>
<span id="L928"><span class="lineNum">     928</span> <span class="tlaGNC">   105292704 :          dfresh  , &amp; ! change in fresh   ! LCOV_EXCL_LINE</span></span>
<span id="L929"><span class="lineNum">     929</span> <span class="tlaGNC">   105292704 :          dfsalt  , &amp; ! change in fsalt   ! LCOV_EXCL_LINE</span></span>
<span id="L930"><span class="lineNum">     930</span> <span class="tlaGNC">   105292704 :          dvssl   , &amp; ! snow surface layer volume   ! LCOV_EXCL_LINE</span></span>
<span id="L931"><span class="lineNum">     931</span> <span class="tlaGNC">   105292704 :          dvint   , &amp; ! snow interior layer   ! LCOV_EXCL_LINE</span></span>
<span id="L932"><span class="lineNum">     932</span> <span class="tlaGNC">   105292704 :          tmp</span></span>
<span id="L933"><span class="lineNum">     933</span>              : </span>
<span id="L934"><span class="lineNum">     934</span>              :       real (kind=dbl_kind), dimension (ncat) :: &amp;</span>
<span id="L935"><span class="lineNum">     935</span> <span class="tlaGNC">  2828734608 :          aicen_init, &amp; ! initial area fraction   ! LCOV_EXCL_LINE</span></span>
<span id="L936"><span class="lineNum">     936</span> <span class="tlaGNC">  2828734608 :          vicen_init, &amp; ! volume per unit area of ice (m)   ! LCOV_EXCL_LINE</span></span>
<span id="L937"><span class="lineNum">     937</span> <span class="tlaGNC">  2828734608 :          vsnon_init, &amp; ! volume per unit area of snow (m)   ! LCOV_EXCL_LINE</span></span>
<span id="L938"><span class="lineNum">     938</span> <span class="tlaGNC">  2828734608 :          G_radialn     ! rate of lateral melt (m/s)</span></span>
<span id="L939"><span class="lineNum">     939</span>              : </span>
<span id="L940"><span class="lineNum">     940</span>              :       real (kind=dbl_kind), dimension (:,:), allocatable :: &amp;</span>
<span id="L941"><span class="lineNum">     941</span> <span class="tlaGNC">  1207816920 :          afsdn     , &amp; ! floe size distribution tracer   ! LCOV_EXCL_LINE</span></span>
<span id="L942"><span class="lineNum">     942</span> <span class="tlaGNC">  1207816920 :          afsdn_init    ! initial value</span></span>
<span id="L943"><span class="lineNum">     943</span>              : </span>
<span id="L944"><span class="lineNum">     944</span>              :       real (kind=dbl_kind), dimension (:), allocatable :: &amp;</span>
<span id="L945"><span class="lineNum">     945</span> <span class="tlaGNC">  1207816920 :          df_flx    , &amp; ! finite difference for FSD   ! LCOV_EXCL_LINE</span></span>
<span id="L946"><span class="lineNum">     946</span> <span class="tlaGNC">  1207816920 :          afsd_tmp  , &amp; !   ! LCOV_EXCL_LINE</span></span>
<span id="L947"><span class="lineNum">     947</span> <span class="tlaGNC">  1207816920 :          d_afsd_tmp, &amp; !   ! LCOV_EXCL_LINE</span></span>
<span id="L948"><span class="lineNum">     948</span> <span class="tlaGNC">  1207816920 :          f_flx         !</span></span>
<span id="L949"><span class="lineNum">     949</span>              : </span>
<span id="L950"><span class="lineNum">     950</span>              :       real (kind=dbl_kind) :: &amp;</span>
<span id="L951"><span class="lineNum">     951</span> <span class="tlaGNC">   105292704 :          sicen,        &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L952"><span class="lineNum">     952</span>              :          etot,         &amp; ! column energy per itd cat, for FSD code   ! LCOV_EXCL_LINE</span>
<span id="L953"><span class="lineNum">     953</span> <span class="tlaGNC">   105292704 :          elapsed_t,    &amp; ! FSD subcycling   ! LCOV_EXCL_LINE</span></span>
<span id="L954"><span class="lineNum">     954</span> <span class="tlaGNC">   105292704 :          subdt           ! FSD timestep (s)</span></span>
<span id="L955"><span class="lineNum">     955</span>              : </span>
<span id="L956"><span class="lineNum">     956</span>              :       character(len=*), parameter :: subname='(lateral_melt)'</span>
<span id="L957"><span class="lineNum">     957</span>              : </span>
<span id="L958"><span class="lineNum">     958</span> <span class="tlaGNC">  1259503656 :       if (tr_fsd) d_afsd_latm = c0</span></span>
<span id="L959"><span class="lineNum">     959</span>              : </span>
<span id="L960"><span class="lineNum">     960</span> <span class="tlaGNC">  6551638945 :       if (.not. any(rsiden(:) &gt; c0)) return  ! no lateral melt, get out now</span></span>
<span id="L961"><span class="lineNum">     961</span>              : </span>
<span id="L962"><span class="lineNum">     962</span> <span class="tlaGNC">   137386961 :       dfhocn   = c0</span></span>
<span id="L963"><span class="lineNum">     963</span> <span class="tlaGNC">   137386961 :       dfpond   = c0</span></span>
<span id="L964"><span class="lineNum">     964</span> <span class="tlaGNC">   137386961 :       dfresh   = c0</span></span>
<span id="L965"><span class="lineNum">     965</span> <span class="tlaGNC">   137386961 :       dfsalt   = c0</span></span>
<span id="L966"><span class="lineNum">     966</span> <span class="tlaGNC">   137386961 :       dvssl    = c0</span></span>
<span id="L967"><span class="lineNum">     967</span> <span class="tlaGNC">   137386961 :       dvint    = c0</span></span>
<span id="L968"><span class="lineNum">     968</span> <span class="tlaGNC">   824579488 :       vicen_init(:) = vicen(:)</span></span>
<span id="L969"><span class="lineNum">     969</span> <span class="tlaGNC">   824579488 :       vsnon_init(:) = vsnon(:)</span></span>
<span id="L970"><span class="lineNum">     970</span>              : </span>
<span id="L971"><span class="lineNum">     971</span> <span class="tlaGNC">   137386961 :       if (tr_fsd) then</span></span>
<span id="L972"><span class="lineNum">     972</span> <span class="tlaGNC">      680408 :          call icepack_cleanup_fsd (trcrn(nt_fsd:nt_fsd+nfsd-1,:))</span></span>
<span id="L973"><span class="lineNum">     973</span> <span class="tlaGNC">      680408 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L974"><span class="lineNum">     974</span>              : </span>
<span id="L975"><span class="lineNum">     975</span> <span class="tlaGNC">      680408 :          allocate(afsdn(nfsd,ncat))</span></span>
<span id="L976"><span class="lineNum">     976</span> <span class="tlaGNC">      680408 :          allocate(afsdn_init(nfsd,ncat))</span></span>
<span id="L977"><span class="lineNum">     977</span> <span class="tlaGNC">      680408 :          allocate(df_flx(nfsd))</span></span>
<span id="L978"><span class="lineNum">     978</span> <span class="tlaGNC">      680408 :          allocate(afsd_tmp(nfsd))</span></span>
<span id="L979"><span class="lineNum">     979</span> <span class="tlaGNC">      680408 :          allocate(d_afsd_tmp(nfsd))</span></span>
<span id="L980"><span class="lineNum">     980</span> <span class="tlaGNC">      680408 :          allocate(f_flx(nfsd+1))</span></span>
<span id="L981"><span class="lineNum">     981</span>              : </span>
<span id="L982"><span class="lineNum">     982</span> <span class="tlaGNC">     4082448 :          aicen_init  = aicen</span></span>
<span id="L983"><span class="lineNum">     983</span> <span class="tlaGNC">    38636766 :          afsdn       = trcrn(nt_fsd:nt_fsd+nfsd-1,:)</span></span>
<span id="L984"><span class="lineNum">     984</span> <span class="tlaGNC">    38636766 :          afsdn_init  = afsdn ! for diagnostics</span></span>
<span id="L985"><span class="lineNum">     985</span> <span class="tlaGNC">     7455190 :          df_flx      = c0</span></span>
<span id="L986"><span class="lineNum">     986</span> <span class="tlaGNC">     8135598 :          f_flx       = c0</span></span>
<span id="L987"><span class="lineNum">     987</span>              :       end if</span>
<span id="L988"><span class="lineNum">     988</span>              : </span>
<span id="L989"><span class="lineNum">     989</span> <span class="tlaGNC">   824579488 :       do n = 1, ncat</span></span>
<span id="L990"><span class="lineNum">     990</span>              : </span>
<span id="L991"><span class="lineNum">     991</span>              :       !-----------------------------------------------------------------</span>
<span id="L992"><span class="lineNum">     992</span>              :       ! Melt the ice and increment fluxes.</span>
<span id="L993"><span class="lineNum">     993</span>              :       !-----------------------------------------------------------------</span>
<span id="L994"><span class="lineNum">     994</span>              : </span>
<span id="L995"><span class="lineNum">     995</span>              :          ! fluxes to coupler</span>
<span id="L996"><span class="lineNum">     996</span>              :          ! dfresh &gt; 0, dfsalt &gt; 0, dfpond &gt; 0</span>
<span id="L997"><span class="lineNum">     997</span>              : </span>
<span id="L998"><span class="lineNum">     998</span> <span class="tlaGNC">   687192527 :          dfresh = (rhoi*vicen(n) + rhos*vsnon(n))      * rsiden(n) / dt</span></span>
<span id="L999"><span class="lineNum">     999</span> <span class="tlaGNC">   687192527 :          if (saltflux_option == 'prognostic') then</span></span>
<span id="L1000"><span class="lineNum">    1000</span> <span class="tlaUNC tlaBgUNC">           0 :             sicen = c0</span></span>
<span id="L1001"><span class="lineNum">    1001</span> <span class="tlaUNC">           0 :             do k=1,nilyr</span></span>
<span id="L1002"><span class="lineNum">    1002</span> <span class="tlaUNC">           0 :                sicen = sicen + trcrn(nt_sice+k-1,n) / real(nilyr,kind=dbl_kind)</span></span>
<span id="L1003"><span class="lineNum">    1003</span>              :             enddo</span>
<span id="L1004"><span class="lineNum">    1004</span> <span class="tlaUNC">           0 :             dfsalt = rhoi*vicen(n)*sicen*p001 * rsiden(n) / dt</span></span>
<span id="L1005"><span class="lineNum">    1005</span>              :          else</span>
<span id="L1006"><span class="lineNum">    1006</span> <span class="tlaGNC tlaBgGNC">   687192527 :             dfsalt = rhoi*vicen(n)*ice_ref_salinity*p001 * rsiden(n) / dt</span></span>
<span id="L1007"><span class="lineNum">    1007</span>              :          endif</span>
<span id="L1008"><span class="lineNum">    1008</span> <span class="tlaGNC">   687192527 :          fresh  = fresh + dfresh</span></span>
<span id="L1009"><span class="lineNum">    1009</span> <span class="tlaGNC">   687192527 :          fsalt  = fsalt + dfsalt</span></span>
<span id="L1010"><span class="lineNum">    1010</span>              : </span>
<span id="L1011"><span class="lineNum">    1011</span> <span class="tlaGNC">   687192527 :          if (tr_pond_topo) then</span></span>
<span id="L1012"><span class="lineNum">    1012</span> <span class="tlaGNC">     7703076 :             dfpond = aicen(n)*trcrn(nt_apnd,n)*trcrn(nt_hpnd,n)*rsiden(n)</span></span>
<span id="L1013"><span class="lineNum">    1013</span> <span class="tlaGNC">     7703076 :             fpond  = fpond - dfpond</span></span>
<span id="L1014"><span class="lineNum">    1014</span>              :          endif</span>
<span id="L1015"><span class="lineNum">    1015</span>              : </span>
<span id="L1016"><span class="lineNum">    1016</span>              :          ! history diagnostics</span>
<span id="L1017"><span class="lineNum">    1017</span> <span class="tlaGNC">   687192527 :          meltl = meltl + vicen_init(n)*rsiden(n)</span></span>
<span id="L1018"><span class="lineNum">    1018</span>              : </span>
<span id="L1019"><span class="lineNum">    1019</span>              :          ! state variables</span>
<span id="L1020"><span class="lineNum">    1020</span> <span class="tlaGNC">   687192527 :          aicen(n) = aicen(n) * (c1 - rsiden(n))</span></span>
<span id="L1021"><span class="lineNum">    1021</span> <span class="tlaGNC">   687192527 :          vicen(n) = vicen(n) * (c1 - rsiden(n))</span></span>
<span id="L1022"><span class="lineNum">    1022</span> <span class="tlaGNC">   687192527 :          vsnon(n) = vsnon(n) * (c1 - rsiden(n))</span></span>
<span id="L1023"><span class="lineNum">    1023</span>              : </span>
<span id="L1024"><span class="lineNum">    1024</span>              :          ! floe size distribution</span>
<span id="L1025"><span class="lineNum">    1025</span> <span class="tlaGNC">   687192527 :          if (tr_fsd) then</span></span>
<span id="L1026"><span class="lineNum">    1026</span> <span class="tlaGNC">     3402040 :             if (rsiden(n) &gt; puny) then</span></span>
<span id="L1027"><span class="lineNum">    1027</span> <span class="tlaGNC">     3401414 :                if (aicen(n) &gt; puny) then</span></span>
<span id="L1028"><span class="lineNum">    1028</span>              : </span>
<span id="L1029"><span class="lineNum">    1029</span>              :                   ! adaptive subtimestep</span>
<span id="L1030"><span class="lineNum">    1030</span> <span class="tlaGNC">     3280761 :                   elapsed_t = c0</span></span>
<span id="L1031"><span class="lineNum">    1031</span> <span class="tlaGNC">    35950200 :                   afsd_tmp(:) = afsdn_init(:,n)</span></span>
<span id="L1032"><span class="lineNum">    1032</span> <span class="tlaGNC">    35950200 :                   d_afsd_tmp(:) = c0</span></span>
<span id="L1033"><span class="lineNum">    1033</span> <span class="tlaGNC">     3280761 :                   nsubt = 0</span></span>
<span id="L1034"><span class="lineNum">    1034</span>              : </span>
<span id="L1035"><span class="lineNum">    1035</span> <span class="tlaGNC">     6561522 :                   DO WHILE (elapsed_t.lt.dt)</span></span>
<span id="L1036"><span class="lineNum">    1036</span>              : </span>
<span id="L1037"><span class="lineNum">    1037</span> <span class="tlaGNC">     3280761 :                      nsubt = nsubt + 1</span></span>
<span id="L1038"><span class="lineNum">    1038</span> <span class="tlaGNC">     3280761 :                      if (nsubt.gt.100) then</span></span>
<span id="L1039"><span class="lineNum">    1039</span> <span class="tlaUNC tlaBgUNC">           0 :                         write(warnstr,*) subname, 'latm not converging'</span></span>
<span id="L1040"><span class="lineNum">    1040</span> <span class="tlaUNC">           0 :                         call icepack_warnings_add(warnstr)</span></span>
<span id="L1041"><span class="lineNum">    1041</span>              :                      endif</span>
<span id="L1042"><span class="lineNum">    1042</span>              : </span>
<span id="L1043"><span class="lineNum">    1043</span>              :                      ! finite differences</span>
<span id="L1044"><span class="lineNum">    1044</span> <span class="tlaGNC tlaBgGNC">    35950200 :                      df_flx(:) = c0</span></span>
<span id="L1045"><span class="lineNum">    1045</span> <span class="tlaGNC">    39230961 :                      f_flx (:) = c0</span></span>
<span id="L1046"><span class="lineNum">    1046</span> <span class="tlaGNC">     3280761 :                      G_radialn(n) = -wlat</span></span>
<span id="L1047"><span class="lineNum">    1047</span> <span class="tlaGNC">    32669439 :                      do k = 2, nfsd</span></span>
<span id="L1048"><span class="lineNum">    1048</span> <span class="tlaGNC">    32669439 :                         f_flx(k) =  G_radialn(n) * afsd_tmp(k) / floe_binwidth(k)</span></span>
<span id="L1049"><span class="lineNum">    1049</span>              :                      end do</span>
<span id="L1050"><span class="lineNum">    1050</span>              : </span>
<span id="L1051"><span class="lineNum">    1051</span> <span class="tlaGNC">    35950200 :                      do k = 1, nfsd</span></span>
<span id="L1052"><span class="lineNum">    1052</span> <span class="tlaGNC">    35950200 :                         df_flx(k)   = f_flx(k+1) - f_flx(k)</span></span>
<span id="L1053"><span class="lineNum">    1053</span>              :                      end do</span>
<span id="L1054"><span class="lineNum">    1054</span>              : </span>
<span id="L1055"><span class="lineNum">    1055</span> <span class="tlaGNC">    35950200 :                      if (abs(sum(df_flx(:))) &gt; puny) then</span></span>
<span id="L1056"><span class="lineNum">    1056</span> <span class="tlaUNC tlaBgUNC">           0 :                         write(warnstr,*) subname, 'sum(df_flx) /= 0'</span></span>
<span id="L1057"><span class="lineNum">    1057</span> <span class="tlaUNC">           0 :                         call icepack_warnings_add(warnstr)</span></span>
<span id="L1058"><span class="lineNum">    1058</span>              :                      endif</span>
<span id="L1059"><span class="lineNum">    1059</span>              : </span>
<span id="L1060"><span class="lineNum">    1060</span>              :                      ! this term ensures area conservation</span>
<span id="L1061"><span class="lineNum">    1061</span> <span class="tlaGNC tlaBgGNC">    35950200 :                      tmp = SUM(afsd_tmp(:)/floe_rad_c(:))</span></span>
<span id="L1062"><span class="lineNum">    1062</span>              : </span>
<span id="L1063"><span class="lineNum">    1063</span>              :                      ! fsd tendency</span>
<span id="L1064"><span class="lineNum">    1064</span> <span class="tlaGNC">    35950200 :                      do k = 1, nfsd</span></span>
<span id="L1065"><span class="lineNum">    1065</span> <span class="tlaGNC">    22431711 :                         d_afsd_tmp(k) = -df_flx(k) + c2 * G_radialn(n) * afsd_tmp(k) &amp;</span></span>
<span id="L1066"><span class="lineNum">    1066</span> <span class="tlaGNC">    58381911 :                              * (c1/floe_rad_c(k) - tmp)</span></span>
<span id="L1067"><span class="lineNum">    1067</span>              :                      end do</span>
<span id="L1068"><span class="lineNum">    1068</span>              : </span>
<span id="L1069"><span class="lineNum">    1069</span>              :                      ! timestep required for this</span>
<span id="L1070"><span class="lineNum">    1070</span> <span class="tlaGNC">     3280761 :                      subdt = get_subdt_fsd(afsd_tmp(:), d_afsd_tmp(:))</span></span>
<span id="L1071"><span class="lineNum">    1071</span> <span class="tlaGNC">     3280761 :                      subdt = MIN(subdt, dt)</span></span>
<span id="L1072"><span class="lineNum">    1072</span>              : </span>
<span id="L1073"><span class="lineNum">    1073</span>              :                      ! update fsd and elapsed time</span>
<span id="L1074"><span class="lineNum">    1074</span> <span class="tlaGNC">    35950200 :                      afsd_tmp(:) = afsd_tmp(:) + subdt*d_afsd_tmp(:)</span></span>
<span id="L1075"><span class="lineNum">    1075</span> <span class="tlaGNC">     3280761 :                      elapsed_t = elapsed_t + subdt</span></span>
<span id="L1076"><span class="lineNum">    1076</span>              : </span>
<span id="L1077"><span class="lineNum">    1077</span>              :                   END DO</span>
<span id="L1078"><span class="lineNum">    1078</span>              : </span>
<span id="L1079"><span class="lineNum">    1079</span> <span class="tlaGNC">    35950200 :                   afsdn(:,n) = afsd_tmp(:)</span></span>
<span id="L1080"><span class="lineNum">    1080</span>              : </span>
<span id="L1081"><span class="lineNum">    1081</span>              :                end if ! aicen</span>
<span id="L1082"><span class="lineNum">    1082</span>              :             end if ! rside &gt; 0, otherwise do nothing</span>
<span id="L1083"><span class="lineNum">    1083</span>              : </span>
<span id="L1084"><span class="lineNum">    1084</span>              :          end if ! tr_fsd</span>
<span id="L1085"><span class="lineNum">    1085</span>              : </span>
<span id="L1086"><span class="lineNum">    1086</span>              :          ! fluxes</span>
<span id="L1087"><span class="lineNum">    1087</span> <span class="tlaGNC">  5497540216 :          do k = 1, nilyr</span></span>
<span id="L1088"><span class="lineNum">    1088</span>              :             ! enthalpy tracers do not change (e/v constant)</span>
<span id="L1089"><span class="lineNum">    1089</span>              :             ! heat flux to coupler for ice melt (dfhocn &lt; 0)</span>
<span id="L1090"><span class="lineNum">    1090</span> <span class="tlaGNC">  1313178132 :             dfhocn = trcrn(nt_qice+k-1,n)*rsiden(n) / dt &amp;</span></span>
<span id="L1091"><span class="lineNum">    1091</span> <span class="tlaGNC">  6123525821 :                  * vicen_init(n)/real(nilyr,kind=dbl_kind)</span></span>
<span id="L1092"><span class="lineNum">    1092</span> <span class="tlaGNC">  5497540216 :             fhocn  = fhocn + dfhocn</span></span>
<span id="L1093"><span class="lineNum">    1093</span>              :          enddo                  ! nilyr</span>
<span id="L1094"><span class="lineNum">    1094</span>              : </span>
<span id="L1095"><span class="lineNum">    1095</span> <span class="tlaGNC">  1407730718 :          do k = 1, nslyr</span></span>
<span id="L1096"><span class="lineNum">    1096</span>              :             ! heat flux to coupler for snow melt (dfhocn &lt; 0)</span>
<span id="L1097"><span class="lineNum">    1097</span> <span class="tlaGNC">   189430536 :             dfhocn = trcrn(nt_qsno+k-1,n)*rsiden(n) / dt &amp;</span></span>
<span id="L1098"><span class="lineNum">    1098</span> <span class="tlaGNC">   909968727 :                  * vsnon_init(n)/real(nslyr,kind=dbl_kind)</span></span>
<span id="L1099"><span class="lineNum">    1099</span> <span class="tlaGNC">  1407730718 :             fhocn  = fhocn + dfhocn</span></span>
<span id="L1100"><span class="lineNum">    1100</span>              :          enddo                  ! nslyr</span>
<span id="L1101"><span class="lineNum">    1101</span>              : </span>
<span id="L1102"><span class="lineNum">    1102</span> <span class="tlaGNC">   687192527 :          if (tr_aero) then</span></span>
<span id="L1103"><span class="lineNum">    1103</span> <span class="tlaGNC">    24101722 :             do k = 1, n_aero</span></span>
<span id="L1104"><span class="lineNum">    1104</span> <span class="tlaGNC">     5507340 :                faero_ocn(k) = faero_ocn(k) &amp;</span></span>
<span id="L1105"><span class="lineNum">    1105</span> <span class="tlaGNC">     8261010 :                             + (vsnon_init(n) * (trcrn(nt_aero  +4*(k-1),n)   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1106"><span class="lineNum">    1106</span> <span class="tlaGNC">     5507340 :                                              +  trcrn(nt_aero+1+4*(k-1),n))  &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1107"><span class="lineNum">    1107</span> <span class="tlaGNC">     8261010 :                             +  vicen_init(n) * (trcrn(nt_aero+2+4*(k-1),n)   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1108"><span class="lineNum">    1108</span> <span class="tlaGNC">     5507340 :                                              +  trcrn(nt_aero+3+4*(k-1),n))) &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1109"><span class="lineNum">    1109</span> <span class="tlaGNC">    57145762 :                             * rsiden(n) / dt</span></span>
<span id="L1110"><span class="lineNum">    1110</span>              :             enddo ! k</span>
<span id="L1111"><span class="lineNum">    1111</span>              :          endif    ! tr_aero</span>
<span id="L1112"><span class="lineNum">    1112</span>              : </span>
<span id="L1113"><span class="lineNum">    1113</span> <span class="tlaGNC">   687192527 :          if (tr_iso) then</span></span>
<span id="L1114"><span class="lineNum">    1114</span> <span class="tlaGNC">     8078940 :             do k = 1, n_iso</span></span>
<span id="L1115"><span class="lineNum">    1115</span> <span class="tlaGNC">      761760 :                fiso_ocn(k) = fiso_ocn(k) &amp;</span></span>
<span id="L1116"><span class="lineNum">    1116</span> <span class="tlaGNC">     1142640 :                            + (vsnon_init(n)*trcrn(nt_isosno+k-1,n)  &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1117"><span class="lineNum">    1117</span> <span class="tlaGNC">     1142640 :                            +  vicen_init(n)*trcrn(nt_isoice+k-1,n)) &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1118"><span class="lineNum">    1118</span> <span class="tlaGNC">    11125980 :                            * rsiden(n) / dt</span></span>
<span id="L1119"><span class="lineNum">    1119</span>              :             enddo ! k</span>
<span id="L1120"><span class="lineNum">    1120</span>              :          endif    ! tr_iso</span>
<span id="L1121"><span class="lineNum">    1121</span>              : </span>
<span id="L1122"><span class="lineNum">    1122</span>              :       !-----------------------------------------------------------------</span>
<span id="L1123"><span class="lineNum">    1123</span>              :       ! Biogeochemistry</span>
<span id="L1124"><span class="lineNum">    1124</span>              :       !-----------------------------------------------------------------</span>
<span id="L1125"><span class="lineNum">    1125</span>              : </span>
<span id="L1126"><span class="lineNum">    1126</span> <span class="tlaGNC">   824579488 :             if (z_tracers) then   ! snow tracers</span></span>
<span id="L1127"><span class="lineNum">    1127</span> <span class="tlaGNC">     6134550 :                dvssl = p5*vsnon_init(n)/real(nslyr,kind=dbl_kind) ! snow surface layer</span></span>
<span id="L1128"><span class="lineNum">    1128</span> <span class="tlaGNC">     6134550 :                dvint = vsnon_init(n) - dvssl                      ! snow interior</span></span>
<span id="L1129"><span class="lineNum">    1129</span> <span class="tlaGNC">   106118820 :                do k = 1, nbtrcr</span></span>
<span id="L1130"><span class="lineNum">    1130</span> <span class="tlaGNC">     2571560 :                   flux_bio(k) = flux_bio(k) &amp;</span></span>
<span id="L1131"><span class="lineNum">    1131</span> <span class="tlaGNC">     3857340 :                               + (trcrn(bio_index(k)+nblyr+1,n)*dvssl  &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1132"><span class="lineNum">    1132</span> <span class="tlaGNC">     3857340 :                               +  trcrn(bio_index(k)+nblyr+2,n)*dvint) &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1133"><span class="lineNum">    1133</span> <span class="tlaGNC">   116405060 :                               * rsiden(n) / dt</span></span>
<span id="L1134"><span class="lineNum">    1134</span>              :                enddo</span>
<span id="L1135"><span class="lineNum">    1135</span>              :             endif</span>
<span id="L1136"><span class="lineNum">    1136</span>              : </span>
<span id="L1137"><span class="lineNum">    1137</span>              :          enddo       ! n</span>
<span id="L1138"><span class="lineNum">    1138</span>              : </span>
<span id="L1139"><span class="lineNum">    1139</span> <span class="tlaGNC">   137386961 :          if (z_tracers) &amp;</span></span>
<span id="L1140"><span class="lineNum">    1140</span>              :             call lateral_melt_bgc(dt,                         &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1141"><span class="lineNum">    1141</span> <span class="tlaUNC tlaBgUNC">           0 :                                   rsiden,      vicen_init,    &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1142"><span class="lineNum">    1142</span> <span class="tlaGNC tlaBgGNC">     1226910 :                                   trcrn,       flux_bio)</span></span>
<span id="L1143"><span class="lineNum">    1143</span> <span class="tlaGNC">   137386961 :             if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1144"><span class="lineNum">    1144</span>              : </span>
<span id="L1145"><span class="lineNum">    1145</span>              : </span>
<span id="L1146"><span class="lineNum">    1146</span> <span class="tlaGNC">   137386961 :             if (tr_fsd) then</span></span>
<span id="L1147"><span class="lineNum">    1147</span>              : </span>
<span id="L1148"><span class="lineNum">    1148</span> <span class="tlaGNC">    37956358 :                trcrn(nt_fsd:nt_fsd+nfsd-1,:) =  afsdn</span></span>
<span id="L1149"><span class="lineNum">    1149</span>              : </span>
<span id="L1150"><span class="lineNum">    1150</span> <span class="tlaGNC">      680408 :                call icepack_cleanup_fsd (trcrn(nt_fsd:nt_fsd+nfsd-1,:) )</span></span>
<span id="L1151"><span class="lineNum">    1151</span> <span class="tlaGNC">      680408 :                if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1152"><span class="lineNum">    1152</span>              : </span>
<span id="L1153"><span class="lineNum">    1153</span>              :                ! diagnostics</span>
<span id="L1154"><span class="lineNum">    1154</span> <span class="tlaGNC">     7455190 :                do k = 1, nfsd</span></span>
<span id="L1155"><span class="lineNum">    1155</span> <span class="tlaGNC">     6774782 :                   d_afsd_latm(k) = c0</span></span>
<span id="L1156"><span class="lineNum">    1156</span> <span class="tlaGNC">    41329100 :                   do n = 1, ncat</span></span>
<span id="L1157"><span class="lineNum">    1157</span> <span class="tlaGNC">    46531460 :                      d_afsd_latm(k) = d_afsd_latm(k) &amp;</span></span>
<span id="L1158"><span class="lineNum">    1158</span> <span class="tlaGNC">    87180152 :                           + afsdn(k,n)*aicen(n) - afsdn_init(k,n)*aicen_init(n)</span></span>
<span id="L1159"><span class="lineNum">    1159</span>              :                   end do</span>
<span id="L1160"><span class="lineNum">    1160</span>              :                end do</span>
<span id="L1161"><span class="lineNum">    1161</span>              : </span>
<span id="L1162"><span class="lineNum">    1162</span> <span class="tlaGNC">      680408 :                deallocate(afsdn)</span></span>
<span id="L1163"><span class="lineNum">    1163</span> <span class="tlaGNC">      680408 :                deallocate(afsdn_init)</span></span>
<span id="L1164"><span class="lineNum">    1164</span> <span class="tlaGNC">      680408 :                deallocate(df_flx)</span></span>
<span id="L1165"><span class="lineNum">    1165</span> <span class="tlaGNC">      680408 :                deallocate(afsd_tmp)</span></span>
<span id="L1166"><span class="lineNum">    1166</span> <span class="tlaGNC">      680408 :                deallocate(d_afsd_tmp)</span></span>
<span id="L1167"><span class="lineNum">    1167</span> <span class="tlaGNC">      680408 :                deallocate(f_flx)</span></span>
<span id="L1168"><span class="lineNum">    1168</span>              : </span>
<span id="L1169"><span class="lineNum">    1169</span>              :             end if</span>
<span id="L1170"><span class="lineNum">    1170</span>              : </span>
<span id="L1171"><span class="lineNum">    1171</span> <span class="tlaGNC">  1207816920 :       end subroutine lateral_melt</span></span>
<span id="L1172"><span class="lineNum">    1172</span>              : </span>
<span id="L1173"><span class="lineNum">    1173</span>              : !=======================================================================</span>
<span id="L1174"><span class="lineNum">    1174</span>              : !</span>
<span id="L1175"><span class="lineNum">    1175</span>              : ! Given the volume of new ice grown in open water, compute its area</span>
<span id="L1176"><span class="lineNum">    1176</span>              : ! and thickness and add it to the appropriate category or categories.</span>
<span id="L1177"><span class="lineNum">    1177</span>              : !</span>
<span id="L1178"><span class="lineNum">    1178</span>              : ! NOTE: Usually all the new ice is added to category 1.  An exception is</span>
<span id="L1179"><span class="lineNum">    1179</span>              : !       made if there is no open water or if the new ice is too thick</span>
<span id="L1180"><span class="lineNum">    1180</span>              : !       for category 1, in which case ice is distributed evenly over the</span>
<span id="L1181"><span class="lineNum">    1181</span>              : !       entire cell.  Subroutine rebin should be called in case the ice</span>
<span id="L1182"><span class="lineNum">    1182</span>              : !       thickness lies outside category bounds after new ice formation.</span>
<span id="L1183"><span class="lineNum">    1183</span>              : !</span>
<span id="L1184"><span class="lineNum">    1184</span>              : ! When ice must be added to categories above category 1, the mushy</span>
<span id="L1185"><span class="lineNum">    1185</span>              : ! formulation (ktherm=2) adds it only to the bottom of the ice.  When</span>
<span id="L1186"><span class="lineNum">    1186</span>              : ! added to only category 1, all formulations combine the new ice and</span>
<span id="L1187"><span class="lineNum">    1187</span>              : ! existing ice tracers as bulk quantities.</span>
<span id="L1188"><span class="lineNum">    1188</span>              : !</span>
<span id="L1189"><span class="lineNum">    1189</span>              : ! authors: William H. Lipscomb, LANL</span>
<span id="L1190"><span class="lineNum">    1190</span>              : !          Elizabeth C. Hunke, LANL</span>
<span id="L1191"><span class="lineNum">    1191</span>              : !          Adrian Turner, LANL</span>
<span id="L1192"><span class="lineNum">    1192</span>              : !          Lettie Roach, NIWA/VUW</span>
<span id="L1193"><span class="lineNum">    1193</span>              : !</span>
<span id="L1194"><span class="lineNum">    1194</span> <span class="tlaGNC">  1207816920 :       subroutine add_new_ice (dt,         &amp;</span></span>
<span id="L1195"><span class="lineNum">    1195</span> <span class="tlaGNC">  1207816920 :                               hin_max,   ktherm,     &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1196"><span class="lineNum">    1196</span> <span class="tlaGNC">  1207816920 :                               aicen,     trcrn,      &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1197"><span class="lineNum">    1197</span> <span class="tlaGNC">  1207816920 :                               vicen,                 &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1198"><span class="lineNum">    1198</span>              :                               aice0,     aice,       &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1199"><span class="lineNum">    1199</span>              :                               frzmlt,    frazil,     &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1200"><span class="lineNum">    1200</span>              :                               frz_onset, yday,       &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1201"><span class="lineNum">    1201</span>              :                               fresh,     fsalt,      &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1202"><span class="lineNum">    1202</span>              :                               Tf,        sss,        &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1203"><span class="lineNum">    1203</span> <span class="tlaGNC">  1207816920 :                               salinz,    phi_init,   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1204"><span class="lineNum">    1204</span>              :                               dSin0_frazil,          &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1205"><span class="lineNum">    1205</span> <span class="tlaUNC tlaBgUNC">           0 :                               flux_bio,   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1206"><span class="lineNum">    1206</span> <span class="tlaGNC tlaBgGNC">  1207816920 :                               ocean_bio,             &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1207"><span class="lineNum">    1207</span>              :                               frazil_diag,           &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1208"><span class="lineNum">    1208</span> <span class="tlaGNC">  1207816920 :                               fiso_ocn,              &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1209"><span class="lineNum">    1209</span>              :                               HDO_ocn, H2_16O_ocn,   &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1210"><span class="lineNum">    1210</span>              :                               H2_18O_ocn,            &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1211"><span class="lineNum">    1211</span>              :                               wave_sig_ht,           &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1212"><span class="lineNum">    1212</span> <span class="tlaGNC">  1207816920 :                               wave_spectrum,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1213"><span class="lineNum">    1213</span> <span class="tlaGNC">  1207816920 :                               wavefreq,              &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1214"><span class="lineNum">    1214</span> <span class="tlaGNC">  1207816920 :                               dwavefreq,             &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1215"><span class="lineNum">    1215</span> <span class="tlaGNC">  1207816920 :                               d_afsd_latg,           &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1216"><span class="lineNum">    1216</span> <span class="tlaGNC">  1207816920 :                               d_afsd_newi)</span></span>
<span id="L1217"><span class="lineNum">    1217</span>              : </span>
<span id="L1218"><span class="lineNum">    1218</span>              :       use icepack_fsd, only: fsd_lateral_growth, fsd_add_new_ice</span>
<span id="L1219"><span class="lineNum">    1219</span>              : </span>
<span id="L1220"><span class="lineNum">    1220</span>              :       integer (kind=int_kind), intent(in) :: &amp;</span>
<span id="L1221"><span class="lineNum">    1221</span>              :          ktherm    ! type of thermodynamics (-1 none, 1 BL99, 2 mushy)</span>
<span id="L1222"><span class="lineNum">    1222</span>              : </span>
<span id="L1223"><span class="lineNum">    1223</span>              :       real (kind=dbl_kind), dimension(0:ncat), intent(in) :: &amp;</span>
<span id="L1224"><span class="lineNum">    1224</span>              :          hin_max      ! category boundaries (m)</span>
<span id="L1225"><span class="lineNum">    1225</span>              : </span>
<span id="L1226"><span class="lineNum">    1226</span>              :       real (kind=dbl_kind), intent(in) :: &amp;</span>
<span id="L1227"><span class="lineNum">    1227</span>              :          dt    , &amp; ! time step (s)   ! LCOV_EXCL_LINE</span>
<span id="L1228"><span class="lineNum">    1228</span>              :          aice  , &amp; ! total concentration of ice   ! LCOV_EXCL_LINE</span>
<span id="L1229"><span class="lineNum">    1229</span>              :          frzmlt, &amp; ! freezing/melting potential (W/m^2)   ! LCOV_EXCL_LINE</span>
<span id="L1230"><span class="lineNum">    1230</span>              :          Tf    , &amp; ! freezing temperature (C)   ! LCOV_EXCL_LINE</span>
<span id="L1231"><span class="lineNum">    1231</span>              :          sss       ! sea surface salinity (ppt)</span>
<span id="L1232"><span class="lineNum">    1232</span>              : </span>
<span id="L1233"><span class="lineNum">    1233</span>              :       real (kind=dbl_kind), dimension (:), intent(inout) :: &amp;</span>
<span id="L1234"><span class="lineNum">    1234</span>              :          aicen , &amp; ! concentration of ice   ! LCOV_EXCL_LINE</span>
<span id="L1235"><span class="lineNum">    1235</span>              :          vicen     ! volume per unit area of ice          (m)</span>
<span id="L1236"><span class="lineNum">    1236</span>              : </span>
<span id="L1237"><span class="lineNum">    1237</span>              :       real (kind=dbl_kind), dimension (:,:), intent(inout) :: &amp;</span>
<span id="L1238"><span class="lineNum">    1238</span>              :          trcrn     ! ice tracers</span>
<span id="L1239"><span class="lineNum">    1239</span>              :                    ! 1: surface temperature</span>
<span id="L1240"><span class="lineNum">    1240</span>              : </span>
<span id="L1241"><span class="lineNum">    1241</span>              :       real (kind=dbl_kind), intent(inout) :: &amp;</span>
<span id="L1242"><span class="lineNum">    1242</span>              :          aice0     , &amp; ! concentration of open water   ! LCOV_EXCL_LINE</span>
<span id="L1243"><span class="lineNum">    1243</span>              :          frazil    , &amp; ! frazil ice growth        (m/step--&gt;cm/day)   ! LCOV_EXCL_LINE</span>
<span id="L1244"><span class="lineNum">    1244</span>              :          frazil_diag,&amp; ! frazil ice growth diagnostic (m/step--&gt;cm/day)   ! LCOV_EXCL_LINE</span>
<span id="L1245"><span class="lineNum">    1245</span>              :          fresh     , &amp; ! fresh water flux to ocean (kg/m^2/s)   ! LCOV_EXCL_LINE</span>
<span id="L1246"><span class="lineNum">    1246</span>              :          fsalt         ! salt flux to ocean (kg/m^2/s)</span>
<span id="L1247"><span class="lineNum">    1247</span>              : </span>
<span id="L1248"><span class="lineNum">    1248</span>              :       real (kind=dbl_kind), intent(inout), optional :: &amp;</span>
<span id="L1249"><span class="lineNum">    1249</span>              :          frz_onset ! day of year that freezing begins (congel or frazil)</span>
<span id="L1250"><span class="lineNum">    1250</span>              : </span>
<span id="L1251"><span class="lineNum">    1251</span>              :       real (kind=dbl_kind), intent(in), optional :: &amp;</span>
<span id="L1252"><span class="lineNum">    1252</span>              :          yday      ! day of year</span>
<span id="L1253"><span class="lineNum">    1253</span>              : </span>
<span id="L1254"><span class="lineNum">    1254</span>              :       real (kind=dbl_kind), dimension(:), intent(in) :: &amp;</span>
<span id="L1255"><span class="lineNum">    1255</span>              :          salinz     ! initial salinity profile</span>
<span id="L1256"><span class="lineNum">    1256</span>              : </span>
<span id="L1257"><span class="lineNum">    1257</span>              :       real (kind=dbl_kind), intent(in) :: &amp;</span>
<span id="L1258"><span class="lineNum">    1258</span>              :          phi_init     , &amp; ! initial frazil liquid fraction   ! LCOV_EXCL_LINE</span>
<span id="L1259"><span class="lineNum">    1259</span>              :          dSin0_frazil     ! initial frazil bulk salinity reduction from sss</span>
<span id="L1260"><span class="lineNum">    1260</span>              : </span>
<span id="L1261"><span class="lineNum">    1261</span>              :       ! BGC</span>
<span id="L1262"><span class="lineNum">    1262</span>              : </span>
<span id="L1263"><span class="lineNum">    1263</span>              :       real (kind=dbl_kind), dimension (:), intent(inout) :: &amp;</span>
<span id="L1264"><span class="lineNum">    1264</span>              :          flux_bio   ! tracer flux to ocean from biology (mmol/m^2/s)</span>
<span id="L1265"><span class="lineNum">    1265</span>              : </span>
<span id="L1266"><span class="lineNum">    1266</span>              :       real (kind=dbl_kind), dimension (:), intent(in) :: &amp;</span>
<span id="L1267"><span class="lineNum">    1267</span>              :          ocean_bio   ! ocean concentration of biological tracer</span>
<span id="L1268"><span class="lineNum">    1268</span>              : </span>
<span id="L1269"><span class="lineNum">    1269</span>              :       ! water isotopes</span>
<span id="L1270"><span class="lineNum">    1270</span>              : </span>
<span id="L1271"><span class="lineNum">    1271</span>              :       real (kind=dbl_kind), dimension(:), intent(inout), optional :: &amp;</span>
<span id="L1272"><span class="lineNum">    1272</span>              :          fiso_ocn       ! isotope flux to ocean  (kg/m^2/s)</span>
<span id="L1273"><span class="lineNum">    1273</span>              : </span>
<span id="L1274"><span class="lineNum">    1274</span>              :       real (kind=dbl_kind), intent(in), optional :: &amp;</span>
<span id="L1275"><span class="lineNum">    1275</span>              :          HDO_ocn    , &amp; ! ocean concentration of HDO (kg/kg)   ! LCOV_EXCL_LINE</span>
<span id="L1276"><span class="lineNum">    1276</span>              :          H2_16O_ocn , &amp; ! ocean concentration of H2_16O (kg/kg)   ! LCOV_EXCL_LINE</span>
<span id="L1277"><span class="lineNum">    1277</span>              :          H2_18O_ocn     ! ocean concentration of H2_18O (kg/kg)</span>
<span id="L1278"><span class="lineNum">    1278</span>              : </span>
<span id="L1279"><span class="lineNum">    1279</span>              :       ! floe size distribution</span>
<span id="L1280"><span class="lineNum">    1280</span>              :       real (kind=dbl_kind), intent(in), optional :: &amp;</span>
<span id="L1281"><span class="lineNum">    1281</span>              :          wave_sig_ht    ! significant height of waves globally (m)</span>
<span id="L1282"><span class="lineNum">    1282</span>              : </span>
<span id="L1283"><span class="lineNum">    1283</span>              :       real (kind=dbl_kind), dimension(:), intent(in), optional :: &amp;</span>
<span id="L1284"><span class="lineNum">    1284</span>              :          wave_spectrum  ! ocean surface wave spectrum, E(f) (m^2 s)</span>
<span id="L1285"><span class="lineNum">    1285</span>              : </span>
<span id="L1286"><span class="lineNum">    1286</span>              :       real(kind=dbl_kind), dimension(:), intent(in), optional :: &amp;</span>
<span id="L1287"><span class="lineNum">    1287</span>              :          wavefreq,              &amp; ! wave frequencies (s^-1)   ! LCOV_EXCL_LINE</span>
<span id="L1288"><span class="lineNum">    1288</span>              :          dwavefreq                ! wave frequency bin widths (s^-1)</span>
<span id="L1289"><span class="lineNum">    1289</span>              : </span>
<span id="L1290"><span class="lineNum">    1290</span>              :       real (kind=dbl_kind), dimension(:), intent(out), optional :: &amp;</span>
<span id="L1291"><span class="lineNum">    1291</span>              :                             ! change in thickness distribution (area)</span>
<span id="L1292"><span class="lineNum">    1292</span>              :          d_afsd_latg    , &amp; ! due to fsd lateral growth</span>
<span id="L1293"><span class="lineNum">    1293</span>              :          d_afsd_newi        ! new ice formation</span>
<span id="L1294"><span class="lineNum">    1294</span>              : </span>
<span id="L1295"><span class="lineNum">    1295</span>              :       ! local variables</span>
<span id="L1296"><span class="lineNum">    1296</span>              : </span>
<span id="L1297"><span class="lineNum">    1297</span>              :       integer (kind=int_kind) :: &amp;</span>
<span id="L1298"><span class="lineNum">    1298</span>              :          ncats        , &amp; ! max categories to which new ice is added, initially   ! LCOV_EXCL_LINE</span>
<span id="L1299"><span class="lineNum">    1299</span>              :          n            , &amp; ! ice category index   ! LCOV_EXCL_LINE</span>
<span id="L1300"><span class="lineNum">    1300</span>              :          k            , &amp; ! ice layer index   ! LCOV_EXCL_LINE</span>
<span id="L1301"><span class="lineNum">    1301</span>              :          it               ! aerosol tracer index</span>
<span id="L1302"><span class="lineNum">    1302</span>              : </span>
<span id="L1303"><span class="lineNum">    1303</span>              :       real (kind=dbl_kind) :: &amp;</span>
<span id="L1304"><span class="lineNum">    1304</span> <span class="tlaGNC">   105292704 :          ai0new       , &amp; ! area of new ice added to cat 1   ! LCOV_EXCL_LINE</span></span>
<span id="L1305"><span class="lineNum">    1305</span> <span class="tlaGNC">   105292704 :          vi0new       , &amp; ! volume of new ice added to cat 1   ! LCOV_EXCL_LINE</span></span>
<span id="L1306"><span class="lineNum">    1306</span> <span class="tlaGNC">   105292704 :          hsurp        , &amp; ! thickness of new ice added to each cat   ! LCOV_EXCL_LINE</span></span>
<span id="L1307"><span class="lineNum">    1307</span> <span class="tlaGNC">   105292704 :          fnew         , &amp; ! heat flx to open water for new ice (W/m^2)   ! LCOV_EXCL_LINE</span></span>
<span id="L1308"><span class="lineNum">    1308</span> <span class="tlaGNC">   105292704 :          hi0new       , &amp; ! thickness of new ice   ! LCOV_EXCL_LINE</span></span>
<span id="L1309"><span class="lineNum">    1309</span> <span class="tlaGNC">   105292704 :          hi0max       , &amp; ! max allowed thickness of new ice   ! LCOV_EXCL_LINE</span></span>
<span id="L1310"><span class="lineNum">    1310</span> <span class="tlaGNC">   105292704 :          vsurp        , &amp; ! volume of new ice added to each cat   ! LCOV_EXCL_LINE</span></span>
<span id="L1311"><span class="lineNum">    1311</span> <span class="tlaGNC">   105292704 :          vtmp         , &amp; ! total volume of new and old ice   ! LCOV_EXCL_LINE</span></span>
<span id="L1312"><span class="lineNum">    1312</span> <span class="tlaGNC">   105292704 :          area1        , &amp; ! starting fractional area of existing ice   ! LCOV_EXCL_LINE</span></span>
<span id="L1313"><span class="lineNum">    1313</span> <span class="tlaGNC">   105292704 :          alvl         , &amp; ! starting level ice area   ! LCOV_EXCL_LINE</span></span>
<span id="L1314"><span class="lineNum">    1314</span> <span class="tlaGNC">   105292704 :          dfresh       , &amp; ! change in fresh   ! LCOV_EXCL_LINE</span></span>
<span id="L1315"><span class="lineNum">    1315</span> <span class="tlaGNC">   105292704 :          dfsalt       , &amp; ! change in fsalt   ! LCOV_EXCL_LINE</span></span>
<span id="L1316"><span class="lineNum">    1316</span> <span class="tlaGNC">   105292704 :          vi0tmp       , &amp; ! frzmlt part of frazil   ! LCOV_EXCL_LINE</span></span>
<span id="L1317"><span class="lineNum">    1317</span> <span class="tlaGNC">   105292704 :          Ti           , &amp; ! frazil temperature   ! LCOV_EXCL_LINE</span></span>
<span id="L1318"><span class="lineNum">    1318</span> <span class="tlaGNC">   105292704 :          qi0new       , &amp; ! frazil ice enthalpy   ! LCOV_EXCL_LINE</span></span>
<span id="L1319"><span class="lineNum">    1319</span> <span class="tlaGNC">   105292704 :          Si0new       , &amp; ! frazil ice bulk salinity   ! LCOV_EXCL_LINE</span></span>
<span id="L1320"><span class="lineNum">    1320</span> <span class="tlaGNC">   105292704 :          vi0_init     , &amp; ! volume of new ice   ! LCOV_EXCL_LINE</span></span>
<span id="L1321"><span class="lineNum">    1321</span> <span class="tlaGNC">   105292704 :          vice1        , &amp; ! starting volume of existing ice   ! LCOV_EXCL_LINE</span></span>
<span id="L1322"><span class="lineNum">    1322</span> <span class="tlaGNC">   105292704 :          vice_init, vice_final, &amp; ! ice volume summed over categories   ! LCOV_EXCL_LINE</span></span>
<span id="L1323"><span class="lineNum">    1323</span> <span class="tlaGNC">   105292704 :          eice_init, eice_final    ! ice energy summed over categories</span></span>
<span id="L1324"><span class="lineNum">    1324</span>              : </span>
<span id="L1325"><span class="lineNum">    1325</span> <span class="tlaGNC">   105292704 :       real (kind=dbl_kind) :: frazil_conc</span></span>
<span id="L1326"><span class="lineNum">    1326</span>              : </span>
<span id="L1327"><span class="lineNum">    1327</span>              :       real (kind=dbl_kind), dimension (nilyr) :: &amp;</span>
<span id="L1328"><span class="lineNum">    1328</span> <span class="tlaGNC">  2991173904 :          Sprofile         ! salinity profile used for new ice additions</span></span>
<span id="L1329"><span class="lineNum">    1329</span>              : </span>
<span id="L1330"><span class="lineNum">    1330</span>              :       character (len=char_len) :: &amp;</span>
<span id="L1331"><span class="lineNum">    1331</span>              :          fieldid           ! field identifier</span>
<span id="L1332"><span class="lineNum">    1332</span>              : </span>
<span id="L1333"><span class="lineNum">    1333</span>              :       real (kind=dbl_kind), dimension (ncat) :: &amp;</span>
<span id="L1334"><span class="lineNum">    1334</span> <span class="tlaGNC">  2828734608 :          eicen, &amp;     ! energy of melting for each ice layer (J/m^2)   ! LCOV_EXCL_LINE</span></span>
<span id="L1335"><span class="lineNum">    1335</span> <span class="tlaGNC">  2828734608 :          aicen_init, &amp;    ! fractional area of ice   ! LCOV_EXCL_LINE</span></span>
<span id="L1336"><span class="lineNum">    1336</span> <span class="tlaGNC">  2828734608 :          vicen_init       ! volume per unit area of ice (m)</span></span>
<span id="L1337"><span class="lineNum">    1337</span>              : </span>
<span id="L1338"><span class="lineNum">    1338</span>              :       ! floe size distribution</span>
<span id="L1339"><span class="lineNum">    1339</span>              :       real (kind=dbl_kind), dimension (:,:), allocatable :: &amp;</span>
<span id="L1340"><span class="lineNum">    1340</span> <span class="tlaGNC">  1207816920 :          afsdn          ! floe size distribution tracer (originally areal_mfstd_init)</span></span>
<span id="L1341"><span class="lineNum">    1341</span>              : </span>
<span id="L1342"><span class="lineNum">    1342</span>              : !      real (kind=dbl_kind), dimension (nfsd) :: &amp;</span>
<span id="L1343"><span class="lineNum">    1343</span>              : !         afsd      , &amp; ! fsd tracer for each thickness category   ! LCOV_EXCL_LINE</span>
<span id="L1344"><span class="lineNum">    1344</span>              : </span>
<span id="L1345"><span class="lineNum">    1345</span>              :       real (kind=dbl_kind), dimension(ncat) :: &amp;  ! for now</span>
<span id="L1346"><span class="lineNum">    1346</span>              :                             ! change in thickness distribution (area)</span>
<span id="L1347"><span class="lineNum">    1347</span> <span class="tlaGNC">  2828734608 :          d_an_latg      , &amp; ! due to fsd lateral growth</span></span>
<span id="L1348"><span class="lineNum">    1348</span> <span class="tlaGNC">  2828734608 :          d_an_newi          ! new ice formation</span></span>
<span id="L1349"><span class="lineNum">    1349</span>              : </span>
<span id="L1350"><span class="lineNum">    1350</span>              :       real (kind=dbl_kind), dimension (ncat) :: &amp;</span>
<span id="L1351"><span class="lineNum">    1351</span> <span class="tlaGNC">  2828734608 :          d_an_tot, &amp; ! change in the ITD due to lateral growth and new ice   ! LCOV_EXCL_LINE</span></span>
<span id="L1352"><span class="lineNum">    1352</span> <span class="tlaGNC">  2828734608 :          area2       ! area after lateral growth and before new ice formation</span></span>
<span id="L1353"><span class="lineNum">    1353</span>              : </span>
<span id="L1354"><span class="lineNum">    1354</span>              :       real (kind=dbl_kind), dimension (ncat) :: &amp;</span>
<span id="L1355"><span class="lineNum">    1355</span> <span class="tlaGNC">  2828734608 :          vin0new          ! volume of new ice added to any thickness cat</span></span>
<span id="L1356"><span class="lineNum">    1356</span>              : </span>
<span id="L1357"><span class="lineNum">    1357</span>              :       real (kind=dbl_kind) :: &amp;</span>
<span id="L1358"><span class="lineNum">    1358</span> <span class="tlaGNC">   105292704 :          latsurf_area, &amp; ! fractional area of ice on sides of floes   ! LCOV_EXCL_LINE</span></span>
<span id="L1359"><span class="lineNum">    1359</span> <span class="tlaGNC">   105292704 :          lead_area   , &amp; ! fractional area of ice in lead region   ! LCOV_EXCL_LINE</span></span>
<span id="L1360"><span class="lineNum">    1360</span> <span class="tlaGNC">   105292704 :          G_radial    , &amp; ! lateral melt rate (m/s)   ! LCOV_EXCL_LINE</span></span>
<span id="L1361"><span class="lineNum">    1361</span> <span class="tlaGNC">   105292704 :          tot_latg    , &amp; ! total fsd lateral growth in open water   ! LCOV_EXCL_LINE</span></span>
<span id="L1362"><span class="lineNum">    1362</span> <span class="tlaGNC">   105292704 :          ai0mod          ! ai0new - tot_latg</span></span>
<span id="L1363"><span class="lineNum">    1363</span>              : </span>
<span id="L1364"><span class="lineNum">    1364</span>              :       character(len=*),parameter :: subname='(add_new_ice)'</span>
<span id="L1365"><span class="lineNum">    1365</span>              : </span>
<span id="L1366"><span class="lineNum">    1366</span>              :       !-----------------------------------------------------------------</span>
<span id="L1367"><span class="lineNum">    1367</span>              :       ! initialize</span>
<span id="L1368"><span class="lineNum">    1368</span>              :       !-----------------------------------------------------------------</span>
<span id="L1369"><span class="lineNum">    1369</span>              : </span>
<span id="L1370"><span class="lineNum">    1370</span> <span class="tlaGNC">  1207816920 :       hsurp  = c0</span></span>
<span id="L1371"><span class="lineNum">    1371</span> <span class="tlaGNC">  1207816920 :       hi0new = c0</span></span>
<span id="L1372"><span class="lineNum">    1372</span> <span class="tlaGNC">  1207816920 :       ai0new = c0</span></span>
<span id="L1373"><span class="lineNum">    1373</span> <span class="tlaGNC">  7238831472 :       d_an_latg(:) = c0</span></span>
<span id="L1374"><span class="lineNum">    1374</span> <span class="tlaGNC">  7238831472 :       d_an_tot(:) = c0</span></span>
<span id="L1375"><span class="lineNum">    1375</span> <span class="tlaGNC">  7238831472 :       d_an_newi(:) = c0</span></span>
<span id="L1376"><span class="lineNum">    1376</span> <span class="tlaGNC">  7238831472 :       vin0new(:) = c0</span></span>
<span id="L1377"><span class="lineNum">    1377</span>              : </span>
<span id="L1378"><span class="lineNum">    1378</span> <span class="tlaGNC">  1207816920 :       if (tr_fsd) then</span></span>
<span id="L1379"><span class="lineNum">    1379</span> <span class="tlaGNC">    56874624 :           d_afsd_latg(:) = c0    ! diagnostics</span></span>
<span id="L1380"><span class="lineNum">    1380</span> <span class="tlaGNC">    56874624 :           d_afsd_newi(:) = c0</span></span>
<span id="L1381"><span class="lineNum">    1381</span>              :       end if</span>
<span id="L1382"><span class="lineNum">    1382</span>              : </span>
<span id="L1383"><span class="lineNum">    1383</span> <span class="tlaGNC">  7238831472 :       area2(:) = aicen(:)</span></span>
<span id="L1384"><span class="lineNum">    1384</span> <span class="tlaGNC">  1207816920 :       lead_area    = c0</span></span>
<span id="L1385"><span class="lineNum">    1385</span> <span class="tlaGNC">  1207816920 :       latsurf_area = c0</span></span>
<span id="L1386"><span class="lineNum">    1386</span> <span class="tlaGNC">  1207816920 :       G_radial     = c0</span></span>
<span id="L1387"><span class="lineNum">    1387</span> <span class="tlaGNC">  1207816920 :       tot_latg     = c0</span></span>
<span id="L1388"><span class="lineNum">    1388</span> <span class="tlaGNC">  1207816920 :       if (ncat &gt; 1) then</span></span>
<span id="L1389"><span class="lineNum">    1389</span> <span class="tlaGNC">  1202052600 :          hi0max = hin_max(1)*0.9_dbl_kind  ! not too close to boundary</span></span>
<span id="L1390"><span class="lineNum">    1390</span>              :       else</span>
<span id="L1391"><span class="lineNum">    1391</span> <span class="tlaGNC">     5764320 :          hi0max = bignum                   ! big number</span></span>
<span id="L1392"><span class="lineNum">    1392</span>              :       endif</span>
<span id="L1393"><span class="lineNum">    1393</span>              : </span>
<span id="L1394"><span class="lineNum">    1394</span> <span class="tlaGNC">  1207816920 :       if (tr_fsd) then</span></span>
<span id="L1395"><span class="lineNum">    1395</span> <span class="tlaGNC">     5187888 :          allocate(afsdn(nfsd,ncat))</span></span>
<span id="L1396"><span class="lineNum">    1396</span> <span class="tlaGNC">   289561008 :          afsdn(:,:) = c0</span></span>
<span id="L1397"><span class="lineNum">    1397</span> <span class="tlaGNC">     5187888 :          call icepack_cleanup_fsd (trcrn(nt_fsd:nt_fsd+nfsd-1,:))</span></span>
<span id="L1398"><span class="lineNum">    1398</span> <span class="tlaGNC">     5187888 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1399"><span class="lineNum">    1399</span>              :       endif</span>
<span id="L1400"><span class="lineNum">    1400</span>              : </span>
<span id="L1401"><span class="lineNum">    1401</span> <span class="tlaGNC">  7238831472 :       do n = 1, ncat</span></span>
<span id="L1402"><span class="lineNum">    1402</span> <span class="tlaGNC">  6031014552 :          aicen_init(n) = aicen(n)</span></span>
<span id="L1403"><span class="lineNum">    1403</span> <span class="tlaGNC">  6031014552 :          vicen_init(n) = vicen(n)</span></span>
<span id="L1404"><span class="lineNum">    1404</span> <span class="tlaGNC">  6031014552 :          eicen(n) = c0</span></span>
<span id="L1405"><span class="lineNum">    1405</span> <span class="tlaGNC">  7238831472 :          if (tr_fsd) then</span></span>
<span id="L1406"><span class="lineNum">    1406</span> <span class="tlaGNC">   284373120 :             do k = 1, nfsd</span></span>
<span id="L1407"><span class="lineNum">    1407</span> <span class="tlaGNC">   284373120 :                afsdn(k,n) = trcrn(nt_fsd+k-1,n)</span></span>
<span id="L1408"><span class="lineNum">    1408</span>              :             enddo</span>
<span id="L1409"><span class="lineNum">    1409</span>              :          endif</span>
<span id="L1410"><span class="lineNum">    1410</span>              :       enddo</span>
<span id="L1411"><span class="lineNum">    1411</span>              : </span>
<span id="L1412"><span class="lineNum">    1412</span> <span class="tlaGNC">  1207816920 :       if (conserv_check) then</span></span>
<span id="L1413"><span class="lineNum">    1413</span>              : </span>
<span id="L1414"><span class="lineNum">    1414</span> <span class="tlaGNC">    61870368 :          do n = 1, ncat</span></span>
<span id="L1415"><span class="lineNum">    1415</span> <span class="tlaGNC">   433092576 :          do k = 1, nilyr</span></span>
<span id="L1416"><span class="lineNum">    1416</span> <span class="tlaGNC">   516483072 :             eicen(n) = eicen(n) + trcrn(nt_qice+k-1,n) &amp;</span></span>
<span id="L1417"><span class="lineNum">    1417</span> <span class="tlaGNC">   940737024 :                      * vicen(n)/real(nilyr,kind=dbl_kind)</span></span>
<span id="L1418"><span class="lineNum">    1418</span>              :          enddo</span>
<span id="L1419"><span class="lineNum">    1419</span>              :          enddo</span>
<span id="L1420"><span class="lineNum">    1420</span> <span class="tlaGNC">     8838624 :          call column_sum (ncat, vicen, vice_init)</span></span>
<span id="L1421"><span class="lineNum">    1421</span> <span class="tlaGNC">     8838624 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1422"><span class="lineNum">    1422</span> <span class="tlaGNC">     8838624 :          call column_sum (ncat, eicen, eice_init)</span></span>
<span id="L1423"><span class="lineNum">    1423</span> <span class="tlaGNC">     8838624 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1424"><span class="lineNum">    1424</span>              : </span>
<span id="L1425"><span class="lineNum">    1425</span>              :       endif ! conserv_check</span>
<span id="L1426"><span class="lineNum">    1426</span>              : </span>
<span id="L1427"><span class="lineNum">    1427</span>              :       !-----------------------------------------------------------------</span>
<span id="L1428"><span class="lineNum">    1428</span>              :       ! Compute average enthalpy of new ice.</span>
<span id="L1429"><span class="lineNum">    1429</span>              :       ! Sprofile is the salinity profile used when adding new ice to</span>
<span id="L1430"><span class="lineNum">    1430</span>              :       ! all categories, for ktherm/=2, and to category 1 for all ktherm.</span>
<span id="L1431"><span class="lineNum">    1431</span>              :       !</span>
<span id="L1432"><span class="lineNum">    1432</span>              :       ! NOTE:  POP assumes new ice is fresh!</span>
<span id="L1433"><span class="lineNum">    1433</span>              :       !-----------------------------------------------------------------</span>
<span id="L1434"><span class="lineNum">    1434</span>              : </span>
<span id="L1435"><span class="lineNum">    1435</span> <span class="tlaGNC">  1207816920 :       if (ktherm == 2) then  ! mushy</span></span>
<span id="L1436"><span class="lineNum">    1436</span> <span class="tlaGNC">  1165161144 :          if (sss &gt; c2 * dSin0_frazil) then</span></span>
<span id="L1437"><span class="lineNum">    1437</span> <span class="tlaGNC">  1165161144 :             Si0new = sss - dSin0_frazil</span></span>
<span id="L1438"><span class="lineNum">    1438</span>              :          else</span>
<span id="L1439"><span class="lineNum">    1439</span> <span class="tlaUNC tlaBgUNC">           0 :             Si0new = sss**2 / (c4*dSin0_frazil)</span></span>
<span id="L1440"><span class="lineNum">    1440</span>              :          endif</span>
<span id="L1441"><span class="lineNum">    1441</span> <span class="tlaGNC tlaBgGNC">  9321289152 :          do k = 1, nilyr</span></span>
<span id="L1442"><span class="lineNum">    1442</span> <span class="tlaGNC">  9321289152 :             Sprofile(k) = Si0new</span></span>
<span id="L1443"><span class="lineNum">    1443</span>              :          enddo</span>
<span id="L1444"><span class="lineNum">    1444</span> <span class="tlaGNC">  1165161144 :          Ti = min(liquidus_temperature_mush(Si0new/phi_init), Tliquidus_max)</span></span>
<span id="L1445"><span class="lineNum">    1445</span> <span class="tlaGNC">  1165161144 :          qi0new = icepack_enthalpy_mush(Ti, Si0new)</span></span>
<span id="L1446"><span class="lineNum">    1446</span>              :       else</span>
<span id="L1447"><span class="lineNum">    1447</span> <span class="tlaGNC">   156789120 :          do k = 1, nilyr</span></span>
<span id="L1448"><span class="lineNum">    1448</span> <span class="tlaGNC">   156789120 :             Sprofile(k) = salinz(k)</span></span>
<span id="L1449"><span class="lineNum">    1449</span>              :          enddo</span>
<span id="L1450"><span class="lineNum">    1450</span> <span class="tlaGNC">    42655776 :          qi0new = -rhoi*Lfresh</span></span>
<span id="L1451"><span class="lineNum">    1451</span>              :       endif    ! ktherm</span>
<span id="L1452"><span class="lineNum">    1452</span>              : </span>
<span id="L1453"><span class="lineNum">    1453</span>              :       !-----------------------------------------------------------------</span>
<span id="L1454"><span class="lineNum">    1454</span>              :       ! Compute the volume, area, and thickness of new ice.</span>
<span id="L1455"><span class="lineNum">    1455</span>              :       !-----------------------------------------------------------------</span>
<span id="L1456"><span class="lineNum">    1456</span>              : </span>
<span id="L1457"><span class="lineNum">    1457</span> <span class="tlaGNC">  1207816920 :       fnew = max (frzmlt, c0)    ! fnew &gt; 0 iff frzmlt &gt; 0</span></span>
<span id="L1458"><span class="lineNum">    1458</span> <span class="tlaGNC">  1207816920 :       vi0new = -fnew*dt / qi0new ! note sign convention, qi &lt; 0</span></span>
<span id="L1459"><span class="lineNum">    1459</span> <span class="tlaGNC">  1207816920 :       vi0_init = vi0new          ! for bgc</span></span>
<span id="L1460"><span class="lineNum">    1460</span>              : </span>
<span id="L1461"><span class="lineNum">    1461</span>              :       ! increment ice volume and energy</span>
<span id="L1462"><span class="lineNum">    1462</span> <span class="tlaGNC">  1207816920 :       if (conserv_check) then</span></span>
<span id="L1463"><span class="lineNum">    1463</span> <span class="tlaGNC">     8838624 :          vice_init = vice_init + vi0new</span></span>
<span id="L1464"><span class="lineNum">    1464</span> <span class="tlaGNC">     8838624 :          eice_init = eice_init + vi0new*qi0new</span></span>
<span id="L1465"><span class="lineNum">    1465</span>              :       endif</span>
<span id="L1466"><span class="lineNum">    1466</span>              : </span>
<span id="L1467"><span class="lineNum">    1467</span>              :       ! history diagnostics</span>
<span id="L1468"><span class="lineNum">    1468</span> <span class="tlaGNC">  1207816920 :       frazil = vi0new</span></span>
<span id="L1469"><span class="lineNum">    1469</span>              : </span>
<span id="L1470"><span class="lineNum">    1470</span> <span class="tlaGNC">  1207816920 :       if (present(frz_onset) .and. present(yday)) then</span></span>
<span id="L1471"><span class="lineNum">    1471</span> <span class="tlaGNC">  1205895480 :          if (frazil &gt; puny .and. frz_onset &lt; puny) frz_onset = yday</span></span>
<span id="L1472"><span class="lineNum">    1472</span>              :       endif</span>
<span id="L1473"><span class="lineNum">    1473</span>              : </span>
<span id="L1474"><span class="lineNum">    1474</span>              :       !-----------------------------------------------------------------</span>
<span id="L1475"><span class="lineNum">    1475</span>              :       ! Update fresh water and salt fluxes.</span>
<span id="L1476"><span class="lineNum">    1476</span>              :       !</span>
<span id="L1477"><span class="lineNum">    1477</span>              :       ! NOTE: POP assumes fresh water and salt flux due to frzmlt &gt; 0</span>
<span id="L1478"><span class="lineNum">    1478</span>              :       !       is NOT included in fluxes fresh and fsalt.</span>
<span id="L1479"><span class="lineNum">    1479</span>              :       !-----------------------------------------------------------------</span>
<span id="L1480"><span class="lineNum">    1480</span>              : </span>
<span id="L1481"><span class="lineNum">    1481</span> <span class="tlaGNC">  1207816920 :       dfresh = c0</span></span>
<span id="L1482"><span class="lineNum">    1482</span> <span class="tlaGNC">  1207816920 :       dfsalt = c0</span></span>
<span id="L1483"><span class="lineNum">    1483</span> <span class="tlaGNC">  1207816920 :       if (cpl_frazil == 'external') then</span></span>
<span id="L1484"><span class="lineNum">    1484</span>              :          ! do nothing here, calculations are in the coupler or elsewhere</span>
<span id="L1485"><span class="lineNum">    1485</span>              :       else</span>
<span id="L1486"><span class="lineNum">    1486</span> <span class="tlaGNC">  1207816920 :          if (update_ocn_f) then</span></span>
<span id="L1487"><span class="lineNum">    1487</span> <span class="tlaUNC tlaBgUNC">           0 :             dfresh = -rhoi*vi0new/dt</span></span>
<span id="L1488"><span class="lineNum">    1488</span> <span class="tlaGNC tlaBgGNC">  1207816920 :          elseif (cpl_frazil == 'fresh_ice_correction' .and. ktherm == 2) then</span></span>
<span id="L1489"><span class="lineNum">    1489</span>              :             ! correct frazil fluxes for mushy</span>
<span id="L1490"><span class="lineNum">    1490</span> <span class="tlaGNC">  1165161144 :             vi0tmp = fnew*dt / (rhoi*Lfresh) ! ocn/cpl assumes frazil volume is pure, fresh ice</span></span>
<span id="L1491"><span class="lineNum">    1491</span> <span class="tlaGNC">  1165161144 :             dfresh = -rhoi*(vi0new - vi0tmp)/dt</span></span>
<span id="L1492"><span class="lineNum">    1492</span> <span class="tlaGNC">  1165161144 :             frazil_diag = frazil - vi0tmp</span></span>
<span id="L1493"><span class="lineNum">    1493</span>              : !        else</span>
<span id="L1494"><span class="lineNum">    1494</span>              : !           do nothing - other correction options could be implemented in the future</span>
<span id="L1495"><span class="lineNum">    1495</span>              :          endif</span>
<span id="L1496"><span class="lineNum">    1496</span>              : </span>
<span id="L1497"><span class="lineNum">    1497</span> <span class="tlaGNC">  1207816920 :          if (saltflux_option == 'prognostic') then</span></span>
<span id="L1498"><span class="lineNum">    1498</span> <span class="tlaUNC tlaBgUNC">           0 :             dfsalt = Si0new*p001*dfresh</span></span>
<span id="L1499"><span class="lineNum">    1499</span>              :          else</span>
<span id="L1500"><span class="lineNum">    1500</span> <span class="tlaGNC tlaBgGNC">  1207816920 :             dfsalt = ice_ref_salinity*p001*dfresh</span></span>
<span id="L1501"><span class="lineNum">    1501</span>              :          endif</span>
<span id="L1502"><span class="lineNum">    1502</span> <span class="tlaGNC">  1207816920 :          fresh  = fresh + dfresh</span></span>
<span id="L1503"><span class="lineNum">    1503</span> <span class="tlaGNC">  1207816920 :          fsalt  = fsalt + dfsalt</span></span>
<span id="L1504"><span class="lineNum">    1504</span>              :       endif</span>
<span id="L1505"><span class="lineNum">    1505</span>              : </span>
<span id="L1506"><span class="lineNum">    1506</span>              :       !-----------------------------------------------------------------</span>
<span id="L1507"><span class="lineNum">    1507</span>              :       ! Decide how to distribute the new ice.</span>
<span id="L1508"><span class="lineNum">    1508</span>              :       !-----------------------------------------------------------------</span>
<span id="L1509"><span class="lineNum">    1509</span>              : </span>
<span id="L1510"><span class="lineNum">    1510</span> <span class="tlaGNC">  1207816920 :       if (vi0new &gt; c0) then</span></span>
<span id="L1511"><span class="lineNum">    1511</span>              : </span>
<span id="L1512"><span class="lineNum">    1512</span> <span class="tlaGNC">   137154774 :         if (tr_fsd) then ! lateral growth of existing ice</span></span>
<span id="L1513"><span class="lineNum">    1513</span>              :             ! calculate change in conc due to lateral growth</span>
<span id="L1514"><span class="lineNum">    1514</span>              :             ! update vi0new, without change to afsdn or aicen</span>
<span id="L1515"><span class="lineNum">    1515</span>              :             call fsd_lateral_growth(dt,       aice,         &amp;</span>
<span id="L1516"><span class="lineNum">    1516</span> <span class="tlaUNC tlaBgUNC">           0 :                                   aicen,      vicen,        &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1517"><span class="lineNum">    1517</span>              :                                   vi0new,     frazil,       &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1518"><span class="lineNum">    1518</span>              :                                   afsdn,        &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1519"><span class="lineNum">    1519</span>              :                                   lead_area,  latsurf_area, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1520"><span class="lineNum">    1520</span>              :                                   G_radial,   d_an_latg,    &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1521"><span class="lineNum">    1521</span> <span class="tlaGNC tlaBgGNC">      452820 :                                   tot_latg)</span></span>
<span id="L1522"><span class="lineNum">    1522</span> <span class="tlaGNC">      452820 :             if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1523"><span class="lineNum">    1523</span>              : </span>
<span id="L1524"><span class="lineNum">    1524</span>              :             ! volume added to each category from lateral growth</span>
<span id="L1525"><span class="lineNum">    1525</span> <span class="tlaGNC">     2716920 :             do n = 1, ncat</span></span>
<span id="L1526"><span class="lineNum">    1526</span> <span class="tlaGNC">     2716920 :                if (aicen(n) &gt; puny) then</span></span>
<span id="L1527"><span class="lineNum">    1527</span> <span class="tlaGNC">     2262122 :                    vin0new(n) = d_an_latg(n) * vicen(n)/aicen(n)</span></span>
<span id="L1528"><span class="lineNum">    1528</span>              :                endif</span>
<span id="L1529"><span class="lineNum">    1529</span>              :             end do</span>
<span id="L1530"><span class="lineNum">    1530</span>              : </span>
<span id="L1531"><span class="lineNum">    1531</span>              :             ! check lateral growth doesn't exceed total growth</span>
<span id="L1532"><span class="lineNum">    1532</span>              :             ! if it does, adjust it</span>
<span id="L1533"><span class="lineNum">    1533</span> <span class="tlaGNC">     2716920 :             if (SUM(vin0new)&gt;vi0new) then</span></span>
<span id="L1534"><span class="lineNum">    1534</span> <span class="tlaUNC tlaBgUNC">           0 :                 write(warnstr,*) subname,'lateral growth warning ',vi0new,SUM(vin0new)</span></span>
<span id="L1535"><span class="lineNum">    1535</span> <span class="tlaUNC">           0 :                 call icepack_warnings_add(warnstr)</span></span>
<span id="L1536"><span class="lineNum">    1536</span> <span class="tlaUNC">           0 :                 vin0new(:) = vin0new(:)*vi0new/SUM(vin0new)</span></span>
<span id="L1537"><span class="lineNum">    1537</span>              :             end if</span>
<span id="L1538"><span class="lineNum">    1538</span>              : </span>
<span id="L1539"><span class="lineNum">    1539</span> <span class="tlaGNC tlaBgGNC">     2716920 :             vi0new = vi0new - SUM(vin0new)</span></span>
<span id="L1540"><span class="lineNum">    1540</span> <span class="tlaGNC">     2716920 :             frazil = frazil - SUM(vin0new)</span></span>
<span id="L1541"><span class="lineNum">    1541</span>              : </span>
<span id="L1542"><span class="lineNum">    1542</span>              :          endif</span>
<span id="L1543"><span class="lineNum">    1543</span>              : </span>
<span id="L1544"><span class="lineNum">    1544</span> <span class="tlaGNC">   137154774 :          ai0mod = aice0</span></span>
<span id="L1545"><span class="lineNum">    1545</span>              :          ! separate frazil ice growth from lateral ice growth</span>
<span id="L1546"><span class="lineNum">    1546</span> <span class="tlaGNC">   137154774 :          if (tr_fsd) ai0mod = aice0-tot_latg</span></span>
<span id="L1547"><span class="lineNum">    1547</span>              : </span>
<span id="L1548"><span class="lineNum">    1548</span>              :          ! new ice area and thickness</span>
<span id="L1549"><span class="lineNum">    1549</span>              :          ! hin_max(0) &lt; new ice thickness &lt; hin_max(1)</span>
<span id="L1550"><span class="lineNum">    1550</span> <span class="tlaGNC">   137154774 :          if (ai0mod &gt; puny) then</span></span>
<span id="L1551"><span class="lineNum">    1551</span> <span class="tlaGNC">   132732097 :             hi0new = max(vi0new/ai0mod, hfrazilmin)</span></span>
<span id="L1552"><span class="lineNum">    1552</span> <span class="tlaGNC">   132732097 :             if (hi0new &gt; hi0max .and. ai0mod+puny &lt; c1) then</span></span>
<span id="L1553"><span class="lineNum">    1553</span>              :                ! distribute excess volume over all categories (below)</span>
<span id="L1554"><span class="lineNum">    1554</span> <span class="tlaGNC">    67938429 :                hi0new = hi0max</span></span>
<span id="L1555"><span class="lineNum">    1555</span> <span class="tlaGNC">    67938429 :                ai0new = ai0mod</span></span>
<span id="L1556"><span class="lineNum">    1556</span> <span class="tlaGNC">    67938429 :                vsurp  = vi0new - ai0new*hi0new</span></span>
<span id="L1557"><span class="lineNum">    1557</span> <span class="tlaGNC">    67938429 :                hsurp  = vsurp / aice</span></span>
<span id="L1558"><span class="lineNum">    1558</span> <span class="tlaGNC">    67938429 :                vi0new = ai0new*hi0new</span></span>
<span id="L1559"><span class="lineNum">    1559</span>              :             else</span>
<span id="L1560"><span class="lineNum">    1560</span>              :                ! put ice in a single category, with hsurp = 0</span>
<span id="L1561"><span class="lineNum">    1561</span> <span class="tlaGNC">    64793668 :                ai0new = vi0new/hi0new</span></span>
<span id="L1562"><span class="lineNum">    1562</span>              :             endif</span>
<span id="L1563"><span class="lineNum">    1563</span>              :          else                ! aice0 &lt; puny</span>
<span id="L1564"><span class="lineNum">    1564</span> <span class="tlaGNC">     4422677 :             hsurp = vi0new/aice ! new thickness in each cat</span></span>
<span id="L1565"><span class="lineNum">    1565</span> <span class="tlaGNC">     4422677 :             vi0new = c0</span></span>
<span id="L1566"><span class="lineNum">    1566</span>              :          endif               ! aice0 &gt; puny</span>
<span id="L1567"><span class="lineNum">    1567</span>              : </span>
<span id="L1568"><span class="lineNum">    1568</span>              :          ! combine areal change from new ice growth and lateral growth</span>
<span id="L1569"><span class="lineNum">    1569</span> <span class="tlaGNC">   137154774 :          d_an_newi(1)     = ai0new</span></span>
<span id="L1570"><span class="lineNum">    1570</span> <span class="tlaGNC">   683813189 :          d_an_tot(2:ncat) = d_an_latg(2:ncat)</span></span>
<span id="L1571"><span class="lineNum">    1571</span> <span class="tlaGNC">   137154774 :          d_an_tot(1)      = d_an_latg(1) + d_an_newi(1)</span></span>
<span id="L1572"><span class="lineNum">    1572</span> <span class="tlaGNC">   137154774 :          if (tr_fsd) then</span></span>
<span id="L1573"><span class="lineNum">    1573</span> <span class="tlaGNC">      452820 :             vin0new(1)    = vin0new(1) + ai0new*hi0new ! not BFB</span></span>
<span id="L1574"><span class="lineNum">    1574</span>              :          else</span>
<span id="L1575"><span class="lineNum">    1575</span> <span class="tlaGNC">   136701954 :             vin0new(1)    = vi0new</span></span>
<span id="L1576"><span class="lineNum">    1576</span>              :          endif</span>
<span id="L1577"><span class="lineNum">    1577</span>              : </span>
<span id="L1578"><span class="lineNum">    1578</span>              :       endif                  ! vi0new &gt; puny</span>
<span id="L1579"><span class="lineNum">    1579</span>              : </span>
<span id="L1580"><span class="lineNum">    1580</span>              :       !-----------------------------------------------------------------</span>
<span id="L1581"><span class="lineNum">    1581</span>              :       ! Distribute excess ice volume among ice categories by increasing</span>
<span id="L1582"><span class="lineNum">    1582</span>              :       ! ice thickness, leaving ice area unchanged.</span>
<span id="L1583"><span class="lineNum">    1583</span>              :       !</span>
<span id="L1584"><span class="lineNum">    1584</span>              :       ! NOTE: If new ice contains globally conserved tracers</span>
<span id="L1585"><span class="lineNum">    1585</span>              :       !       (e.g., isotopes from seawater), code must be added here.</span>
<span id="L1586"><span class="lineNum">    1586</span>              :       !</span>
<span id="L1587"><span class="lineNum">    1587</span>              :       ! The mushy formulation (ktherm=2) puts the new ice only at the</span>
<span id="L1588"><span class="lineNum">    1588</span>              :       ! bottom of existing ice and adjusts the layers accordingly.</span>
<span id="L1589"><span class="lineNum">    1589</span>              :       ! The other formulations distribute the new ice throughout the</span>
<span id="L1590"><span class="lineNum">    1590</span>              :       ! existing ice column.</span>
<span id="L1591"><span class="lineNum">    1591</span>              :       !-----------------------------------------------------------------</span>
<span id="L1592"><span class="lineNum">    1592</span>              : </span>
<span id="L1593"><span class="lineNum">    1593</span> <span class="tlaGNC">  1207816920 :       if (hsurp &gt; c0) then   ! add ice to all categories</span></span>
<span id="L1594"><span class="lineNum">    1594</span>              : </span>
<span id="L1595"><span class="lineNum">    1595</span> <span class="tlaGNC">   435119704 :          do n = 1, ncat</span></span>
<span id="L1596"><span class="lineNum">    1596</span>              : </span>
<span id="L1597"><span class="lineNum">    1597</span> <span class="tlaGNC">   362758598 :             vsurp = hsurp * aicen(n)</span></span>
<span id="L1598"><span class="lineNum">    1598</span>              : </span>
<span id="L1599"><span class="lineNum">    1599</span>              :             ! update ice age due to freezing (new ice age = dt)</span>
<span id="L1600"><span class="lineNum">    1600</span> <span class="tlaGNC">   362758598 :             vtmp = vicen(n) + vsurp</span></span>
<span id="L1601"><span class="lineNum">    1601</span> <span class="tlaGNC">   362758598 :             if (tr_iage .and. vtmp &gt; puny) &amp;</span></span>
<span id="L1602"><span class="lineNum">    1602</span> <span class="tlaGNC">    27871860 :                 trcrn(nt_iage,n) = &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1603"><span class="lineNum">    1603</span> <span class="tlaGNC">   382499072 :                (trcrn(nt_iage,n)*vicen(n) + dt*vsurp) / vtmp</span></span>
<span id="L1604"><span class="lineNum">    1604</span>              : </span>
<span id="L1605"><span class="lineNum">    1605</span> <span class="tlaGNC">   362758598 :             if (tr_lvl .and. vicen(n) &gt; puny) then</span></span>
<span id="L1606"><span class="lineNum">    1606</span> <span class="tlaGNC">    28547060 :                 trcrn(nt_vlvl,n) = &amp;</span></span>
<span id="L1607"><span class="lineNum">    1607</span> <span class="tlaGNC">    42820590 :                (trcrn(nt_vlvl,n)*vicen(n) + &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1608"><span class="lineNum">    1608</span> <span class="tlaGNC">   426670062 :                 trcrn(nt_alvl,n)*vsurp) / vtmp</span></span>
<span id="L1609"><span class="lineNum">    1609</span>              :             endif</span>
<span id="L1610"><span class="lineNum">    1610</span>              : </span>
<span id="L1611"><span class="lineNum">    1611</span> <span class="tlaGNC">   362758598 :             if (tr_aero .and. vtmp &gt; puny) then</span></span>
<span id="L1612"><span class="lineNum">    1612</span> <span class="tlaGNC">     4781564 :                do it = 1, n_aero</span></span>
<span id="L1613"><span class="lineNum">    1613</span> <span class="tlaGNC">     1143678 :                   trcrn(nt_aero+2+4*(it-1),n) = &amp;</span></span>
<span id="L1614"><span class="lineNum">    1614</span> <span class="tlaGNC">     3534460 :                   trcrn(nt_aero+2+4*(it-1),n)*vicen(n) / vtmp</span></span>
<span id="L1615"><span class="lineNum">    1615</span> <span class="tlaGNC">     1143678 :                   trcrn(nt_aero+3+4*(it-1),n) = &amp;</span></span>
<span id="L1616"><span class="lineNum">    1616</span> <span class="tlaGNC">     5925242 :                   trcrn(nt_aero+3+4*(it-1),n)*vicen(n) / vtmp</span></span>
<span id="L1617"><span class="lineNum">    1617</span>              :                enddo</span>
<span id="L1618"><span class="lineNum">    1618</span>              :             endif</span>
<span id="L1619"><span class="lineNum">    1619</span>              : </span>
<span id="L1620"><span class="lineNum">    1620</span> <span class="tlaGNC">   362758598 :            if (tr_iso .and. vtmp &gt; puny) then</span></span>
<span id="L1621"><span class="lineNum">    1621</span> <span class="tlaGNC">     3263632 :              do it=1,n_iso</span></span>
<span id="L1622"><span class="lineNum">    1622</span> <span class="tlaGNC">     2447724 :                frazil_conc = c0</span></span>
<span id="L1623"><span class="lineNum">    1623</span> <span class="tlaGNC">     2447724 :                if (it==1) &amp;</span></span>
<span id="L1624"><span class="lineNum">    1624</span> <span class="tlaGNC">      815908 :                   frazil_conc = isoice_alpha(c0,'HDO'   ,isotope_frac_method)*HDO_ocn</span></span>
<span id="L1625"><span class="lineNum">    1625</span> <span class="tlaGNC">     2447724 :                if (it==2) &amp;</span></span>
<span id="L1626"><span class="lineNum">    1626</span> <span class="tlaGNC">      815908 :                   frazil_conc = isoice_alpha(c0,'H2_16O',isotope_frac_method)*H2_16O_ocn</span></span>
<span id="L1627"><span class="lineNum">    1627</span> <span class="tlaGNC">     2447724 :                if (it==3) &amp;</span></span>
<span id="L1628"><span class="lineNum">    1628</span> <span class="tlaGNC">      815908 :                   frazil_conc = isoice_alpha(c0,'H2_18O',isotope_frac_method)*H2_18O_ocn</span></span>
<span id="L1629"><span class="lineNum">    1629</span>              : </span>
<span id="L1630"><span class="lineNum">    1630</span>              :                ! dilution and uptake in the ice</span>
<span id="L1631"><span class="lineNum">    1631</span> <span class="tlaGNC">      323622 :                trcrn(nt_isoice+it-1,n)  &amp;</span></span>
<span id="L1632"><span class="lineNum">    1632</span> <span class="tlaGNC">      485433 :                    = (trcrn(nt_isoice+it-1,n)*vicen(n) &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1633"><span class="lineNum">    1633</span>              :                    + frazil_conc*rhoi*vsurp) &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1634"><span class="lineNum">    1634</span> <span class="tlaGNC">     3094968 :                    / vtmp</span></span>
<span id="L1635"><span class="lineNum">    1635</span>              : </span>
<span id="L1636"><span class="lineNum">    1636</span> <span class="tlaGNC">      323622 :                fiso_ocn(it) = fiso_ocn(it) &amp;</span></span>
<span id="L1637"><span class="lineNum">    1637</span> <span class="tlaGNC">     3587254 :                             - frazil_conc*rhoi*vsurp/dt</span></span>
<span id="L1638"><span class="lineNum">    1638</span>              :              enddo</span>
<span id="L1639"><span class="lineNum">    1639</span>              :             endif</span>
<span id="L1640"><span class="lineNum">    1640</span>              : </span>
<span id="L1641"><span class="lineNum">    1641</span>              :             ! update category volumes</span>
<span id="L1642"><span class="lineNum">    1642</span> <span class="tlaGNC">   362758598 :             vicen(n) = vtmp</span></span>
<span id="L1643"><span class="lineNum">    1643</span>              : </span>
<span id="L1644"><span class="lineNum">    1644</span> <span class="tlaGNC">   435119704 :             if (ktherm == 2) then</span></span>
<span id="L1645"><span class="lineNum">    1645</span> <span class="tlaGNC">   349224050 :                vsurp = hsurp * aicen(n)  ! note - save this above?</span></span>
<span id="L1646"><span class="lineNum">    1646</span> <span class="tlaGNC">   349224050 :                vtmp = vicen(n) - vsurp   ! vicen is the new volume</span></span>
<span id="L1647"><span class="lineNum">    1647</span> <span class="tlaGNC">   349224050 :                if (vicen(n) &gt; c0) then</span></span>
<span id="L1648"><span class="lineNum">    1648</span>              :                   call update_vertical_tracers( &amp;</span>
<span id="L1649"><span class="lineNum">    1649</span> <span class="tlaUNC tlaBgUNC">           0 :                               trcrn(nt_qice:nt_qice+nilyr-1,n), &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1650"><span class="lineNum">    1650</span> <span class="tlaGNC tlaBgGNC">   349163900 :                               vtmp, vicen(n), qi0new)</span></span>
<span id="L1651"><span class="lineNum">    1651</span> <span class="tlaGNC">   349163900 :                   if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1652"><span class="lineNum">    1652</span>              :                   call update_vertical_tracers( &amp;</span>
<span id="L1653"><span class="lineNum">    1653</span> <span class="tlaUNC tlaBgUNC">           0 :                               trcrn(nt_sice:nt_sice+nilyr-1,n), &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1654"><span class="lineNum">    1654</span> <span class="tlaGNC tlaBgGNC">   349163900 :                               vtmp, vicen(n), Si0new)</span></span>
<span id="L1655"><span class="lineNum">    1655</span> <span class="tlaGNC">   349163900 :                   if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1656"><span class="lineNum">    1656</span>              :                endif</span>
<span id="L1657"><span class="lineNum">    1657</span>              :             else</span>
<span id="L1658"><span class="lineNum">    1658</span> <span class="tlaGNC">    36841584 :                do k = 1, nilyr</span></span>
<span id="L1659"><span class="lineNum">    1659</span>              :                   ! factor of nilyr cancels out</span>
<span id="L1660"><span class="lineNum">    1660</span> <span class="tlaGNC">    23307036 :                   vsurp = hsurp * aicen(n)  ! note - save this above?</span></span>
<span id="L1661"><span class="lineNum">    1661</span> <span class="tlaGNC">    23307036 :                   vtmp = vicen(n) - vsurp      ! vicen is the new volume</span></span>
<span id="L1662"><span class="lineNum">    1662</span> <span class="tlaGNC">    36841584 :                   if (vicen(n) &gt; c0) then</span></span>
<span id="L1663"><span class="lineNum">    1663</span>              :                      ! enthalpy</span>
<span id="L1664"><span class="lineNum">    1664</span> <span class="tlaGNC">    10283934 :                      trcrn(nt_qice+k-1,n) = &amp;</span></span>
<span id="L1665"><span class="lineNum">    1665</span> <span class="tlaGNC">    30930219 :                     (trcrn(nt_qice+k-1,n)*vtmp + qi0new*vsurp) / vicen(n)</span></span>
<span id="L1666"><span class="lineNum">    1666</span>              :                      ! salinity</span>
<span id="L1667"><span class="lineNum">    1667</span> <span class="tlaGNC">    10283934 :                      trcrn(nt_sice+k-1,n) = &amp;</span></span>
<span id="L1668"><span class="lineNum">    1668</span> <span class="tlaGNC">    30930219 :                     (trcrn(nt_sice+k-1,n)*vtmp + Sprofile(k)*vsurp) / vicen(n)</span></span>
<span id="L1669"><span class="lineNum">    1669</span>              :                   endif</span>
<span id="L1670"><span class="lineNum">    1670</span>              :                enddo               ! k</span>
<span id="L1671"><span class="lineNum">    1671</span>              :             endif                  ! ktherm</span>
<span id="L1672"><span class="lineNum">    1672</span>              : </span>
<span id="L1673"><span class="lineNum">    1673</span>              :          enddo                     ! n</span>
<span id="L1674"><span class="lineNum">    1674</span>              : </span>
<span id="L1675"><span class="lineNum">    1675</span>              :       endif ! hsurp &gt; 0</span>
<span id="L1676"><span class="lineNum">    1676</span>              : </span>
<span id="L1677"><span class="lineNum">    1677</span>              :       !-----------------------------------------------------------------</span>
<span id="L1678"><span class="lineNum">    1678</span>              :       ! Combine new ice grown in open water with ice categories.</span>
<span id="L1679"><span class="lineNum">    1679</span>              :       ! Using the floe size distribution, ice is added laterally to all</span>
<span id="L1680"><span class="lineNum">    1680</span>              :       ! categories; otherwise it is added to category 1.</span>
<span id="L1681"><span class="lineNum">    1681</span>              :       ! Assume that vsnon and esnon are unchanged.</span>
<span id="L1682"><span class="lineNum">    1682</span>              :       ! The mushy formulation assumes salt from frazil is added uniformly</span>
<span id="L1683"><span class="lineNum">    1683</span>              :       ! to category 1, while the others use a salinity profile.</span>
<span id="L1684"><span class="lineNum">    1684</span>              :       !-----------------------------------------------------------------</span>
<span id="L1685"><span class="lineNum">    1685</span>              : </span>
<span id="L1686"><span class="lineNum">    1686</span> <span class="tlaGNC">  1207816920 :       ncats = 1                  ! add new ice to category 1 by default</span></span>
<span id="L1687"><span class="lineNum">    1687</span> <span class="tlaGNC">  1207816920 :       if (tr_fsd) ncats = ncat   ! add new ice laterally to all categories</span></span>
<span id="L1688"><span class="lineNum">    1688</span>              : </span>
<span id="L1689"><span class="lineNum">    1689</span> <span class="tlaGNC">  2436385392 :       do n = 1, ncats</span></span>
<span id="L1690"><span class="lineNum">    1690</span>              : </span>
<span id="L1691"><span class="lineNum">    1691</span> <span class="tlaGNC">  2436385392 :       if (d_an_tot(n) &gt; c0 .and. vin0new(n) &gt; c0) then  ! add ice to category n</span></span>
<span id="L1692"><span class="lineNum">    1692</span>              : </span>
<span id="L1693"><span class="lineNum">    1693</span> <span class="tlaGNC">   134377054 :          area1    = aicen(n)   ! save</span></span>
<span id="L1694"><span class="lineNum">    1694</span> <span class="tlaGNC">   134377054 :          vice1    = vicen(n)   ! save</span></span>
<span id="L1695"><span class="lineNum">    1695</span> <span class="tlaGNC">   134377054 :          area2(n) = aicen_init(n) + d_an_latg(n) ! save area after latg, before newi</span></span>
<span id="L1696"><span class="lineNum">    1696</span> <span class="tlaGNC">   134377054 :          aicen(n) = aicen(n) + d_an_tot(n) ! after lateral growth and new ice growth</span></span>
<span id="L1697"><span class="lineNum">    1697</span>              : </span>
<span id="L1698"><span class="lineNum">    1698</span> <span class="tlaGNC">   134377054 :          aice0    = aice0    - d_an_tot(n)</span></span>
<span id="L1699"><span class="lineNum">    1699</span> <span class="tlaGNC">   134377054 :          vicen(n) = vicen(n) + vin0new(n)</span></span>
<span id="L1700"><span class="lineNum">    1700</span>              : </span>
<span id="L1701"><span class="lineNum">    1701</span> <span class="tlaGNC">   134377054 :          trcrn(nt_Tsfc,n) = (trcrn(nt_Tsfc,n)*area1 + Tf*d_an_tot(n))/aicen(n)</span></span>
<span id="L1702"><span class="lineNum">    1702</span> <span class="tlaGNC">   134377054 :          trcrn(nt_Tsfc,n) = min (trcrn(nt_Tsfc,n), c0)</span></span>
<span id="L1703"><span class="lineNum">    1703</span>              : </span>
<span id="L1704"><span class="lineNum">    1704</span> <span class="tlaGNC">   134377054 :          if (tr_FY) then</span></span>
<span id="L1705"><span class="lineNum">    1705</span> <span class="tlaGNC">   110315961 :             trcrn(nt_FY,n) = (trcrn(nt_FY,n)*area1 + d_an_tot(n))/aicen(n)</span></span>
<span id="L1706"><span class="lineNum">    1706</span> <span class="tlaGNC">   110315961 :             trcrn(nt_FY,n) = min(trcrn(nt_FY,n), c1)</span></span>
<span id="L1707"><span class="lineNum">    1707</span>              :          endif</span>
<span id="L1708"><span class="lineNum">    1708</span>              : </span>
<span id="L1709"><span class="lineNum">    1709</span> <span class="tlaGNC">   134377054 :          if (tr_fsd) then ! evolve the floe size distribution</span></span>
<span id="L1710"><span class="lineNum">    1710</span>              :             ! both new frazil ice and lateral growth</span>
<span id="L1711"><span class="lineNum">    1711</span>              :             call fsd_add_new_ice (n,                         &amp;</span>
<span id="L1712"><span class="lineNum">    1712</span>              :                                   dt,         ai0new,        &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1713"><span class="lineNum">    1713</span> <span class="tlaUNC tlaBgUNC">           0 :                                   d_an_latg,  d_an_newi,     &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1714"><span class="lineNum">    1714</span> <span class="tlaUNC">           0 :                                   G_radial,   area2,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1715"><span class="lineNum">    1715</span>              :                                   wave_sig_ht,               &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1716"><span class="lineNum">    1716</span> <span class="tlaUNC">           0 :                                   wave_spectrum,             &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1717"><span class="lineNum">    1717</span> <span class="tlaUNC">           0 :                                   wavefreq,                  &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1718"><span class="lineNum">    1718</span> <span class="tlaUNC">           0 :                                   dwavefreq,                 &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1719"><span class="lineNum">    1719</span> <span class="tlaUNC">           0 :                                   d_afsd_latg,               &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1720"><span class="lineNum">    1720</span> <span class="tlaUNC">           0 :                                   d_afsd_newi,               &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1721"><span class="lineNum">    1721</span> <span class="tlaUNC">           0 :                                   afsdn,      aicen_init,    &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1722"><span class="lineNum">    1722</span> <span class="tlaGNC tlaBgGNC">     2078316 :                                   aicen,      trcrn)</span></span>
<span id="L1723"><span class="lineNum">    1723</span> <span class="tlaGNC">     2078316 :             if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1724"><span class="lineNum">    1724</span>              :          endif</span>
<span id="L1725"><span class="lineNum">    1725</span>              : </span>
<span id="L1726"><span class="lineNum">    1726</span> <span class="tlaGNC">   134377054 :          if (vicen(n) &gt; puny) then</span></span>
<span id="L1727"><span class="lineNum">    1727</span> <span class="tlaGNC">   134376916 :             if (tr_iage) &amp;</span></span>
<span id="L1728"><span class="lineNum">    1728</span> <span class="tlaGNC">   115485240 :                trcrn(nt_iage,n) = (trcrn(nt_iage,n)*vice1 + dt*vin0new(n))/vicen(n)</span></span>
<span id="L1729"><span class="lineNum">    1729</span>              : </span>
<span id="L1730"><span class="lineNum">    1730</span> <span class="tlaGNC">   134376916 :             if (tr_aero) then</span></span>
<span id="L1731"><span class="lineNum">    1731</span> <span class="tlaGNC">     2692910 :                do it = 1, n_aero</span></span>
<span id="L1732"><span class="lineNum">    1732</span> <span class="tlaGNC">      613740 :                   trcrn(nt_aero+2+4*(it-1),n) = &amp;</span></span>
<span id="L1733"><span class="lineNum">    1733</span> <span class="tlaGNC">     1960195 :                   trcrn(nt_aero+2+4*(it-1),n)*vice1/vicen(n)</span></span>
<span id="L1734"><span class="lineNum">    1734</span> <span class="tlaGNC">      613740 :                   trcrn(nt_aero+3+4*(it-1),n) = &amp;</span></span>
<span id="L1735"><span class="lineNum">    1735</span> <span class="tlaGNC">     3306650 :                   trcrn(nt_aero+3+4*(it-1),n)*vice1/vicen(n)</span></span>
<span id="L1736"><span class="lineNum">    1736</span>              :                enddo</span>
<span id="L1737"><span class="lineNum">    1737</span>              :             endif</span>
<span id="L1738"><span class="lineNum">    1738</span>              : </span>
<span id="L1739"><span class="lineNum">    1739</span> <span class="tlaGNC">   134376916 :            if (tr_iso) then</span></span>
<span id="L1740"><span class="lineNum">    1740</span> <span class="tlaGNC">     1032216 :               do it=1,n_iso</span></span>
<span id="L1741"><span class="lineNum">    1741</span> <span class="tlaGNC">      774162 :                 frazil_conc = c0</span></span>
<span id="L1742"><span class="lineNum">    1742</span> <span class="tlaGNC">      774162 :                 if (it==1) &amp;</span></span>
<span id="L1743"><span class="lineNum">    1743</span> <span class="tlaGNC">      258054 :                    frazil_conc = isoice_alpha(c0,'HDO'   ,isotope_frac_method)*HDO_ocn</span></span>
<span id="L1744"><span class="lineNum">    1744</span> <span class="tlaGNC">      774162 :                 if (it==2) &amp;</span></span>
<span id="L1745"><span class="lineNum">    1745</span> <span class="tlaGNC">      258054 :                    frazil_conc = isoice_alpha(c0,'H2_16O',isotope_frac_method)*H2_16O_ocn</span></span>
<span id="L1746"><span class="lineNum">    1746</span> <span class="tlaGNC">      774162 :                 if (it==3) &amp;</span></span>
<span id="L1747"><span class="lineNum">    1747</span> <span class="tlaGNC">      258054 :                    frazil_conc = isoice_alpha(c0,'H2_18O',isotope_frac_method)*H2_18O_ocn</span></span>
<span id="L1748"><span class="lineNum">    1748</span>              : </span>
<span id="L1749"><span class="lineNum">    1749</span> <span class="tlaGNC">       94248 :                 trcrn(nt_isoice+it-1,1) &amp;</span></span>
<span id="L1750"><span class="lineNum">    1750</span> <span class="tlaGNC">       94248 :                   = (trcrn(nt_isoice+it-1,1)*vice1) &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1751"><span class="lineNum">    1751</span> <span class="tlaGNC">      868410 :                   + frazil_conc*rhoi*vi0new/vicen(1)</span></span>
<span id="L1752"><span class="lineNum">    1752</span>              : </span>
<span id="L1753"><span class="lineNum">    1753</span> <span class="tlaGNC">       94248 :                 fiso_ocn(it) = fiso_ocn(it) &amp;</span></span>
<span id="L1754"><span class="lineNum">    1754</span> <span class="tlaGNC">     1126464 :                              - frazil_conc*rhoi*vi0new/dt</span></span>
<span id="L1755"><span class="lineNum">    1755</span>              :               enddo</span>
<span id="L1756"><span class="lineNum">    1756</span>              :            endif  ! if iso</span>
<span id="L1757"><span class="lineNum">    1757</span>              : </span>
<span id="L1758"><span class="lineNum">    1758</span> <span class="tlaGNC">   134376916 :             if (tr_lvl) then</span></span>
<span id="L1759"><span class="lineNum">    1759</span> <span class="tlaGNC">   121186508 :                 alvl = trcrn(nt_alvl,n)</span></span>
<span id="L1760"><span class="lineNum">    1760</span> <span class="tlaGNC">    20248750 :                 trcrn(nt_alvl,n) = &amp;</span></span>
<span id="L1761"><span class="lineNum">    1761</span> <span class="tlaGNC">   141435258 :                (trcrn(nt_alvl,n)*area1 + d_an_tot(n))/aicen(n)</span></span>
<span id="L1762"><span class="lineNum">    1762</span> <span class="tlaGNC">    20248750 :                 trcrn(nt_vlvl,n) = &amp;</span></span>
<span id="L1763"><span class="lineNum">    1763</span> <span class="tlaGNC">   141435258 :                (trcrn(nt_vlvl,n)*vice1 + vin0new(n))/vicen(n)</span></span>
<span id="L1764"><span class="lineNum">    1764</span>              :             endif</span>
<span id="L1765"><span class="lineNum">    1765</span>              : </span>
<span id="L1766"><span class="lineNum">    1766</span> <span class="tlaGNC">   134376916 :             if (tr_pond_topo) then</span></span>
<span id="L1767"><span class="lineNum">    1767</span> <span class="tlaGNC">      574248 :                trcrn(nt_apnd,n) = &amp;</span></span>
<span id="L1768"><span class="lineNum">    1768</span> <span class="tlaGNC">     1394782 :                trcrn(nt_apnd,n)*area1/aicen(n)</span></span>
<span id="L1769"><span class="lineNum">    1769</span> <span class="tlaGNC">   133556382 :             elseif (tr_pond_lvl) then</span></span>
<span id="L1770"><span class="lineNum">    1770</span> <span class="tlaGNC">   103348081 :                if (trcrn(nt_alvl,n) &gt; puny) then</span></span>
<span id="L1771"><span class="lineNum">    1771</span> <span class="tlaGNC">    12165490 :                   trcrn(nt_apnd,n) = &amp;</span></span>
<span id="L1772"><span class="lineNum">    1772</span> <span class="tlaGNC">   115513571 :                   trcrn(nt_apnd,n) * alvl*area1 / (trcrn(nt_alvl,n)*aicen(n))</span></span>
<span id="L1773"><span class="lineNum">    1773</span>              :                endif</span>
<span id="L1774"><span class="lineNum">    1774</span>              :             endif</span>
<span id="L1775"><span class="lineNum">    1775</span>              :          endif ! vicen &gt; 0</span>
<span id="L1776"><span class="lineNum">    1776</span>              : </span>
<span id="L1777"><span class="lineNum">    1777</span> <span class="tlaGNC">   901956686 :          do k = 1, nilyr</span></span>
<span id="L1778"><span class="lineNum">    1778</span> <span class="tlaGNC">   901956686 :             if (vicen(n) &gt; c0) then</span></span>
<span id="L1779"><span class="lineNum">    1779</span>              :                ! factor of nilyr cancels out</span>
<span id="L1780"><span class="lineNum">    1780</span>              :                ! enthalpy</span>
<span id="L1781"><span class="lineNum">    1781</span> <span class="tlaGNC">   113892308 :                trcrn(nt_qice+k-1,n) = &amp;</span></span>
<span id="L1782"><span class="lineNum">    1782</span> <span class="tlaGNC">   881471940 :               (trcrn(nt_qice+k-1,n)*vice1 + qi0new*vin0new(n))/vicen(n)</span></span>
<span id="L1783"><span class="lineNum">    1783</span>              :                ! salinity</span>
<span id="L1784"><span class="lineNum">    1784</span> <span class="tlaGNC">   113892308 :                trcrn(nt_sice+k-1,n) = &amp;</span></span>
<span id="L1785"><span class="lineNum">    1785</span> <span class="tlaGNC">   881471940 :               (trcrn(nt_sice+k-1,n)*vice1 + Sprofile(k)*vin0new(n))/vicen(n)</span></span>
<span id="L1786"><span class="lineNum">    1786</span>              :             endif</span>
<span id="L1787"><span class="lineNum">    1787</span>              :          enddo ! nilyr</span>
<span id="L1788"><span class="lineNum">    1788</span>              :       endif ! vin0new &gt; c0</span>
<span id="L1789"><span class="lineNum">    1789</span>              :       enddo ! n</span>
<span id="L1790"><span class="lineNum">    1790</span>              : </span>
<span id="L1791"><span class="lineNum">    1791</span> <span class="tlaGNC">  1207816920 :       if (conserv_check) then</span></span>
<span id="L1792"><span class="lineNum">    1792</span>              : </span>
<span id="L1793"><span class="lineNum">    1793</span> <span class="tlaGNC">    61870368 :          do n = 1, ncat</span></span>
<span id="L1794"><span class="lineNum">    1794</span> <span class="tlaGNC">    53031744 :             eicen(n) = c0</span></span>
<span id="L1795"><span class="lineNum">    1795</span> <span class="tlaGNC">   433092576 :             do k = 1, nilyr</span></span>
<span id="L1796"><span class="lineNum">    1796</span> <span class="tlaGNC">   516483072 :                eicen(n) = eicen(n) + trcrn(nt_qice+k-1,n) &amp;</span></span>
<span id="L1797"><span class="lineNum">    1797</span> <span class="tlaGNC">   940737024 :                         * vicen(n)/real(nilyr,kind=dbl_kind)</span></span>
<span id="L1798"><span class="lineNum">    1798</span>              :             enddo</span>
<span id="L1799"><span class="lineNum">    1799</span>              :          enddo</span>
<span id="L1800"><span class="lineNum">    1800</span> <span class="tlaGNC">     8838624 :          call column_sum (ncat, vicen, vice_final)</span></span>
<span id="L1801"><span class="lineNum">    1801</span> <span class="tlaGNC">     8838624 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1802"><span class="lineNum">    1802</span> <span class="tlaGNC">     8838624 :          call column_sum (ncat, eicen, eice_final)</span></span>
<span id="L1803"><span class="lineNum">    1803</span> <span class="tlaGNC">     8838624 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1804"><span class="lineNum">    1804</span>              : </span>
<span id="L1805"><span class="lineNum">    1805</span> <span class="tlaGNC">     8838624 :          fieldid = subname//':vice'</span></span>
<span id="L1806"><span class="lineNum">    1806</span>              :          call column_conservation_check (fieldid,               &amp;</span>
<span id="L1807"><span class="lineNum">    1807</span>              :                                          vice_init, vice_final, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1808"><span class="lineNum">    1808</span> <span class="tlaGNC">     8838624 :                                          puny)</span></span>
<span id="L1809"><span class="lineNum">    1809</span> <span class="tlaGNC">     8838624 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1810"><span class="lineNum">    1810</span> <span class="tlaGNC">     8838624 :          fieldid = subname//':eice'</span></span>
<span id="L1811"><span class="lineNum">    1811</span>              :          call column_conservation_check (fieldid,               &amp;</span>
<span id="L1812"><span class="lineNum">    1812</span>              :                                          eice_init, eice_final, &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1813"><span class="lineNum">    1813</span> <span class="tlaGNC">     8838624 :                                          puny*Lfresh*rhoi)</span></span>
<span id="L1814"><span class="lineNum">    1814</span> <span class="tlaGNC">     8838624 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1815"><span class="lineNum">    1815</span>              : </span>
<span id="L1816"><span class="lineNum">    1816</span>              :       endif ! conserv_check</span>
<span id="L1817"><span class="lineNum">    1817</span>              : </span>
<span id="L1818"><span class="lineNum">    1818</span>              :       !-----------------------------------------------------------------</span>
<span id="L1819"><span class="lineNum">    1819</span>              :       ! Biogeochemistry</span>
<span id="L1820"><span class="lineNum">    1820</span>              :       !-----------------------------------------------------------------</span>
<span id="L1821"><span class="lineNum">    1821</span> <span class="tlaGNC">  1207816920 :       if (tr_brine .or. nbtrcr &gt; 0) then</span></span>
<span id="L1822"><span class="lineNum">    1822</span>              :          call add_new_ice_bgc(dt,         ncats,                &amp;</span>
<span id="L1823"><span class="lineNum">    1823</span> <span class="tlaUNC tlaBgUNC">           0 :                               aicen_init, vicen_init, vi0_init, &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1824"><span class="lineNum">    1824</span> <span class="tlaUNC">           0 :                               aicen,      vicen,      vin0new,  &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1825"><span class="lineNum">    1825</span> <span class="tlaUNC">           0 :                               trcrn,                            &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1826"><span class="lineNum">    1826</span> <span class="tlaUNC">           0 :                               ocean_bio,  flux_bio,   hsurp,    &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1827"><span class="lineNum">    1827</span> <span class="tlaGNC tlaBgGNC">    66594192 :                               d_an_tot)</span></span>
<span id="L1828"><span class="lineNum">    1828</span> <span class="tlaGNC">    66594192 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L1829"><span class="lineNum">    1829</span>              :       endif</span>
<span id="L1830"><span class="lineNum">    1830</span>              : </span>
<span id="L1831"><span class="lineNum">    1831</span> <span class="tlaGNC">  1207816920 :       if (tr_fsd) then</span></span>
<span id="L1832"><span class="lineNum">    1832</span> <span class="tlaGNC">     5187888 :          deallocate(afsdn)</span></span>
<span id="L1833"><span class="lineNum">    1833</span>              :       endif</span>
<span id="L1834"><span class="lineNum">    1834</span>              : </span>
<span id="L1835"><span class="lineNum">    1835</span> <span class="tlaGNC">  1207816920 :       end subroutine add_new_ice</span></span>
<span id="L1836"><span class="lineNum">    1836</span>              : </span>
<span id="L1837"><span class="lineNum">    1837</span>              : !=======================================================================</span>
<span id="L1838"><span class="lineNum">    1838</span>              : !autodocument_start icepack_step_therm2</span>
<span id="L1839"><span class="lineNum">    1839</span>              : ! Driver for thermodynamic changes not needed for coupling:</span>
<span id="L1840"><span class="lineNum">    1840</span>              : ! transport in thickness space, lateral growth and melting.</span>
<span id="L1841"><span class="lineNum">    1841</span>              : !</span>
<span id="L1842"><span class="lineNum">    1842</span>              : ! authors: William H. Lipscomb, LANL</span>
<span id="L1843"><span class="lineNum">    1843</span>              : !          Elizabeth C. Hunke, LANL</span>
<span id="L1844"><span class="lineNum">    1844</span>              : </span>
<span id="L1845"><span class="lineNum">    1845</span> <span class="tlaGNC">  2415633840 :       subroutine icepack_step_therm2(dt,           hin_max,       &amp;</span></span>
<span id="L1846"><span class="lineNum">    1846</span> <span class="tlaUNC tlaBgUNC">           0 :                                      aicen,                       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1847"><span class="lineNum">    1847</span> <span class="tlaGNC tlaBgGNC">  1207816920 :                                      vicen,        vsnon,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1848"><span class="lineNum">    1848</span> <span class="tlaGNC">  1207816920 :                                      aicen_init,   vicen_init,    &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1849"><span class="lineNum">    1849</span> <span class="tlaGNC">  1207816920 :                                      trcrn,                       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1850"><span class="lineNum">    1850</span>              :                                      aice0,        aice,          &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1851"><span class="lineNum">    1851</span> <span class="tlaGNC">  1207816920 :                                      trcr_depend,                 &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1852"><span class="lineNum">    1852</span> <span class="tlaGNC">  1207816920 :                                      trcr_base,    n_trcr_strata, &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1853"><span class="lineNum">    1853</span> <span class="tlaGNC">  1207816920 :                                      nt_strata,                   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1854"><span class="lineNum">    1854</span>              :                                      Tf,           sss,           &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1855"><span class="lineNum">    1855</span> <span class="tlaGNC">  1207816920 :                                      salinz,                      &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1856"><span class="lineNum">    1856</span> <span class="tlaUNC tlaBgUNC">           0 :                                      rsiden,       meltl,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1857"><span class="lineNum">    1857</span>              :                                      wlat,                        &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1858"><span class="lineNum">    1858</span>              :                                      frzmlt,       frazil,        &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1859"><span class="lineNum">    1859</span>              :                                      frain,        fpond,         &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1860"><span class="lineNum">    1860</span>              :                                      fresh,        fsalt,         &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1861"><span class="lineNum">    1861</span>              :                                      fhocn,        update_ocn_f,  &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1862"><span class="lineNum">    1862</span> <span class="tlaGNC tlaBgGNC">  1207816920 :                                      faero_ocn,                   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1863"><span class="lineNum">    1863</span> <span class="tlaGNC">  1207816920 :                                      first_ice,    fzsal,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1864"><span class="lineNum">    1864</span> <span class="tlaGNC">  2415633840 :                                      flux_bio,     ocean_bio,     &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1865"><span class="lineNum">    1865</span>              :                                      frazil_diag,                 &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1866"><span class="lineNum">    1866</span>              :                                      frz_onset,    yday,          &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1867"><span class="lineNum">    1867</span> <span class="tlaGNC">  1207816920 :                                      fiso_ocn,     HDO_ocn,       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1868"><span class="lineNum">    1868</span>              :                                      H2_16O_ocn,   H2_18O_ocn,    &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1869"><span class="lineNum">    1869</span>              :                                      wave_sig_ht,                 &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1870"><span class="lineNum">    1870</span> <span class="tlaGNC">  1207816920 :                                      wave_spectrum,               &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1871"><span class="lineNum">    1871</span> <span class="tlaGNC">  1207816920 :                                      wavefreq,                    &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1872"><span class="lineNum">    1872</span> <span class="tlaGNC">  1207816920 :                                      dwavefreq,                   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1873"><span class="lineNum">    1873</span> <span class="tlaGNC">  1207816920 :                                      d_afsd_latg,  d_afsd_newi,   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L1874"><span class="lineNum">    1874</span> <span class="tlaGNC">  1207816920 :                                      d_afsd_latm,  d_afsd_weld)</span></span>
<span id="L1875"><span class="lineNum">    1875</span>              : </span>
<span id="L1876"><span class="lineNum">    1876</span>              :       use icepack_parameters, only: icepack_init_parameters</span>
<span id="L1877"><span class="lineNum">    1877</span>              : </span>
<span id="L1878"><span class="lineNum">    1878</span>              :       logical (kind=log_kind), intent(in), optional :: &amp;</span>
<span id="L1879"><span class="lineNum">    1879</span>              :          update_ocn_f ! if true, update fresh water and salt fluxes</span>
<span id="L1880"><span class="lineNum">    1880</span>              : </span>
<span id="L1881"><span class="lineNum">    1881</span>              :       real (kind=dbl_kind), dimension(0:ncat), intent(in) :: &amp;</span>
<span id="L1882"><span class="lineNum">    1882</span>              :          hin_max      ! category boundaries (m)</span>
<span id="L1883"><span class="lineNum">    1883</span>              : </span>
<span id="L1884"><span class="lineNum">    1884</span>              :       real (kind=dbl_kind), intent(in) :: &amp;</span>
<span id="L1885"><span class="lineNum">    1885</span>              :          dt       , &amp; ! time step   ! LCOV_EXCL_LINE</span>
<span id="L1886"><span class="lineNum">    1886</span>              :          Tf       , &amp; ! freezing temperature (C)   ! LCOV_EXCL_LINE</span>
<span id="L1887"><span class="lineNum">    1887</span>              :          sss      , &amp; ! sea surface salinity (ppt)   ! LCOV_EXCL_LINE</span>
<span id="L1888"><span class="lineNum">    1888</span>              :          frzmlt       ! freezing/melting potential (W/m^2)</span>
<span id="L1889"><span class="lineNum">    1889</span>              : </span>
<span id="L1890"><span class="lineNum">    1890</span>              :       integer (kind=int_kind), dimension (:), intent(in) :: &amp;</span>
<span id="L1891"><span class="lineNum">    1891</span>              :          trcr_depend, &amp; ! = 0 for aicen tracers, 1 for vicen, 2 for vsnon   ! LCOV_EXCL_LINE</span>
<span id="L1892"><span class="lineNum">    1892</span>              :          n_trcr_strata  ! number of underlying tracer layers</span>
<span id="L1893"><span class="lineNum">    1893</span>              : </span>
<span id="L1894"><span class="lineNum">    1894</span>              :       real (kind=dbl_kind), dimension (:,:), intent(in) :: &amp;</span>
<span id="L1895"><span class="lineNum">    1895</span>              :          trcr_base    ! = 0 or 1 depending on tracer dependency</span>
<span id="L1896"><span class="lineNum">    1896</span>              :                       ! argument 2:  (1) aice, (2) vice, (3) vsno</span>
<span id="L1897"><span class="lineNum">    1897</span>              : </span>
<span id="L1898"><span class="lineNum">    1898</span>              :       integer (kind=int_kind), dimension (:,:), intent(in) :: &amp;</span>
<span id="L1899"><span class="lineNum">    1899</span>              :          nt_strata    ! indices of underlying tracer layers</span>
<span id="L1900"><span class="lineNum">    1900</span>              : </span>
<span id="L1901"><span class="lineNum">    1901</span>              :       real (kind=dbl_kind), dimension(:), intent(in) :: &amp;</span>
<span id="L1902"><span class="lineNum">    1902</span>              :          rsiden   , &amp; ! fraction of ice that melts laterally   ! LCOV_EXCL_LINE</span>
<span id="L1903"><span class="lineNum">    1903</span>              :          salinz   , &amp; ! initial salinity profile   ! LCOV_EXCL_LINE</span>
<span id="L1904"><span class="lineNum">    1904</span>              :          ocean_bio    ! ocean concentration of biological tracer</span>
<span id="L1905"><span class="lineNum">    1905</span>              : </span>
<span id="L1906"><span class="lineNum">    1906</span>              :       real (kind=dbl_kind), intent(inout) :: &amp;</span>
<span id="L1907"><span class="lineNum">    1907</span>              :          aice     , &amp; ! sea ice concentration   ! LCOV_EXCL_LINE</span>
<span id="L1908"><span class="lineNum">    1908</span>              :          aice0    , &amp; ! concentration of open water   ! LCOV_EXCL_LINE</span>
<span id="L1909"><span class="lineNum">    1909</span>              :          frain    , &amp; ! rainfall rate (kg/m^2 s)   ! LCOV_EXCL_LINE</span>
<span id="L1910"><span class="lineNum">    1910</span>              :          fpond    , &amp; ! fresh water flux to ponds (kg/m^2/s)   ! LCOV_EXCL_LINE</span>
<span id="L1911"><span class="lineNum">    1911</span>              :          fresh    , &amp; ! fresh water flux to ocean (kg/m^2/s)   ! LCOV_EXCL_LINE</span>
<span id="L1912"><span class="lineNum">    1912</span>              :          fsalt    , &amp; ! salt flux to ocean (kg/m^2/s)   ! LCOV_EXCL_LINE</span>
<span id="L1913"><span class="lineNum">    1913</span>              :          fhocn    , &amp; ! net heat flux to ocean (W/m^2)   ! LCOV_EXCL_LINE</span>
<span id="L1914"><span class="lineNum">    1914</span>              :          meltl    , &amp; ! lateral ice melt         (m/step--&gt;cm/day)   ! LCOV_EXCL_LINE</span>
<span id="L1915"><span class="lineNum">    1915</span>              :          frazil   , &amp; ! frazil ice growth        (m/step--&gt;cm/day)   ! LCOV_EXCL_LINE</span>
<span id="L1916"><span class="lineNum">    1916</span>              :          frazil_diag  ! frazil ice growth diagnostic (m/step--&gt;cm/day)</span>
<span id="L1917"><span class="lineNum">    1917</span>              : </span>
<span id="L1918"><span class="lineNum">    1918</span>              :       real (kind=dbl_kind), intent(inout), optional :: &amp;</span>
<span id="L1919"><span class="lineNum">    1919</span>              :          fzsal        ! salt flux to ocean from zsalinity (kg/m^2/s) (deprecated)</span>
<span id="L1920"><span class="lineNum">    1920</span>              : </span>
<span id="L1921"><span class="lineNum">    1921</span>              :       real (kind=dbl_kind), intent(in), optional :: &amp;</span>
<span id="L1922"><span class="lineNum">    1922</span>              :          wlat         ! lateral melt rate (m/s)</span>
<span id="L1923"><span class="lineNum">    1923</span>              : </span>
<span id="L1924"><span class="lineNum">    1924</span>              :       real (kind=dbl_kind), dimension(:), intent(inout) :: &amp;</span>
<span id="L1925"><span class="lineNum">    1925</span>              :          aicen_init,&amp; ! initial concentration of ice   ! LCOV_EXCL_LINE</span>
<span id="L1926"><span class="lineNum">    1926</span>              :          vicen_init,&amp; ! initial volume per unit area of ice          (m)   ! LCOV_EXCL_LINE</span>
<span id="L1927"><span class="lineNum">    1927</span>              :          aicen    , &amp; ! concentration of ice   ! LCOV_EXCL_LINE</span>
<span id="L1928"><span class="lineNum">    1928</span>              :          vicen    , &amp; ! volume per unit area of ice          (m)   ! LCOV_EXCL_LINE</span>
<span id="L1929"><span class="lineNum">    1929</span>              :          vsnon    , &amp; ! volume per unit area of snow         (m)   ! LCOV_EXCL_LINE</span>
<span id="L1930"><span class="lineNum">    1930</span>              :          faero_ocn, &amp; ! aerosol flux to ocean  (kg/m^2/s)   ! LCOV_EXCL_LINE</span>
<span id="L1931"><span class="lineNum">    1931</span>              :          flux_bio     ! all bio fluxes to ocean</span>
<span id="L1932"><span class="lineNum">    1932</span>              : </span>
<span id="L1933"><span class="lineNum">    1933</span>              :       real (kind=dbl_kind), dimension(:,:), intent(inout) :: &amp;</span>
<span id="L1934"><span class="lineNum">    1934</span>              :          trcrn        ! tracers</span>
<span id="L1935"><span class="lineNum">    1935</span>              : </span>
<span id="L1936"><span class="lineNum">    1936</span>              :       logical (kind=log_kind), dimension(:), intent(inout) :: &amp;</span>
<span id="L1937"><span class="lineNum">    1937</span>              :          first_ice    ! true until ice forms</span>
<span id="L1938"><span class="lineNum">    1938</span>              : </span>
<span id="L1939"><span class="lineNum">    1939</span>              :       real (kind=dbl_kind), intent(inout), optional :: &amp;</span>
<span id="L1940"><span class="lineNum">    1940</span>              :          frz_onset    ! day of year that freezing begins (congel or frazil)</span>
<span id="L1941"><span class="lineNum">    1941</span>              : </span>
<span id="L1942"><span class="lineNum">    1942</span>              :       real (kind=dbl_kind), intent(in), optional :: &amp;</span>
<span id="L1943"><span class="lineNum">    1943</span>              :          yday         ! day of year</span>
<span id="L1944"><span class="lineNum">    1944</span>              : </span>
<span id="L1945"><span class="lineNum">    1945</span>              :       ! water isotopes</span>
<span id="L1946"><span class="lineNum">    1946</span>              :       real (kind=dbl_kind), dimension(:), intent(inout), optional :: &amp;</span>
<span id="L1947"><span class="lineNum">    1947</span>              :          fiso_ocn     ! isotope flux to ocean  (kg/m^2/s)</span>
<span id="L1948"><span class="lineNum">    1948</span>              : </span>
<span id="L1949"><span class="lineNum">    1949</span>              :       real (kind=dbl_kind), intent(in), optional :: &amp;</span>
<span id="L1950"><span class="lineNum">    1950</span>              :          HDO_ocn    , &amp; ! ocean concentration of HDO (kg/kg)   ! LCOV_EXCL_LINE</span>
<span id="L1951"><span class="lineNum">    1951</span>              :          H2_16O_ocn , &amp; ! ocean concentration of H2_16O (kg/kg)   ! LCOV_EXCL_LINE</span>
<span id="L1952"><span class="lineNum">    1952</span>              :          H2_18O_ocn     ! ocean concentration of H2_18O (kg/kg)</span>
<span id="L1953"><span class="lineNum">    1953</span>              : </span>
<span id="L1954"><span class="lineNum">    1954</span>              :       real (kind=dbl_kind), intent(in), optional :: &amp;</span>
<span id="L1955"><span class="lineNum">    1955</span>              :          wave_sig_ht    ! significant height of waves in ice (m)</span>
<span id="L1956"><span class="lineNum">    1956</span>              : </span>
<span id="L1957"><span class="lineNum">    1957</span>              :       real (kind=dbl_kind), dimension(:), intent(in), optional  :: &amp;</span>
<span id="L1958"><span class="lineNum">    1958</span>              :          wave_spectrum  ! ocean surface wave spectrum E(f) (m^2 s)</span>
<span id="L1959"><span class="lineNum">    1959</span>              : </span>
<span id="L1960"><span class="lineNum">    1960</span>              :       real(kind=dbl_kind), dimension(:), intent(in), optional :: &amp;</span>
<span id="L1961"><span class="lineNum">    1961</span>              :          wavefreq, &amp;    ! wave frequencies (s^-1)   ! LCOV_EXCL_LINE</span>
<span id="L1962"><span class="lineNum">    1962</span>              :          dwavefreq      ! wave frequency bin widths (s^-1)</span>
<span id="L1963"><span class="lineNum">    1963</span>              : </span>
<span id="L1964"><span class="lineNum">    1964</span>              :       real (kind=dbl_kind), dimension(:), intent(out), optional :: &amp;</span>
<span id="L1965"><span class="lineNum">    1965</span>              :                         ! change in floe size distribution (area)</span>
<span id="L1966"><span class="lineNum">    1966</span>              :          d_afsd_latg, &amp; ! due to fsd lateral growth</span>
<span id="L1967"><span class="lineNum">    1967</span>              :          d_afsd_newi, &amp; ! new ice formation   ! LCOV_EXCL_LINE</span>
<span id="L1968"><span class="lineNum">    1968</span>              :          d_afsd_latm, &amp; ! lateral melt   ! LCOV_EXCL_LINE</span>
<span id="L1969"><span class="lineNum">    1969</span>              :          d_afsd_weld    ! welding</span>
<span id="L1970"><span class="lineNum">    1970</span>              : </span>
<span id="L1971"><span class="lineNum">    1971</span>              : !autodocument_end</span>
<span id="L1972"><span class="lineNum">    1972</span>              : </span>
<span id="L1973"><span class="lineNum">    1973</span>              :       ! local variables</span>
<span id="L1974"><span class="lineNum">    1974</span>              : </span>
<span id="L1975"><span class="lineNum">    1975</span>              :       logical (kind=log_kind), save :: &amp;</span>
<span id="L1976"><span class="lineNum">    1976</span>              :          first_call = .true.   ! first call flag</span>
<span id="L1977"><span class="lineNum">    1977</span>              : </span>
<span id="L1978"><span class="lineNum">    1978</span>              :       character(len=*),parameter :: subname='(icepack_step_therm2)'</span>
<span id="L1979"><span class="lineNum">    1979</span>              : </span>
<span id="L1980"><span class="lineNum">    1980</span>              :       !-----------------------------------------------------------------</span>
<span id="L1981"><span class="lineNum">    1981</span>              :       ! Check optional arguments and set local values</span>
<span id="L1982"><span class="lineNum">    1982</span>              :       !-----------------------------------------------------------------</span>
<span id="L1983"><span class="lineNum">    1983</span>              : </span>
<span id="L1984"><span class="lineNum">    1984</span> <span class="tlaGNC">  1207816920 :        if (present(update_ocn_f)) then</span></span>
<span id="L1985"><span class="lineNum">    1985</span> <span class="tlaUNC tlaBgUNC">           0 :           call icepack_init_parameters(update_ocn_f_in=update_ocn_f)</span></span>
<span id="L1986"><span class="lineNum">    1986</span>              :        endif</span>
<span id="L1987"><span class="lineNum">    1987</span> <span class="tlaGNC tlaBgGNC">  1207816920 :        if (icepack_chkoptargflag(first_call)) then</span></span>
<span id="L1988"><span class="lineNum">    1988</span> <span class="tlaGNC">        2277 :           if (tr_iso) then</span></span>
<span id="L1989"><span class="lineNum">    1989</span> <span class="tlaGNC">          21 :              if (.not.(present(fiso_ocn)   .and. &amp;</span></span>
<span id="L1990"><span class="lineNum">    1990</span>              :                        present(HDO_ocn)    .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1991"><span class="lineNum">    1991</span>              :                        present(H2_16O_ocn) .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L1992"><span class="lineNum">    1992</span>              :                        present(H2_18O_ocn))) then</span>
<span id="L1993"><span class="lineNum">    1993</span> <span class="tlaUNC tlaBgUNC">           0 :                 call icepack_warnings_add(subname//' error in iso arguments, tr_iso=T')</span></span>
<span id="L1994"><span class="lineNum">    1994</span> <span class="tlaUNC">           0 :                 call icepack_warnings_setabort(.true.,__FILE__,__LINE__)</span></span>
<span id="L1995"><span class="lineNum">    1995</span> <span class="tlaUNC">           0 :                 return</span></span>
<span id="L1996"><span class="lineNum">    1996</span>              :              endif</span>
<span id="L1997"><span class="lineNum">    1997</span>              :           endif</span>
<span id="L1998"><span class="lineNum">    1998</span> <span class="tlaGNC tlaBgGNC">        2277 :           if (tr_fsd) then</span></span>
<span id="L1999"><span class="lineNum">    1999</span> <span class="tlaGNC">          42 :              if (.not.(present(wlat)          .and. &amp;</span></span>
<span id="L2000"><span class="lineNum">    2000</span>              :                        present(wave_sig_ht)   .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2001"><span class="lineNum">    2001</span>              :                        present(wave_spectrum) .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2002"><span class="lineNum">    2002</span>              :                        present(wavefreq)      .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2003"><span class="lineNum">    2003</span>              :                        present(dwavefreq)     .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2004"><span class="lineNum">    2004</span>              :                        present(d_afsd_latg)   .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2005"><span class="lineNum">    2005</span>              :                        present(d_afsd_newi)   .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2006"><span class="lineNum">    2006</span>              :                        present(d_afsd_latm)   .and. &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2007"><span class="lineNum">    2007</span>              :                        present(d_afsd_weld))) then</span>
<span id="L2008"><span class="lineNum">    2008</span> <span class="tlaUNC tlaBgUNC">           0 :                 call icepack_warnings_add(subname//' error in FSD arguments, tr_fsd=T')</span></span>
<span id="L2009"><span class="lineNum">    2009</span> <span class="tlaUNC">           0 :                 call icepack_warnings_setabort(.true.,__FILE__,__LINE__)</span></span>
<span id="L2010"><span class="lineNum">    2010</span> <span class="tlaUNC">           0 :                 return</span></span>
<span id="L2011"><span class="lineNum">    2011</span>              :              endif</span>
<span id="L2012"><span class="lineNum">    2012</span>              :           endif</span>
<span id="L2013"><span class="lineNum">    2013</span>              :       endif</span>
<span id="L2014"><span class="lineNum">    2014</span>              : </span>
<span id="L2015"><span class="lineNum">    2015</span>              :       !-----------------------------------------------------------------</span>
<span id="L2016"><span class="lineNum">    2016</span>              :       ! Let rain drain through to the ocean.</span>
<span id="L2017"><span class="lineNum">    2017</span>              :       !-----------------------------------------------------------------</span>
<span id="L2018"><span class="lineNum">    2018</span>              : </span>
<span id="L2019"><span class="lineNum">    2019</span> <span class="tlaGNC tlaBgGNC">  1207816920 :       fresh  = fresh + frain * aice</span></span>
<span id="L2020"><span class="lineNum">    2020</span>              : </span>
<span id="L2021"><span class="lineNum">    2021</span>              :       !-----------------------------------------------------------------</span>
<span id="L2022"><span class="lineNum">    2022</span>              :       ! Given thermodynamic growth rates, transport ice between</span>
<span id="L2023"><span class="lineNum">    2023</span>              :       ! thickness categories.</span>
<span id="L2024"><span class="lineNum">    2024</span>              :       !-----------------------------------------------------------------</span>
<span id="L2025"><span class="lineNum">    2025</span>              : </span>
<span id="L2026"><span class="lineNum">    2026</span>              : !      call ice_timer_start(timer_catconv)    ! category conversions</span>
<span id="L2027"><span class="lineNum">    2027</span>              : </span>
<span id="L2028"><span class="lineNum">    2028</span>              :       !-----------------------------------------------------------------</span>
<span id="L2029"><span class="lineNum">    2029</span>              :       ! Compute fractional ice area in each grid cell.</span>
<span id="L2030"><span class="lineNum">    2030</span>              :       !-----------------------------------------------------------------</span>
<span id="L2031"><span class="lineNum">    2031</span>              : </span>
<span id="L2032"><span class="lineNum">    2032</span> <span class="tlaGNC">  1865688792 :       flux_bio(:) = c0</span></span>
<span id="L2033"><span class="lineNum">    2033</span>              : </span>
<span id="L2034"><span class="lineNum">    2034</span> <span class="tlaGNC">  1207816920 :       call aggregate_area (aicen, aice, aice0)</span></span>
<span id="L2035"><span class="lineNum">    2035</span> <span class="tlaGNC">  1207816920 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L2036"><span class="lineNum">    2036</span>              : </span>
<span id="L2037"><span class="lineNum">    2037</span> <span class="tlaGNC">  1207816920 :       if (kitd == 1) then</span></span>
<span id="L2038"><span class="lineNum">    2038</span>              : </span>
<span id="L2039"><span class="lineNum">    2039</span>              :       !-----------------------------------------------------------------</span>
<span id="L2040"><span class="lineNum">    2040</span>              :       ! Identify grid cells with ice.</span>
<span id="L2041"><span class="lineNum">    2041</span>              :       !-----------------------------------------------------------------</span>
<span id="L2042"><span class="lineNum">    2042</span>              : </span>
<span id="L2043"><span class="lineNum">    2043</span> <span class="tlaGNC">  1180446648 :          if (aice &gt; puny) then</span></span>
<span id="L2044"><span class="lineNum">    2044</span>              : </span>
<span id="L2045"><span class="lineNum">    2045</span>              :             call linear_itd (hin_max,        &amp;</span>
<span id="L2046"><span class="lineNum">    2046</span> <span class="tlaUNC tlaBgUNC">           0 :                              trcr_depend,    &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2047"><span class="lineNum">    2047</span> <span class="tlaUNC">           0 :                              trcr_base,        &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2048"><span class="lineNum">    2048</span> <span class="tlaUNC">           0 :                              n_trcr_strata,   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2049"><span class="lineNum">    2049</span> <span class="tlaUNC">           0 :                              nt_strata,                &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2050"><span class="lineNum">    2050</span> <span class="tlaUNC">           0 :                              aicen_init,            &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2051"><span class="lineNum">    2051</span> <span class="tlaUNC">           0 :                              vicen_init,            &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2052"><span class="lineNum">    2052</span> <span class="tlaUNC">           0 :                              aicen,                 &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2053"><span class="lineNum">    2053</span> <span class="tlaUNC">           0 :                              trcrn,           &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2054"><span class="lineNum">    2054</span> <span class="tlaUNC">           0 :                              vicen,                 &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2055"><span class="lineNum">    2055</span> <span class="tlaUNC">           0 :                              vsnon,                 &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2056"><span class="lineNum">    2056</span>              :                              aice      ,         &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2057"><span class="lineNum">    2057</span>              :                              aice0     ,         &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2058"><span class="lineNum">    2058</span> <span class="tlaGNC tlaBgGNC">   254098382 :                              fpond, Tf       )</span></span>
<span id="L2059"><span class="lineNum">    2059</span> <span class="tlaGNC">   254098382 :             if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L2060"><span class="lineNum">    2060</span>              : </span>
<span id="L2061"><span class="lineNum">    2061</span>              :          endif ! aice &gt; puny</span>
<span id="L2062"><span class="lineNum">    2062</span>              : </span>
<span id="L2063"><span class="lineNum">    2063</span>              :       endif  ! kitd = 1</span>
<span id="L2064"><span class="lineNum">    2064</span>              : </span>
<span id="L2065"><span class="lineNum">    2065</span>              : !      call ice_timer_stop(timer_catconv)    ! category conversions</span>
<span id="L2066"><span class="lineNum">    2066</span>              : </span>
<span id="L2067"><span class="lineNum">    2067</span>              :       !-----------------------------------------------------------------</span>
<span id="L2068"><span class="lineNum">    2068</span>              :       ! Add frazil ice growing in leads.</span>
<span id="L2069"><span class="lineNum">    2069</span>              :       !-----------------------------------------------------------------</span>
<span id="L2070"><span class="lineNum">    2070</span>              : </span>
<span id="L2071"><span class="lineNum">    2071</span>              :       ! identify ice-ocean cells</span>
<span id="L2072"><span class="lineNum">    2072</span>              : </span>
<span id="L2073"><span class="lineNum">    2073</span>              :          call add_new_ice (dt,                          &amp;</span>
<span id="L2074"><span class="lineNum">    2074</span>              :                            hin_max,       ktherm,       &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2075"><span class="lineNum">    2075</span> <span class="tlaUNC tlaBgUNC">           0 :                            aicen,         trcrn,        &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2076"><span class="lineNum">    2076</span> <span class="tlaUNC">           0 :                            vicen,                       &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2077"><span class="lineNum">    2077</span>              :                            aice0,         aice,         &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2078"><span class="lineNum">    2078</span>              :                            frzmlt,        frazil,       &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2079"><span class="lineNum">    2079</span>              :                            frz_onset,     yday,         &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2080"><span class="lineNum">    2080</span>              :                            fresh,         fsalt,        &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2081"><span class="lineNum">    2081</span>              :                            Tf,            sss,          &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2082"><span class="lineNum">    2082</span> <span class="tlaUNC">           0 :                            salinz,        phi_init,     &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2083"><span class="lineNum">    2083</span>              :                            dSin0_frazil,                &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2084"><span class="lineNum">    2084</span> <span class="tlaUNC">           0 :                            flux_bio,                    &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2085"><span class="lineNum">    2085</span> <span class="tlaUNC">           0 :                            ocean_bio,                   &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2086"><span class="lineNum">    2086</span> <span class="tlaUNC">           0 :                            frazil_diag,   fiso_ocn,     &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2087"><span class="lineNum">    2087</span>              :                            HDO_ocn,       H2_16O_ocn,   &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2088"><span class="lineNum">    2088</span>              :                            H2_18O_ocn,                  &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2089"><span class="lineNum">    2089</span>              :                            wave_sig_ht,                 &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2090"><span class="lineNum">    2090</span> <span class="tlaUNC">           0 :                            wave_spectrum,               &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2091"><span class="lineNum">    2091</span> <span class="tlaUNC">           0 :                            wavefreq,      dwavefreq,    &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2092"><span class="lineNum">    2092</span> <span class="tlaGNC tlaBgGNC">  1207816920 :                            d_afsd_latg,   d_afsd_newi)</span></span>
<span id="L2093"><span class="lineNum">    2093</span>              : </span>
<span id="L2094"><span class="lineNum">    2094</span> <span class="tlaGNC">  1207816920 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L2095"><span class="lineNum">    2095</span>              : </span>
<span id="L2096"><span class="lineNum">    2096</span>              :       !-----------------------------------------------------------------</span>
<span id="L2097"><span class="lineNum">    2097</span>              :       ! Melt ice laterally.</span>
<span id="L2098"><span class="lineNum">    2098</span>              :       !-----------------------------------------------------------------</span>
<span id="L2099"><span class="lineNum">    2099</span>              : </span>
<span id="L2100"><span class="lineNum">    2100</span>              :       call lateral_melt (dt,        fpond,         &amp;</span>
<span id="L2101"><span class="lineNum">    2101</span>              :                          fresh,     fsalt,         &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2102"><span class="lineNum">    2102</span> <span class="tlaUNC tlaBgUNC">           0 :                          fhocn,     faero_ocn,     &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2103"><span class="lineNum">    2103</span> <span class="tlaUNC">           0 :                          fiso_ocn,                 &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2104"><span class="lineNum">    2104</span> <span class="tlaUNC">           0 :                          rsiden,    meltl,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2105"><span class="lineNum">    2105</span>              :                          wlat,                     &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2106"><span class="lineNum">    2106</span> <span class="tlaUNC">           0 :                          aicen,     vicen,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2107"><span class="lineNum">    2107</span> <span class="tlaUNC">           0 :                          vsnon,     trcrn,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2108"><span class="lineNum">    2108</span> <span class="tlaUNC">           0 :                          flux_bio,                 &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2109"><span class="lineNum">    2109</span> <span class="tlaGNC tlaBgGNC">  1207816920 :                          d_afsd_latm)</span></span>
<span id="L2110"><span class="lineNum">    2110</span> <span class="tlaGNC">  1207816920 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L2111"><span class="lineNum">    2111</span>              : </span>
<span id="L2112"><span class="lineNum">    2112</span>              :       ! Floe welding during freezing conditions</span>
<span id="L2113"><span class="lineNum">    2113</span> <span class="tlaGNC">  1207816920 :       if (tr_fsd) then</span></span>
<span id="L2114"><span class="lineNum">    2114</span>              :          call fsd_weld_thermo (dt,    frzmlt, &amp;</span>
<span id="L2115"><span class="lineNum">    2115</span> <span class="tlaUNC tlaBgUNC">           0 :                                aicen, trcrn,  &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2116"><span class="lineNum">    2116</span> <span class="tlaGNC tlaBgGNC">     5187888 :                                d_afsd_weld)</span></span>
<span id="L2117"><span class="lineNum">    2117</span> <span class="tlaGNC">     5187888 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L2118"><span class="lineNum">    2118</span>              :       endif</span>
<span id="L2119"><span class="lineNum">    2119</span>              : </span>
<span id="L2120"><span class="lineNum">    2120</span>              :       !-----------------------------------------------------------------</span>
<span id="L2121"><span class="lineNum">    2121</span>              :       ! For the special case of a single category, adjust the area and</span>
<span id="L2122"><span class="lineNum">    2122</span>              :       ! volume (assuming that half the volume change decreases the</span>
<span id="L2123"><span class="lineNum">    2123</span>              :       ! thickness, and the other half decreases the area).</span>
<span id="L2124"><span class="lineNum">    2124</span>              :       !-----------------------------------------------------------------</span>
<span id="L2125"><span class="lineNum">    2125</span>              : </span>
<span id="L2126"><span class="lineNum">    2126</span> <span class="tlaGNC">  1207816920 :       if (ncat==1) &amp;</span></span>
<span id="L2127"><span class="lineNum">    2127</span> <span class="tlaGNC">     2882160 :          call reduce_area (hin_max   (0),                &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2128"><span class="lineNum">    2128</span> <span class="tlaGNC">     2882160 :                            aicen     (1), vicen     (1), &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2129"><span class="lineNum">    2129</span> <span class="tlaGNC">     5764320 :                            aicen_init(1), vicen_init(1))</span></span>
<span id="L2130"><span class="lineNum">    2130</span> <span class="tlaGNC">  1207816920 :          if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L2131"><span class="lineNum">    2131</span>              : </span>
<span id="L2132"><span class="lineNum">    2132</span>              :       !-----------------------------------------------------------------</span>
<span id="L2133"><span class="lineNum">    2133</span>              :       ! ITD cleanup: Rebin thickness categories if necessary, and remove</span>
<span id="L2134"><span class="lineNum">    2134</span>              :       !  categories with very small areas.</span>
<span id="L2135"><span class="lineNum">    2135</span>              :       !-----------------------------------------------------------------</span>
<span id="L2136"><span class="lineNum">    2136</span>              : </span>
<span id="L2137"><span class="lineNum">    2137</span>              :       call cleanup_itd (dt,                   hin_max,          &amp;</span>
<span id="L2138"><span class="lineNum">    2138</span> <span class="tlaUNC tlaBgUNC">           0 :                         aicen,                trcrn(1:ntrcr,:), &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2139"><span class="lineNum">    2139</span> <span class="tlaUNC">           0 :                         vicen,                vsnon,            &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2140"><span class="lineNum">    2140</span>              :                         aice0,                aice,             &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2141"><span class="lineNum">    2141</span>              :                         tr_aero,                                &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2142"><span class="lineNum">    2142</span>              :                         tr_pond_topo,                           &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2143"><span class="lineNum">    2143</span> <span class="tlaUNC">           0 :                         first_ice,                              &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2144"><span class="lineNum">    2144</span> <span class="tlaUNC">           0 :                         trcr_depend,          trcr_base,        &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2145"><span class="lineNum">    2145</span> <span class="tlaUNC">           0 :                         n_trcr_strata,        nt_strata,        &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2146"><span class="lineNum">    2146</span>              :                         fpond,                fresh,            &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2147"><span class="lineNum">    2147</span>              :                         fsalt,                fhocn,            &amp;   ! LCOV_EXCL_LINE</span>
<span id="L2148"><span class="lineNum">    2148</span> <span class="tlaUNC">           0 :                         faero_ocn,            fiso_ocn,         &amp;   ! LCOV_EXCL_LINE</span></span>
<span id="L2149"><span class="lineNum">    2149</span> <span class="tlaGNC tlaBgGNC">  1207816920 :                         flux_bio,             Tf                )</span></span>
<span id="L2150"><span class="lineNum">    2150</span> <span class="tlaGNC">  1207816920 :       if (icepack_warnings_aborted(subname)) return</span></span>
<span id="L2151"><span class="lineNum">    2151</span>              : </span>
<span id="L2152"><span class="lineNum">    2152</span> <span class="tlaGNC">  1207816920 :       first_call = .false.</span></span>
<span id="L2153"><span class="lineNum">    2153</span>              : </span>
<span id="L2154"><span class="lineNum">    2154</span>              :       end subroutine icepack_step_therm2</span>
<span id="L2155"><span class="lineNum">    2155</span>              : </span>
<span id="L2156"><span class="lineNum">    2156</span>              : !=======================================================================</span>
<span id="L2157"><span class="lineNum">    2157</span>              : </span>
<span id="L2158"><span class="lineNum">    2158</span>              :       end module icepack_therm_itd</span>
<span id="L2159"><span class="lineNum">    2159</span>              : </span>
<span id="L2160"><span class="lineNum">    2160</span>              : !=======================================================================</span>
        </pre>
              </td>
            </tr>
          </table>
          <br>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
            <tr><td class="versionInfo">Generated by: <a href="https://github.com//linux-test-project/lcov" target="_parent">LCOV version 2.0-1</a></td></tr>
          </table>
          <br>

</body>
</html>
